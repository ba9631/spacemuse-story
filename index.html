<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Muse</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- three.js CDN for 3D rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- cannon.js CDN (still included but not heavily used for orbital physics here) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <style>
        /* Custom styles for the body and canvas */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0a09; /* Even darker, almost black background */
            color: #d1d5db; /* Lighter gray text for better contrast */
        }
        /* Focus styles for the search input */
        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* Blue ring focus */
            border-color: #3b82f6; /* Blue border on focus */
        }
        /* Styling for the 3D canvas (shared styles) */
        .threejs-canvas {
            display: block;
            width: 100%;
            height: 600px; /* Fixed height for the canvas, can be adjusted or made responsive with JS */
            background-color: #000000; /* Black background for space */
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15); /* Darker shadow */
        }
        /* Styling for the loading indicator */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            border-radius: 1rem;
            z-index: 10;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Calendar specific styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem; /* Gap between days */
        }
        .calendar-day {
            padding: 1rem;
            min-height: 80px; /* Ensure a minimum height for each day cell */
            background-color: rgba(30, 41, 59, 0.5); /* slate-800 with transparency */
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border: 1px solid transparent;
            position: relative;
        }
        .calendar-day:hover {
            background-color: rgba(51, 65, 85, 0.7); /* slate-700 with transparency */
            border-color: #60a5fa; /* Blue border on hover */
        }
        .calendar-day.current-month {
            color: #d1d5db; /* Light gray for current month days */
        }
        .calendar-day.other-month {
            color: #6b7280; /* Darker gray for other month days */
        }
        .calendar-day.has-event {
            border-color: #34d399; /* Green border for days with events */
            background-color: rgba(16, 185, 129, 0.2); /* green-500 with transparency */
        }
        .calendar-day-number {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            margin-bottom: 0.5rem;
        }
        .calendar-event-title {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #a7f3d0; /* green-200 */
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }
        .moon-phase-icon {
            font-size: 1.5rem; /* Make moon icons visible */
            margin-top: 0.5rem;
            align-self: flex-end; /* Push to bottom right */
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
        }

        /* Modal (Pop-up) styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* High z-index to be on top */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1f2937; /* Darker gray background for modal */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 90%;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close-btn:hover {
            color: #e5e7eb;
        }

        /* Main content sections - initially hidden */
        .content-section {
            display: none;
            width: 100%; /* Ensure sections take full width when visible */
        }
        .content-section.active {
            display: block;
        }

        /* Info Pop-ups (shared styles) */
        .info-popup {
            position: absolute;
            background-color: rgba(30, 41, 59, 0.9); /* slate-800 with transparency */
            border: 1px solid #60a5fa; /* Blue border */
            border-radius: 0.75rem;
            padding: 1rem;
            max-width: 250px;
            pointer-events: none; /* Allows clicks to pass through to canvas if not on pop-up itself */
            opacity: 0;
            visibility: hidden;
            transform: translate(-50%, -100%); /* Center horizontally, push up vertically */
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out, transform 0.2s ease-in-out;
            z-index: 50; /* Above canvas, below main modal */
        }
        .info-popup.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -110%); /* Adjust slightly for hover effect */
        }
        .info-popup h4 {
            font-size: 1.25rem; /* text-xl */
            font-weight: bold;
            color: #fff;
            margin-bottom: 0.5rem;
        }
        .info-popup p {
            font-size: 0.875rem; /* text-sm */
            color: #cbd5e1; /* slate-300 */
        }
        .info-popup .category-title {
            font-weight: bold;
            color: #93c5fd; /* light blue */
            margin-top: 0.5rem;
            margin-bottom: 0.2rem;
        }

        /* Glossary specific styles */
        .glossary-term {
            margin-bottom: 1.5rem;
        }
        .glossary-term h3 {
            font-size: 1.75rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            color: #67e8f9; /* cyan-300 */
            margin-bottom: 0.5rem;
        }
        .glossary-term p {
            font-size: 1rem; /* text-base */
            color: #a78bfa; /* violet-400 */
            line-height: 1.6;
        }

        /* Timeline Specific Styles */
        .timeline-container {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px 0;
        }

        .timeline-container::after {
            content: '';
            position: absolute;
            width: 6px;
            background-color: #60a5fa; /* Blue line */
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -3px;
        }

        .timeline-event {
            padding: 10px 40px;
            position: relative;
            background-color: inherit;
            width: 50%;
        }

        .timeline-event::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 25px;
            right: -17px;
            background-color: #1f2937; /* Darker gray background for circle */
            border: 4px solid #34d399; /* Green circle border */
            top: 15px;
            border-radius: 50%;
            z-index: 1;
        }

        .timeline-event.left {
            left: 0;
        }

        .timeline-event.right {
            left: 50%;
        }

        .timeline-event.left::before {
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            top: 22px;
            z-index: 1;
            right: 30px;
            border: medium solid white;
            border-width: 10px 0 10px 10px;
            border-color: transparent transparent transparent #1f2937;
        }

        .timeline-event.right::before {
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            top: 22px;
            z-index: 1;
            left: 30px;
            border: medium solid white;
            border-width: 10px 10px 10px 0;
            border-color: transparent #1f2937 transparent transparent;
        }

        .timeline-event.right::after {
            left: -16px;
        }

        .timeline-content {
            padding: 20px 30px;
            background-color: #1f2937; /* Darker gray background */
            position: relative;
            border-radius: 6px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .timeline-content h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #67e8f9;
            margin-bottom: 0.5rem;
        }

        .timeline-content p {
            font-size: 1rem;
            color: #d1d5db;
            line-height: 1.6;
        }

        /* Media queries for responsiveness */
        @media screen and (max-width: 768px) {
            .timeline-container::after {
                left: 31px;
            }

            .timeline-event {
                width: 100%;
                padding-left: 70px;
                padding-right: 25px;
            }

            .timeline-event.left::before,
            .timeline-event.right::before {
                border: medium solid white;
                border-width: 10px 10px 10px 0;
                border-color: transparent #1f2937 transparent transparent;
                left: 60px;
            }

            .timeline-event.left::after,
            .timeline-event.right::after {
                left: 15px;
            }

            .timeline-event.right {
                left: 0%;
            }
        }

        /* Did You Know Pop-up */
        .did-you-know-popup {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background-color: rgba(22, 163, 74, 0.9); /* green-600 with transparency */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            max-width: 300px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0.3s ease-out;
            z-index: 100;
        }
        .did-you-know-popup.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .did-you-know-popup h4 {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .did-you-know-popup button {
            background-color: rgba(0,0,0,0.2);
            padding: 0.2rem 0.5rem;
            border-radius: 0.3rem;
            margin-left: 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .did-you-know-popup button:hover {
            background-color: rgba(0,0,0,0.4);
        }

        /* Tooltip for header title */
        .header-tooltip {
            position: absolute;
            background-color: rgba(59, 130, 246, 0.9); /* blue-500 with transparency */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out, visibility 0.2s ease-out;
            z-index: 101;
            pointer-events: none; /* Allows clicks to pass through */
            top: 100%; /* Position below the header title */
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            text-align: center;
        }
        .header-tooltip.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <header class="bg-gradient-to-r from-gray-900 to-slate-900 p-6 shadow-2xl rounded-b-xl mb-10 mx-auto w-full max-w-7xl">
        <div class="container mx-auto flex flex-col md:flex-row items-center justify-between">
            <h1 id="site-title" class="text-4xl md:text-5xl font-extrabold text-teal-400 mb-4 md:mb-0 drop-shadow-lg relative">
                Space Muse
                <!-- Tooltip for site title -->
                <div id="headerTooltip" class="header-tooltip"></div>
            </h1>
            <!-- Search Bar -->
            <div class="flex items-center space-x-2 mb-4 md:mb-0 w-full md:w-auto">
                <input type="text" id="glossarySearchInput" placeholder="Search glossary..." class="search-input p-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 w-full md:w-64">
                <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-300">
                    Search
                </button>
            </div>
            <!-- Navigation -->
            <nav>
                <ul class="flex flex-wrap justify-center md:justify-end space-x-4 md:space-x-6">
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="intro-section">Introduction</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="solar-system-section">Solar System</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="constellations-section">Constellations</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="stories-section">Stories</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="quiz-section">Quiz</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="calendar-section">Space Calendar</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="space-history-section">Space History</a></li> <!-- New Nav Link -->
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="interactive-concepts-section">Interactive Concepts</a></li> <!-- New Nav Link -->
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="glossary-section">Cosmic Glossary</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="about-section">About</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="contact-section">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Container (for managing page visibility) -->
    <div id="main-content-container" class="flex-grow container mx-auto p-6 max-w-7xl">

        <!-- Introduction Section -->
        <section id="intro-section" class="content-section py-10">
            <h2 class="text-4xl font-bold text-sky-400 mb-6 drop-shadow">Welcome to the Cosmic Canvas</h2>
            <p class="text-xl leading-relaxed text-gray-300 font-light">
                Step into the boundless expanse of imagination, where stars whisper ancient tales and nebulae paint vibrant sagas across the cosmic loom. Space Muse is your sanctuary for interstellar narratives, a collection of stories born from the silence of vacuum and the roar of supernovas. Explore the mysteries, the wonders, and the profound beauty of the universe, one story at a time.
            </p>
            <div id="did-you-know-intro" class="bg-gray-800 p-4 rounded-lg shadow-inner mt-8 text-center">
                <h3 class="text-2xl font-bold text-blue-300 mb-2">Did You Know?</h3>
                <p id="did-you-know-fact" class="text-lg text-gray-300"></p>
            </div>
        </section>

        <!-- Interactive Solar System Section -->
        <section id="solar-system-section" class="content-section py-10 relative">
            <h2 class="text-4xl font-bold text-orange-400 mb-6 drop-shadow">Interactive Solar System</h2>
            <p class="text-lg leading-relaxed text-gray-300 mb-6">
                Explore a simplified 3D model of our solar system! Click and drag to change your view, and zoom with your scroll wheel. Click on planets for more info!
            </p>
            
            <!-- Solar System Controls -->
            <div class="flex flex-wrap gap-4 mb-6 justify-center items-center">
                <label class="inline-flex items-center text-gray-300 cursor-pointer">
                    <input type="checkbox" id="toggleOrbits" class="form-checkbox h-5 w-5 text-blue-600 rounded" checked>
                    <span class="ml-2">Show Orbits</span>
                </label>
                <label class="inline-flex items-center text-gray-300 cursor-pointer">
                    <input type="checkbox" id="toggleMeteors" class="form-checkbox h-5 w-5 text-blue-600 rounded" checked>
                    <span class="ml-2">Show Meteors</span>
                </label>
                <label class="inline-flex items-center text-gray-300 cursor-pointer">
                    <input type="checkbox" id="toggleAxialTilt" class="form-checkbox h-5 w-5 text-blue-600 rounded" checked>
                    <span class="ml-2">Show Axial Tilt</span>
                </label>
                 <div class="flex items-center">
                    <label for="zoomSensitivity" class="text-gray-300 mr-2">Zoom Sensitivity:</label>
                    <input type="range" id="zoomSensitivity" min="0.1" max="2.0" value="0.5" step="0.1" class="w-32">
                </div>
                 <div class="flex items-center">
                    <label for="timeWarp" class="text-gray-300 mr-2">Time Warp:</label>
                    <input type="range" id="timeWarp" min="0.1" max="5.0" value="1.0" step="0.1" class="w-32">
                </div>
            </div>

            <div id="solarSystemCanvas-container" class="relative w-full">
                <canvas id="solarSystemCanvas" class="threejs-canvas"></canvas>
                <div id="solarSystemLoadingOverlay" class="loading-overlay">
                    <div class="spinner"></div>
                    <span class="ml-4">Loading Solar System...</span>
                </div>
                 <!-- Planet Info Pop-up (hidden by default) -->
                <div id="planetInfoPopup" class="info-popup hidden">
                    <h4 id="popupPlanetName"></h4>
                    <p class="category-title">Facts:</p>
                    <p id="popupPlanetFacts"></p>
                    <p class="category-title">Detailed Info:</p>
                    <ul class="text-sm text-gray-300 list-disc list-inside">
                        <li>Mass: <span id="planetMass"></span></li>
                        <li>Diameter: <span id="planetDiameter"></span></li>
                        <li>Avg. Temp: <span id="planetAvgTemp"></span></li>
                        <li>Orbital Period: <span id="planetOrbitalPeriod"></span></li>
                        <li>Rotation Period: <span id="planetRotationPeriod"></span></li>
                        <li>Moons: <span id="planetMoons"></span></li>
                        <li>Atmosphere: <span id="planetAtmosphere"></span></li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Constellations Section (Now independent of the Solar System 3D model) -->
        <section id="constellations-section" class="content-section py-10 relative">
            <h2 class="text-4xl font-bold text-indigo-400 mb-6 drop-shadow">Constellations: Patterns in the Stars</h2>
            <p class="text-xl leading-relaxed text-gray-300 font-light mb-6">
                Explore the mesmerizing patterns of constellations that have guided navigators and inspired storytellers for millennia. Click and drag to rotate, and zoom with your scroll wheel. Click on any star to learn more about the constellation!
            </p>
             <!-- Constellation Controls (optional, could add toggle for labels etc.) -->
            <div class="flex flex-wrap gap-4 mb-6 justify-center">
                <p class="text-gray-400">Interact with the 3D model below!</p>
            </div>
            <div id="constellationsCanvas-container" class="relative w-full">
                <canvas id="constellationsCanvas" class="threejs-canvas"></canvas>
                <div id="constellationsLoadingOverlay" class="loading-overlay">
                    <div class="spinner"></div>
                    <span class="ml-4">Loading Constellations...</span>
                </div>
                 <!-- Constellation Info Pop-up (hidden by default) -->
                <div id="constellationInfoPopup" class="info-popup hidden">
                    <h4 id="constellationPopupName"></h4>
                    <p class="category-title">Folklore:</p>
                    <p id="constellationPopupFolklore"></p>
                    <p class="category-title">Encyclopedic Info:</p>
                    <p id="constellationPopupEncyclopedic"></p>
                    <p class="category-title">Prominent Stars:</p>
                    <ul id="constellationProminentStars" class="text-sm text-gray-300 list-disc list-inside"></ul>
                    <p class="category-title">External Links:</p>
                    <a id="constellationExternalLink" href="#" target="_blank" class="text-blue-400 hover:underline text-sm">Learn More &rarr;</a>
                </div>
            </div>
        </section>

        <!-- Stories Section - Container for all story snippets -->
        <section id="stories-section" class="content-section py-10 space-y-16">
            <h2 class="text-4xl font-bold text-teal-400 mb-6 drop-shadow">Cosmic Narratives</h2>

            <!-- Story Snippet 1: The Echoes of Cygnus X-1 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-center">
                <div class="order-2 md:order-1">
                    <h3 class="text-3xl font-semibold text-purple-300 mb-4">The Echoes of Cygnus X-1</h3>
                    <p class="text-lg leading-relaxed text-gray-300 mb-6 font-light">
                        Deep within the heart of the Cygnus constellation, lies a whisper that spans light-years. It is said that Cygnus X-1, the ravenous black hole, doesn't merely consume, but preserves the echoes of civilizations swallowed whole. A lone voyager, adrift near its event horizon, tunes into these faint signals, hoping to piece together the final melodies of a vanished world. What secrets do the gravitational waves truly carry?
                    </p>
                    <a href="#" class="inline-flex items-center text-purple-400 hover:text-purple-200 transition-colors duration-300 font-medium text-lg">Read More
                        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                    </a>
                </div>
                <div class="order-1 md:order-2">
                    <img src="https://placehold.co/600x400/312E81/ffffff?text=Cygnus+X-1+Echoes" alt="Cygnus X-1 black hole illustration" class="rounded-xl shadow-lg w-full h-auto object-cover">
                </div>
            </div>

            <!-- Story Snippet 2: The Flora of Kepler-186f -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-center">
                <div>
                    <img src="https://placehold.co/600x400/064E3B/ffffff?text=Kepler-186f+Flora" alt="Alien flora on Kepler-186f" class="rounded-xl shadow-lg w-full h-auto object-cover">
                </div>
                <div>
                    <h3 class="text-3xl font-semibold text-emerald-300 mb-4">The Flora of Kepler-186f</h3>
                    <p class="text-lg leading-relaxed text-gray-300 mb-6 font-light">
                        On the exoplanet Kepler-186f, life thrives in hues unknown to Earth. Its forests glow with bioluminescent flora, casting an ethereal light under a crimson sun. Botanists from Earth dispatch a research probe, eager to catalog these otherworldly plants. But as they delve deeper, they uncover a symbiotic network far more intricate and intelligent than they could have imagined, a network that guards ancient secrets.
                    </p>
                    <a href="#" class="inline-flex items-center text-emerald-400 hover:text-emerald-200 transition-colors duration-300 font-medium text-lg">Read More
                        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                    </a>
                </div>
            </div>

            <!-- Story Snippet 3: The Lost Starchild -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-center">
                <div class="order-2 md:order-1">
                    <h3 class="text-3xl font-semibold text-fuchsia-300 mb-4">The Lost Starchild</h3>
                    <p class="text-lg leading-relaxed text-gray-300 mb-6 font-light">
                        Legend speaks of a Starchild, born from cosmic dust and nebula gas, whose laughter could ignite dying stars. Prophecy foretold its return, but centuries passed with only silence. Now, a young space scavenger, scavenging through forgotten asteroid fields, stumbles upon an
                        artifact that hums with an ancient energy, leading them on a perilous journey to find the lost Starchild and avert a galactic cataclysm.
                    </p>
                    <a href="#" class="inline-flex items-center text-fuchsia-400 hover:text-fuchsia-200 transition-colors duration-300 font-medium text-lg">Read More
                        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                    </a>
                </div>
                <div class="order-1 md:order-2">
                    <img src="https://placehold.co/600x400/7E22CE/ffffff?text=Lost+Starchild" alt="Cosmic child illustration" class="rounded-xl shadow-lg w-full h-auto object-cover">
                </div>
            </div>
        </section>

        <!-- Quiz Section -->
        <section id="quiz-section" class="content-section py-10">
            <h2 class="text-4xl font-bold text-green-400 mb-6 drop-shadow">Space Quiz Challenge!</h2>
            <p class="text-xl leading-relaxed text-gray-300 font-light mb-8">
                Test your knowledge of the cosmos! Select a difficulty level and start your stellar challenge.
            </p>

            <!-- Quiz Controls and Display -->
            <div class="w-full max-w-2xl mx-auto text-center">
                <div id="quiz-level-selection" class="mb-8 flex flex-wrap justify-center gap-4">
                    <button class="quiz-level-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-300" data-level="easy">Easy</button>
                    <button class="quiz-level-btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-300" data-level="medium">Medium</button>
                    <button class="quiz-level-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-300" data-level="hard">Hard</button>
                </div>

                <div id="quiz-container" class="hidden">
                    <p id="quiz-score" class="text-2xl font-bold text-yellow-300 mb-4">Score: 0</p>
                    <p id="quiz-question" class="text-2xl font-medium text-gray-200 mb-6"></p>
                    <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <!-- Answer buttons will be injected here by JavaScript -->
                    </div>
                    <p id="quiz-feedback" class="text-lg font-semibold mb-4"></p>
                    <button id="quiz-next-btn" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 hidden">Next Question</button>
                    <button id="quiz-reset-btn" class="bg-red-700 hover:bg-red-800 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 hidden">Restart Quiz</button>
                </div>
            </div>
        </section>

        <!-- New Space Calendar Section -->
        <section id="calendar-section" class="content-section py-10">
            <h2 class="text-4xl font-bold text-yellow-400 mb-6 drop-shadow">Space Event Calendar</h2>
            <p class="text-xl leading-relaxed text-gray-300 font-light mb-8">
                Stay updated with major space events like rocket launches, meteor showers, and planetary alignments!
            </p>

            <div class="w-full max-w-4xl mx-auto bg-gray-900 p-8 rounded-xl shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <button id="prevMonthBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-300">&larr; Previous</button>
                    <h3 id="currentMonthYear" class="text-3xl font-bold text-white"></h3>
                    <button id="nextMonthBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-300">Next &rarr;</button>
                </div>

                <div class="calendar-grid text-center font-semibold text-lg mb-4">
                    <div class="text-gray-400">Sun</div>
                    <div class="text-gray-400">Mon</div>
                    <div class="text-gray-400">Tue</div>
                    <div class="text-gray-400">Wed</div>
                    <div class="text-gray-400">Thu</div>
                    <div class="text-gray-400">Fri</div>
                    <div class="text-gray-400">Sat</div>
                </div>

                <div id="calendarDays" class="calendar-grid">
                    <!-- Calendar days will be injected here by JavaScript -->
                </div>
            </div>
        </section>

        <!-- New Space History Timeline Section -->
        <section id="space-history-section" class="content-section py-10">
            <h2 class="text-4xl font-bold text-red-400 mb-8 drop-shadow">Historical Timeline of Space Exploration</h2>
            <div id="timeline-container" class="timeline-container">
                <!-- Timeline events will be dynamically loaded here by JavaScript -->
            </div>
        </section>

        <!-- New Interactive Concepts Section -->
        <section id="interactive-concepts-section" class="content-section py-10">
            <h2 class="text-4xl font-bold text-pink-400 mb-6 drop-shadow">Interactive Concepts</h2>
            <p class="text-xl leading-relaxed text-gray-300 font-light mb-8">
                Visually explore complex astronomical phenomena with interactive diagrams!
            </p>

            <!-- Moon Phases Diagram -->
            <div class="bg-gray-900 p-8 rounded-xl shadow-xl mb-12">
                <h3 class="text-3xl font-bold text-orange-300 mb-4 text-center">Moon Phases Explained</h3>
                <p class="text-lg text-gray-300 mb-6 text-center">
                    Use the slider to change the Moon's position and observe how its phase changes from Earth's perspective. The larger sphere represents the Earth, the smaller sphere is the Moon, and the light source to the right simulates the Sun.
                </p>
                <div class="flex flex-col items-center mb-6">
                    <input type="range" id="moonPhaseSlider" min="0" max="360" value="0" class="w-full max-w-lg cursor-pointer">
                    <p id="moonPhaseLabel" class="text-xl font-semibold text-white mt-4">New Moon</p>
                </div>
                <div id="moonPhasesCanvas-container" class="relative w-full">
                    <canvas id="moonPhasesCanvas" class="threejs-canvas"></canvas>
                    <div id="moonPhasesLoadingOverlay" class="loading-overlay">
                        <div class="spinner"></div>
                        <span class="ml-4">Loading Moon Phases Diagram...</span>
                    </div>
                </div>
            </div>

            <!-- Eclipses Diagram (NEW) -->
            <div class="bg-gray-900 p-8 rounded-xl shadow-xl mb-12">
                <h3 class="text-3xl font-bold text-emerald-300 mb-4 text-center">Eclipses: Solar & Lunar</h3>
                <p class="text-lg text-gray-300 mb-6 text-center">
                    Adjust the slider to simulate the Earth and Moon's orbital positions relative to the Sun. Observe when the Moon's shadow falls on Earth (Solar Eclipse) or when the Earth's shadow falls on the Moon (Lunar Eclipse).
                </p>
                <div class="flex flex-col items-center mb-6">
                    <input type="range" id="eclipseSlider" min="0" max="360" value="0" class="w-full max-w-lg cursor-pointer">
                    <p id="eclipseLabel" class="text-xl font-semibold text-white mt-4">No Eclipse</p>
                </div>
                <div id="eclipsesCanvas-container" class="relative w-full">
                    <canvas id="eclipsesCanvas" class="threejs-canvas"></canvas>
                    <div id="eclipsesLoadingOverlay" class="loading-overlay">
                        <div class="spinner"></div>
                        <span class="ml-4">Loading Eclipses Diagram...</span>
                    </div>
                </div>
            </div>

        </section>


        <!-- New Cosmic Glossary Section -->
        <section id="glossary-section" class="content-section py-10">
            <h2 class="text-4xl font-bold text-cyan-400 mb-8 drop-shadow">Cosmic Glossary</h2>
            <div class="mb-6">
                <input type="text" id="glossaryFilterInput" placeholder="Filter terms..." class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
            </div>
            <div id="glossary-container" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Glossary terms will be dynamically loaded here -->
            </div>
        </section>

        <!-- New About Section -->
        <section id="about-section" class="content-section py-10">
            <h2 class="text-4xl font-bold text-purple-400 mb-6 drop-shadow">About Space Muse</h2>
            <p class="text-xl leading-relaxed text-gray-300 font-light mb-4">
                Space Muse is a passion project dedicated to exploring the wonders of the cosmos through storytelling, interactive simulations, and educational challenges. Our goal is to inspire curiosity about space and science for all ages.
            </p>
            <p class="text-lg leading-relaxed text-gray-400">
                From ancient myths woven into constellations to the latest discoveries from distant galaxies, we aim to provide an engaging platform for cosmic exploration.
            </p>
        </section>

        <!-- New Contact Section -->
        <section id="contact-section" class="content-section py-10">
            <h2 class="text-4xl font-bold text-pink-400 mb-6 drop-shadow">Contact Us</h2>
            <p class="text-xl leading-relaxed text-gray-300 font-light mb-8">
                Have a question, suggestion, or a cosmic story to share? We'd love to hear from you!
            </p>
            <form class="max-w-md mx-auto">
                <div class="mb-6">
                    <label for="name" class="block text-gray-300 text-lg font-medium mb-2">Your Name</label>
                    <input type="text" id="name" name="name" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="John Doe">
                </div>
                <div class="mb-6">
                    <label for="email" class="block text-gray-300 text-lg font-medium mb-2">Your Email</label>
                    <input type="email" id="email" name="email" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="your.email@example.com">
                </div>
                <div class="mb-6">
                    <label for="message" class="block text-gray-300 text-lg font-medium mb-2">Your Message</label>
                    <textarea id="message" name="message" rows="5" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Tell us your cosmic thoughts..."></textarea>
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition-colors duration-300">
                        Send Message
                    </button>
                </div>
            </form>
        </section>

    </div> <!-- End of main-content-container -->

    <!-- Modal for Event Details -->
    <div id="eventModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeModalBtn" class="modal-close-btn">&times;</button>
            <h3 id="modalEventTitle" class="text-3xl font-bold text-white mb-3"></h3>
            <p id="modalEventDate" class="text-lg text-gray-400 mb-4"></p>
            <p id="modalEventDescription" class="text-md text-gray-300 leading-relaxed"></p>
            <div id="modalMoonPhase" class="text-lg text-white mt-4"></div>
             <!-- Loading indicator for LLM story -->
            <div id="llmStoryLoading" class="hidden text-center text-gray-400 mt-4">
                <div class="spinner inline-block mr-2"></div> Loading cosmic tale...
            </div>
        </div>
    </div>

    <!-- Did You Know? Popup (floating at bottom right) -->
    <div id="didYouKnowPopup" class="did-you-know-popup">
        <h4>Did You Know?</h4>
        <p id="didYouKnowFactContent"></p>
        <div class="text-right mt-2">
            <button id="nextFactBtn" class="bg-blue-700 hover:bg-blue-800 text-white font-semibold py-1 px-3 rounded-md transition-colors duration-200">Next Fact</button>
            <button id="closeFactBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1 px-3 rounded-md transition-colors duration-200 ml-2">Close</button>
        </div>
    </div>


    <!-- Footer Section -->
    <footer class="bg-gray-950 p-8 mt-12 rounded-t-xl mx-auto w-full max-w-7xl">
        <div class="container mx-auto text-center text-gray-500 text-sm">
            &copy; 2025 Space Muse. All rights reserved. Journey through the cosmos.
        </div>
    </footer>

    <script>
        // III. JavaScript for 3D Solar System Simulation, Quiz Logic, Space Calendar, and Multi-Page Navigation

        // --- Three.js Variables (Solar System) ---
        let solarSystemScene, solarSystemCamera, solarSystemRenderer;
        let sun;
        const planets = [];
        const orbitLines = []; // Store orbit meshes for toggling
        const meteors = [];
        let solarSystemStarsBackground; // For the new starfield
        let solarSystemMouseX = 0, solarSystemMouseY = 0; // Mouse position for camera control
        let solarSystemIsDragging = false;
        let solarSystemPreviousMouseX = 0, solarSystemPreviousMouseY = 0;
        let solarSystemLoadingOverlay;
        let solarSystemInitialized = false; // Flag to ensure Three.js initializes only once
        let solarSystemZoomSensitivity = 0.5; // Initial zoom sensitivity
        let timeWarpFactor = 1.0; // New: For controlling simulation speed
        let showAxialTilt = true; // New: Toggle for axial tilt

        // For planet info pop-up and highlighting (Solar System)
        const solarSystemRaycaster = new THREE.Raycaster();
        const solarSystemMouse = new THREE.Vector2();
        let solarSystemPreviouslyClickedObject = null; // To store the currently highlighted object
        let planetInfoPopup = null;
        let popupPlanetName = null;
        let popupPlanetFacts = null;
        const HIGHLIGHT_COLOR = 0x000000; // Changed to black to effectively remove highlight

        // --- Three.js Variables (Constellations) ---
        let constellationsScene, constellationsCamera, constellationsRenderer;
        let constellationsGroup; // Group to hold all constellation elements
        let constellationsStarsBackground;
        let constellationsSun, constellationsEarth; // Sun and Earth for constellation view
        let constellationsMouseX = 0, constellationsMouseY = 0;
        let constellationsIsDragging = false;
        let constellationsPreviousMouseX = 0, constellationsPreviousMouseY = 0;
        let constellationsLoadingOverlay;
        let constellationsInitialized = false; // Flag for constellation Three.js initialization
        const CONSTELLATION_HIGHLIGHT_COLOR = 0x000000; // Changed to black to effectively remove highlight

        // For constellation info pop-up and highlighting
        const constellationsRaycaster = new THREE.Raycaster();
        const constellationsMouse = new THREE.Vector2();
        let previouslyClickedConstellationStar = null; // To store the currently highlighted constellation star
        let constellationInfoPopup = null;
        let constellationPopupName = null;
        let constellationPopupFolklore = null;
        let constellationPopupEncyclopedic = null;
        let constellationProminentStars = null;
        let constellationExternalLink = null;

        // --- Three.js Variables (Moon Phases) ---
        let moonPhaseScene, moonPhaseCamera, moonPhaseRenderer;
        let moon, earthMoonPhase, sunLightMoonPhase;
        let moonPhaseLoadingOverlay;
        let moonPhaseInitialized = false;
        let moonPhaseCurrentAngle = 0; // Track the Moon's angle around Earth
        const moonPhaseNames = ["New Moon", "Waxing Crescent", "First Quarter", "Waxing Gibbous", "Full Moon", "Waning Gibbous", "Last Quarter", "Waning Crescent", "New Moon"]; // Added "New Moon" twice for smooth loop
        const moonPhaseAngles = [0, 45, 90, 135, 180, 225, 270, 315, 360]; // Corresponding angles in degrees

        // --- Three.js Variables (Eclipses) ---
        let eclipsesScene, eclipsesCamera, eclipsesRenderer;
        let eclipseSun, eclipseEarth, eclipseMoon;
        let umbraMesh, penumbraMesh; // For shadows
        let eclipsesLoadingOverlay;
        let eclipsesInitialized = false;
        let eclipseCurrentAngle = 0; // Track Earth's angle around Sun for eclipse simulation
        const eclipseLabels = {
            solar: "Solar Eclipse",
            lunar: "Lunar Eclipse",
            none: "No Eclipse"
        };


        // Function to create a simple starfield texture (procedural)
        function createStarfieldTexture(density = 1000) {
            const size = 256; // Larger size for better quality
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const context = canvas.getContext('2d');
            context.fillStyle = '#000000'; // Black background
            context.fillRect(0, 0, size, size);

            for (let i = 0; i < density; i++) { // More stars for texture
                const x = Math.random() * size;
                const y = Math.random() * size;
                const radius = Math.random() * 0.7 + 0.2; // Larger stars with more variation
                const opacity = Math.random() * 0.7 + 0.3; // Varying brightness
                context.fillStyle = `rgba(255, 255, 255, ${opacity})`;
                context.beginPath();
                context.arc(x, y, radius, 0, Math.PI * 2);
                context.fill();
            }
            return new THREE.CanvasTexture(canvas);
        }

        // Create a procedural cloud texture for Earth
        function createCloudTexture() {
            const size = 128;
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const context = canvas.getContext('2d');

            context.fillStyle = 'rgba(0,0,0,0)'; // Transparent background
            context.fillRect(0, 0, size, size);

            // Draw some random white/grey circles to simulate clouds
            for (let i = 0; i < 30; i++) {
                const x = Math.random() * size;
                const y = Math.random() * size;
                const radius = Math.random() * 15 + 10;
                const opacity = Math.random() * 0.3 + 0.2;
                const gray = Math.floor(Math.random() * 50) + 200; // Light gray
                context.fillStyle = `rgba(${gray}, ${gray}, ${gray}, ${opacity})`;
                context.beginPath();
                context.arc(x, y, radius, 0, Math.PI * 2);
                context.fill();
            }
            return new THREE.CanvasTexture(canvas);
        }

        const sharedStarfieldTexture = createStarfieldTexture(2000); // Higher density for background
        const earthCloudTexture = createCloudTexture();


        // --- Solar System Data ---
        // Enhanced PLANET_DATA with improved colors and orbital speeds for better realism
        const PLANET_DATA = [
            // Note: Radii and distances are highly scaled for visibility in a single view.
            // Orbital speeds are proportionally more accurate but still accelerated for visualization.
            // axialTilt in radians (approximate for visual representation)
            { name: 'Mercury', radius: 0.1, color: 0x8A8A8A, distance: 2, orbitalSpeed: 0.04, rotationSpeed: 0.005, axialTilt: 0.001, emissiveColor: 0x000000, facts: "Closest and smallest planet. Very hot during the day, freezing at night.", mass: "0.330 x 10^24 kg", diameter: "4,879 km", avgTemp: "167 °C", orbitalPeriod: "88 Earth days", rotationPeriod: "58.6 Earth days", moons: "0", atmosphere: "Trace exosphere" },
            { name: 'Venus', radius: 0.2, color: 0xDC7633, distance: 3.5, orbitalSpeed: 0.025, rotationSpeed: 0.002, axialTilt: 3.09, emissiveColor: 0x000000, facts: "Earth's 'sister planet' with extreme greenhouse effect. Hottest planet in our solar system.", mass: "4.87 x 10^24 kg", diameter: "12,104 km", avgTemp: "462 °C", orbitalPeriod: "225 Earth days", rotationPeriod: "-243 Earth days (retrograde)", moons: "0", atmosphere: "Dense CO2" },
            { name: 'Earth', radius: 0.22, color: 0x0077BE, distance: 5, orbitalSpeed: 0.015, rotationSpeed: 0.01, axialTilt: 0.41, emissiveColor: 0x000000, facts: "Our home planet, vibrant with life and liquid water.", mass: "5.97 x 10^24 kg", diameter: "12,742 km", avgTemp: "15 °C", orbitalPeriod: "365.25 Earth days", rotationPeriod: "1 Earth day", moons: "1 (Moon)", atmosphere: "N2, O2" },
            { name: 'Mars', radius: 0.15, color: 0xC34A2C, distance: 6.5, orbitalSpeed: 0.012, rotationSpeed: 0.009, axialTilt: 0.44, emissiveColor: 0x000000, facts: "The Red Planet, with polar ice caps and a thin atmosphere. Subject of intense exploration.", mass: "0.642 x 10^24 kg", diameter: "6,779 km", avgTemp: "-63 °C", orbitalPeriod: "687 Earth days", rotationPeriod: "1.03 Earth days", moons: "2 (Phobos, Deimos)", atmosphere: "Thin CO2" },
            { name: 'Jupiter', radius: 1.2, color: 0xD4B25E, distance: 12, orbitalSpeed: 0.007, rotationSpeed: 0.02, axialTilt: 0.05, emissiveColor: 0x000000, facts: "Largest planet, a gas giant with a Great Red Spot. Has many moons.", mass: "1898 x 10^24 kg", diameter: "139,820 km", avgTemp: "-145 °C", orbitalPeriod: "11.86 Earth years", rotationPeriod: "0.41 Earth days", moons: "95+ (Galilean moons: Io, Europa, Ganymede, Callisto)", atmosphere: "H2, He" },
            { name: 'Saturn', radius: 1.0, color: 0xE8C46C, distance: 16, orbitalSpeed: 0.005, ring: true, axialTilt: 0.47, rotationSpeed: 0.018, emissiveColor: 0x000000, facts: "Famous for its magnificent icy rings, composed of countless particles.", mass: "568 x 10^24 kg", diameter: "116,460 km", avgTemp: "-178 °C", orbitalPeriod: "29.45 Earth years", rotationPeriod: "0.44 Earth days", moons: "146+ (Largest: Titan)", atmosphere: "H2, He" },
            { name: 'Uranus', radius: 0.7, color: 0x77C3EC, distance: 20, orbitalSpeed: 0.0035, rotationSpeed: 0.015, axialTilt: 1.7, emissiveColor: 0x000000, facts: "An ice giant that rotates on its side. Has faint rings.", mass: "86.8 x 10^24 kg", diameter: "50,724 km", avgTemp: "-216 °C", orbitalPeriod: "84 Earth years", rotationPeriod: "-0.72 Earth days (retrograde)", moons: "27+", atmosphere: "H2, He, CH4" },
            { name: 'Neptune', radius: 0.68, color: 0x4A6BE8, distance: 24, orbitalSpeed: 0.0025, rotationSpeed: 0.016, axialTilt: 0.5, emissiveColor: 0x000000, facts: "Farthest planet, an ice giant with strong winds and a Great Dark Spot.", mass: "102 x 10^24 kg", diameter: "49,244 km", avgTemp: "-214 °C", orbitalPeriod: "164.79 Earth years", rotationPeriod: "0.67 Earth days", moons: "14+", atmosphere: "H2, He, CH4" },
            { name: 'Pluto', radius: 0.05, color: 0xA3A3A3, distance: 28, orbitalSpeed: 0.0015, rotationSpeed: 0.003, axialTilt: 0.2, emissiveColor: 0x000000, facts: "A dwarf planet in the Kuiper Belt, icy and distant.", mass: "0.0130 x 10^24 kg", diameter: "2,376 km", avgTemp: "-229 °C", orbitalPeriod: "248 Earth years", rotationPeriod: "-6.39 Earth days (retrograde)", moons: "5 (Charon, etc.)", atmosphere: "N2, CH4, CO" },
            { name: 'Sun', radius: 1.5, color: 0xFDB813, emissiveColor: 0xFDB813, emissiveIntensity: 1, facts: "The star at the center of our solar system, powering all life on Earth.", identifiable: true, mass: "1.989 x 10^30 kg", diameter: "1,392,000 km", avgTemp: "5,778 K (surface)", orbitalPeriod: "N/A", rotationPeriod: "27 Earth days (equator)", moons: "N/A", atmosphere: "Hydrogen, helium" }
        ];

        // New MOON_DATA
        const MOON_DATA = [
            // Earth's Moon
            { name: 'Moon', parent: 'Earth', radius: 0.08, color: 0xCCCCCC, distance: 1.2, orbitalSpeed: 0.08, rotationSpeed: 0.008, axialTilt: 0.11, facts: "Earth's only natural satellite, responsible for tides.", mass: "0.073 x 10^24 kg", diameter: "3,474 km", avgTemp: "-20 to 120 °C", orbitalPeriod: "27.3 Earth days", rotationPeriod: "27.3 Earth days (tidally locked)", atmosphere: "Trace exosphere" },
            // Jupiter's Galilean Moons (scaled distances/radii for visibility)
            { name: 'Io', parent: 'Jupiter', radius: 0.06, color: 0xE8B052, distance: 1.8, orbitalSpeed: 0.2, rotationSpeed: 0.02, axialTilt: 0, facts: "Most volcanically active body in the Solar System.", mass: "0.089 x 10^24 kg", diameter: "3,643 km", avgTemp: "-145 °C", orbitalPeriod: "1.77 Earth days", rotationPeriod: "1.77 Earth days", atmosphere: "Sulphur dioxide" },
            { name: 'Europa', parent: 'Jupiter', radius: 0.05, color: 0x93B7CD, distance: 2.3, orbitalSpeed: 0.15, rotationSpeed: 0.015, axialTilt: 0, facts: "Believed to harbor a subsurface ocean, potential for life.", mass: "0.048 x 10^24 kg", diameter: "3,122 km", avgTemp: "-160 °C", orbitalPeriod: "3.55 Earth days", rotationPeriod: "3.55 Earth days", atmosphere: "Trace O2" },
            { name: 'Ganymede', parent: 'Jupiter', radius: 0.09, color: 0xA0A0A0, distance: 3.0, orbitalSpeed: 0.1, rotationSpeed: 0.01, axialTilt: 0, facts: "Largest moon in the Solar System, larger than Mercury.", mass: "0.148 x 10^24 kg", diameter: "5,262 km", avgTemp: "-163 °C", orbitalPeriod: "7.15 Earth days", rotationPeriod: "7.15 Earth days", atmosphere: "Trace O2" },
            { name: 'Callisto', parent: 'Jupiter', radius: 0.07, color: 0x777777, distance: 3.8, orbitalSpeed: 0.08, rotationSpeed: 0.008, axialTilt: 0, facts: "Heavily cratered, ancient surface, possibly a subsurface ocean.", mass: "0.108 x 10^24 kg", diameter: "4,821 km", avgTemp: "-139 °C", orbitalPeriod: "16.69 Earth days", rotationPeriod: "16.69 Earth days", atmosphere: "Trace CO2" }
        ];


        // --- Constellation Data (Zodiac) ---
        const ZODIAC_CONSTELLATION_DATA = [
            {
                name: "Aries", color: 0xFFD700, angleOffset: 0, // 0 degrees
                stars: [[0, 0, 0], [2, 1, 0], [1, 3, 0], [3, 2, 0]],
                lines: [[0, 1], [1, 2], [2, 3]],
                folklore: "In Greek mythology, Aries represents the Golden Fleece sought by Jason and the Argonauts. This ram was sent by Nephele to carry her children, Phrixus and Helle, to safety. Phrixus sacrificed the ram to Zeus, who placed it in the stars.",
                encyclopedic: "Aries is a small to medium-sized constellation. It is one of the 12 constellations of the zodiac, meaning it lies on the ecliptic, the apparent path of the Sun across the celestial sphere. Its most prominent stars are Hamal (Alpha Arietis) and Sheratan (Beta Arietis).",
                prominentStars: [{ name: "Hamal (Alpha Arietis)", type: "Orange Giant" }, { name: "Sheratan (Beta Arietis)", type: "White Main-sequence" }],
                externalLink: "https://en.wikipedia.org/wiki/Aries_(constellation)"
            },
            {
                name: "Taurus", color: 0xFFA07A, angleOffset: 30, // 30 degrees
                stars: [[0, 0, 0], [-2, 1, 0], [0, 3, 0], [3, 2, 0], [1, 5, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4]],
                folklore: "Taurus is most famously identified with the white bull that Zeus transformed into to abduct Europa, a Phoenician princess. Another myth associates it with Io, a lover of Zeus, transformed into a heifer by Hera.",
                encyclopedic: "Taurus is a large and prominent constellation in the Northern Hemisphere's winter sky. It contains the bright red giant star Aldebaran, the Hyades star cluster (which forms the bull's head), and the Pleiades (Seven Sisters) star cluster.",
                prominentStars: [{ name: "Aldebaran (Alpha Tauri)", type: "Red Giant" }, { name: "Alcyone (Eta Tauri)", type: "Blue-white Giant (Pleiades)" }],
                externalLink: "https://en.wikipedia.org/wiki/Taurus_(constellation)"
            },
            {
                name: "Gemini", color: 0x90EE90, angleOffset: 60, // 60 degrees
                stars: [[0, 0, 0], [0, 2, 0], [2, 0, 0], [2, 2, 0]],
                lines: [[0, 1], [2, 3], [0, 2]],
                folklore: "In Greek mythology, Gemini represents the twins Castor and Pollux. While Pollux was immortal (son of Zeus), Castor was mortal (son of Tyndareus). When Castor died, Pollux pleaded with Zeus to allow them to share his immortality, and they were placed together in the heavens.",
                encyclopedic: "Gemini is one of the constellations of the zodiac and is easily recognizable by its two brightest stars, Castor and Pollux, which represent the heads of the twins. It is best seen during the winter months in the Northern Hemisphere.",
                prominentStars: [{ name: "Pollux (Beta Geminorum)", type: "Orange Giant" }, { name: "Castor (Alpha Geminorum)", type: "Multiple Star System" }],
                externalLink: "https://en.wikipedia.org/wiki/Gemini_(constellation)"
            },
            {
                name: "Cancer", color: 0xADD8E6, angleOffset: 90, // 90 degrees
                stars: [[0, 0, 0], [1, 1, 0], [2, 0, 0], [1, -1, 0], [-1, 0, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 0]],
                folklore: "In Greek mythology, Cancer represents the crab that attacked Heracles during his battle with the Lernaean Hydra. Hera sent the crab to distract him, but Heracles crushed it. As a reward for its service, Hera placed the crab among the stars.",
                encyclopedic: "Cancer is a relatively faint constellation and is considered one of the smallest constellations in the zodiac. It contains the Beehive Cluster (Messier 44), an open cluster of stars visible to the naked eye under dark skies.",
                prominentStars: [{ name: "Acubens (Alpha Cancri)", type: "Binary Star" }, { name: "Tarf (Beta Cancri)", type: "Orange Giant" }],
                externalLink: "https://en.wikipedia.org/wiki/Cancer_(constellation)"
            },
            {
                name: "Leo", color: 0xFF4500, angleOffset: 120, // 120 degrees
                stars: [[0, 0, 0], [2, 1, 0], [1, 3, 0], [4, 2, 0], [3, -1, 0], [5, -2, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [1, 4]],
                folklore: "Leo represents the Nemean Lion, a ferocious beast with impenetrable hide that was killed by Heracles as the first of his twelve labors. Zeus placed it in the sky to commemorate Heracles' triumph.",
                encyclopedic: "Leo is one of the constellations of the zodiac, positioned between Cancer to the west and Virgo to the east. It is easily recognized by the 'Sickle' asterism, which resembles a backwards question mark and forms the lion's head. Its brightest star is Regulus.",
                prominentStars: [{ name: "Regulus (Alpha Leonis)", type: "Blue-white Main-sequence" }, { name: "Denebola (Beta Leonis)", type: "White Main-sequence" }],
                externalLink: "https://en.wikipedia.org/wiki/Leo_(constellation)"
            },
            {
                name: "Virgo", color: 0xDA70D6, angleOffset: 150, // 150 degrees
                stars: [[0, 0, 0], [2, 2, 0], [4, 0, 0], [3, -2, 0], [1, -1, 0], [-1, 1, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 0]],
                folklore: "Virgo is often associated with Dike, the Greek goddess of justice, or Persephone, the goddess of innocence and spring, who spent part of the year in the underworld. Her appearance in the sky marks the time of harvest.",
                encyclopedic: "Virgo is the second largest constellation in the sky and the largest of the zodiac constellations. It contains the bright blue-white star Spica and is home to the Virgo Cluster, a large galaxy cluster.",
                prominentStars: [{ name: "Spica (Alpha Virginis)", type: "Blue Giant Binary" }, { name: "Porrima (Gamma Virginis)", type: "Binary Star" }],
                externalLink: "https://en.wikipedia.org/wiki/Virgo_(constellation)"
            },
            {
                name: "Libra", color: 0x87CEEB, angleOffset: 180, // 180 degrees
                stars: [[0, 0, 0], [2, 0, 0], [1, 2, 0], [-1, 2, 0], [0, -2, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 0], [0, 4]],
                folklore: "Libra is the only zodiac constellation representing an inanimate object – the Scales. It is often associated with the scales of justice held by the goddess Themis or Astraea (Virgo), symbolizing balance and fairness, especially during the autumnal equinox when day and night are equal.",
                encyclopedic: "Libra is a constellation in the Southern Hemisphere, located between Virgo to the west and Scorpius to the east. Its two brightest stars are Zubenelgenubi (Alpha Librae) and Zubeneschamali (Beta Librae).",
                prominentStars: [{ name: "Zubenelgenubi (Alpha Librae)", type: "Multiple Star System" }, { name: "Zubeneschamali (Beta Librae)", type: "Blue-white Subgiant" }],
                externalLink: "https://en.wikipedia.org/wiki/Libra_(constellation)"
            },
            {
                name: "Scorpius", color: 0xFF6347, angleOffset: 210, // 210 degrees
                stars: [[0, 0, 0], [-2, 1, 0], [0, 3, 0], [2, 2, 0], [3, 0, 0], [1, -2, 0], [0, -4, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 6]],
                folklore: "In Greek mythology, Scorpius is the scorpion that stung and killed Orion the hunter. As a result, the two constellations are placed on opposite sides of the sky so that they can never meet.",
                encyclopedic: "Scorpius is a large constellation located in the Southern Hemisphere near the center of the Milky Way. Its brightest star is Antares, a red supergiant and one of the brightest stars in the night sky. It has a distinctive J-shape or S-shape.",
                prominentStars: [{ name: "Antares (Alpha Scorpii)", type: "Red Supergiant" }, { name: "Shaula (Lambda Scorpii)", type: "Blue Subgiant" }],
                externalLink: "https://en.wikipedia.org/wiki/Scorpius"
            },
            {
                name: "Ophiuchus", color: 0xCD853F, angleOffset: 240, // 240 degrees (The 13th zodiac sign)
                stars: [[0,0,0], [1,2,0], [3,1,0], [2,-1,0], [-1,-2,0], [-2,0,0]],
                lines: [[0,1], [1,2], [2,3], [3,4], [4,5], [5,0]],
                folklore: "Ophiuchus, the Serpent-Bearer, is often identified with the god Asclepius, the son of Apollo, who was a legendary healer. Zeus placed him in the heavens after killing him with a thunderbolt for bringing a mortal back from the dead, fearing he would make all humans immortal.",
                encyclopedic: "Ophiuchus is a large constellation located around the celestial equator. Astronomically, the Sun passes through Ophiuchus for about 18 days each year, making it the '13th zodiac sign' in addition to the traditional twelve. It is often depicted as a man grasping a serpent (Serpens constellation).",
                prominentStars: [{ name: "Rasalhague (Alpha Ophiuchi)", type: "White Giant" }, { name: "Sabik (Eta Ophiuchi)", type: "Binary Star" }],
                externalLink: "https://en.wikipedia.org/wiki/Ophiuchus"
            },
            {
                name: "Sagittarius", color: 0x8A2BE2, angleOffset: 270, // 270 degrees
                stars: [[0, 0, 0], [2, 1, 0], [1, -2, 0], [4, 0, 0], [3, -3, 0], [5, -1, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5]],
                folklore: "Sagittarius is typically depicted as a centaur (half-human, half-horse) archer, aiming his bow and arrow towards Scorpius. He is sometimes identified as Chiron, the wise centaur tutor of many Greek heroes.",
                encyclopedic: "Sagittarius is a prominent constellation in the Southern Hemisphere, known for containing the center of the Milky Way Galaxy. It is often recognized by the 'Teapot' asterism, a smaller pattern within the constellation.",
                prominentStars: [{ name: "Kaus Australis (Epsilon Sagittarii)", type: "Blue Giant" }, { name: "Nunki (Sigma Sagittarii)", type: "Blue Giant" }],
                externalLink: "https://en.wikipedia.org/wiki/Sagittarius_(constellation)"
            },
            {
                name: "Capricornus", color: 0x4682B4, angleOffset: 300, // 300 degrees
                stars: [[0, 0, 0], [-1, 2, 0], [1, 3, 0], [3, 1, 0], [2, -1, 0], [0, -3, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 0]],
                folklore: "Capricornus is often depicted as a mythical sea-goat, a creature that is half goat and half fish. In Babylonian mythology, it was associated with the god Ea or Enki, who represented water, wisdom, and creation.",
                encyclopedic: "Capricornus is a constellation in the Southern Hemisphere, part of the zodiac. It is one of the fainter zodiac constellations but can be found by looking for its distinctive triangle or V-shape. Its brightest star is Deneb Algedi.",
                prominentStars: [{ name: "Deneb Algedi (Delta Capricorni)", type: "White Giant" }, { name: "Nashira (Gamma Capricorni)", type: "White Giant" }],
                externalLink: "https://en.wikipedia.org/wiki/Capricornus"
            },
            {
                name: "Aquarius", color: 0x00BFFF, angleOffset: 330, // 330 degrees
                stars: [[0, 0, 0], [2, 1, 0], [0, 3, 0], [-2, 1, 0], [-1, -1, 0], [1, -3, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5]],
                folklore: "Aquarius, the Water-Bearer, is an ancient constellation with roots in Babylonian astronomy, where it was associated with flooding and rain. In Greek mythology, it is sometimes identified with Ganymede, the cup-bearer of the gods.",
                encyclopedic: "Aquarius is a large constellation in the Southern Hemisphere, one of the oldest recognized constellations. It is often depicted as a figure pouring water from an urn. It is best seen in the autumn evening sky.",
                prominentStars: [{ name: "Sadalsuud (Beta Aquarii)", type: "Yellow Supergiant" }, { name: "Sadalmelik (Alpha Aquarii)", type: "Yellow Supergiant" }],
                externalLink: "https://en.wikipedia.org/wiki/Aquarius_(constellation)"
            },
            {
                name: "Pisces", color: 0x00CED1, angleOffset: 360, // 360 degrees (overlaps 0 degrees / Aries)
                stars: [[0, 0, 0], [1, 2, 0], [-1, 3, 0], [2, -1, 0], [4, 1, 0], [3, 3, 0]],
                lines: [[0, 1], [1, 2], [0, 3], [3, 4], [4, 5]],
                folklore: "Pisces, the Fish, is associated with the myth of Aphrodite and Eros (Venus and Cupid in Roman mythology) who transformed into fish and jumped into the Euphrates River to escape the monster Typhon. They were tied together with a cord to avoid being separated.",
                encyclopedic: "Pisces is a large constellation of the zodiac. It is depicted as two fish tied together by their tails, swimming in opposite directions. It contains the star Alrescha, which marks the knot holding the two fish together.",
                prominentStars: [{ name: "Alrescha (Alpha Piscium)", type: "Binary Star" }, { name: "Fumalsamakah (Beta Piscium)", type: "Binary Star" }],
                externalLink: "https://en.wikipedia.org/wiki/Pisces_(constellation)"
            },
            // Added More Constellations (non-zodiac, placed randomly for demonstration)
            {
                name: "Ursa Major", color: 0xFFD700, angleOffset: 10, // A bit off the ecliptic for visual distinction
                stars: [
                    [-25, 30, -10], [-20, 25, -12], [-15, 20, -15], [-10, 15, -18],
                    [5, 10, -20], [10, 15, -22], [15, 20, -25]
                ],
                lines: [
                    [0, 1], [1, 2], [2, 3], // Dipper handle
                    [3, 4], [4, 5], [5, 6], [6, 3] // Dipper bowl
                ],
                folklore: "Known as the Great Bear, or the Big Dipper in North America, this constellation has many myths. In one Greek myth, it represents Callisto, a nymph turned into a bear by Zeus to protect her from Hera's wrath.",
                encyclopedic: "Ursa Major is a large constellation and asterism visible primarily in the Northern Hemisphere. It is widely recognized for its 'Big Dipper' shape. Its stars are significant for celestial navigation, as the two pointer stars in the Dipper's bowl point to Polaris, the North Star.",
                prominentStars: [{ name: "Dubhe (Alpha Ursae Majoris)", type: "Orange Giant" }, { name: "Alioth (Epsilon Ursae Majoris)", type: "White Main-sequence" }],
                externalLink: "https://en.wikipedia.org/wiki/Ursa_Major"
            },
            {
                name: "Orion", color: 0x00FFFF, angleOffset: 300, // Near Sagittarius/Capricornus, but off-ecliptic
                stars: [
                    [-15, 5, 20], [-10, 10, 18], [-5, -5, 22], [0, 0, 25],
                    [5, -5, 23], [10, 10, 19], [15, 5, 21],
                    [-2, 2, 24], [2, -2, 26] // Orion's Belt
                ],
                lines: [
                    [0, 1], [1, 3], [6, 3],
                    [3, 2], [2, 4], [4, 5],
                    [7, 3], [3, 8] // Connecting lines for Orion's Belt
                ],
                folklore: "In Greek mythology, Orion was a giant hunter whom Zeus placed among the stars as the constellation Orion. He is often depicted pursuing the Pleiades sisters or fighting Taurus the Bull.",
                encyclopedic: "Orion is one of the most prominent and recognizable constellations in the night sky, visible throughout the world. Its brightest stars are Rigel (a blue supergiant) and Betelgeuse (a red supergiant). It contains the famous Orion Nebula, a stellar nursery.",
                prominentStars: [{ name: "Rigel (Beta Orionis)", type: "Blue Supergiant" }, { name: "Betelgeuse (Alpha Orionis)", type: "Red Supergiant" }],
                externalLink: "https://en.wikipedia.org/wiki/Orion"
            },
            {
                name: "Cassiopeia", color: 0xFF69B4, angleOffset: 60, // Near Gemini/Cancer, but off-ecliptic
                stars: [
                    [30, 10, 5], [35, 15, 8], [40, 10, 5], [45, 15, 8], [50, 10, 5]
                ],
                lines: [
                    [0, 1], [1, 2], [2, 3], [3, 4] // W shape
                ],
                folklore: "In Greek mythology, Cassiopeia was the vain queen of Aethiopia, who boasted that she was more beautiful than the Nereids (sea nymphs). This angered Poseidon, who sent the sea monster Cetus to ravage her kingdom as punishment.",
                encyclopedic: "Cassiopeia is a constellation in the northern sky, easily recognizable by its distinct 'W' or 'M' shape, depending on the season and time of night. It is circumpolar for much of the Northern Hemisphere, meaning it never sets below the horizon.",
                prominentStars: [{ name: "Schedar (Alpha Cassiopeiae)", type: "Orange Giant" }, { name: "Caph (Beta Cassiopeiae)", type: "White Giant" }],
                externalLink: "https://en.wikipedia.org/wiki/Cassiopeia_(constellation)"
            },
            {
                name: "Canis Major", color: 0x87CEFA, angleOffset: 200, // Near Scorpius
                stars: [
                    [0, 0, 0], [2, -1, 0], [4, 0, 0], [3, -2, 0], [1, -3, 0]
                ],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 0]],
                folklore: "Canis Major, the 'Greater Dog,' is often depicted as Orion's hunting dog. It is home to Sirius, the brightest star in the night sky, sometimes called the 'Dog Star.'",
                encyclopedic: "Canis Major is a constellation in the southern celestial hemisphere. Its most prominent feature is the star Sirius (Alpha Canis Majoris), which is not only the brightest star in the constellation but also the brightest star visible from Earth.",
                prominentStars: [{ name: "Sirius (Alpha Canis Majoris)", type: "Blue-white Main-sequence Binary" }, { name: "Adhara (Epsilon Canis Majoris)", type: "Blue Giant" }],
                externalLink: "https://en.wikipedia.org/wiki/Canis_Major"
            },
            {
                name: "Cygnus", color: 0xFFFFFF, angleOffset: 250, // Near Ophiuchus/Sagittarius
                stars: [
                    [0, 0, 0], [1, 2, 0], [3, 1, 0], [2, -1, 0], [4, -2, 0], [0, -3, 0]
                ],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 0], [1, 3]], // Cross shape
                folklore: "Cygnus represents the swan in Greek mythology, often associated with Zeus disguising himself as a swan to seduce Leda, or with Orpheus's transformation into a swan after his death to be reunited with his lyre in the sky.",
                encyclopedic: "Cygnus, the Swan, is a prominent constellation in the Northern Hemisphere's summer sky. It is easily recognizable by its bright star Deneb and the asterism known as the Northern Cross. It lies on the Milky Way and contains many notable deep-sky objects, including the Cygnus X-1 black hole.",
                prominentStars: [{ name: "Deneb (Alpha Cygni)", type: "Blue-white Supergiant" }, { name: "Albireo (Beta Cygni)", type: "Double Star" }],
                externalLink: "https://en.wikipedia.org/wiki/Cygnus_(constellation)"
            }
        ];

        // --- Glossary Data ---
        const GLOSSARY_TERMS = [
            { term: "Absolute Zero", definition: "The lowest possible temperature, where all molecular motion ceases. It is 0 Kelvin or -273.15 degrees Celsius." },
            { term: "Accretion Disk", definition: "A disc-shaped flow of gas, dust, or other matter spiraling inward towards a massive central object, such as a star or black hole." },
            { term: "Asterism", definition: "A prominent pattern of stars, often with a popular name, that is not an official constellation but is part of one or more constellations (e.g., the Big Dipper within Ursa Major)." },
            { term: "Astronomical Unit (AU)", definition: "The average distance between the Earth and the Sun, approximately 149.6 million kilometers (93 million miles). Used for measuring distances within our solar system." },
            { term: "Aurora", definition: "A natural light display in the Earth's sky, predominantly seen in the high-latitude regions (around the Arctic and Antarctic). Caused by solar wind particles interacting with the Earth's magnetic field." },
            { term: "Big Bang", definition: "The prevailing cosmological model for the universe from the earliest known periods through its subsequent large-scale evolution. Describes how the universe expanded from a very high-density and high-temperature state." },
            { term: "Binary Star", definition: "A star system consisting of two stars orbiting around their common barycenter. They are very common in the universe." },
            { term: "Celestial Sphere", definition: "An imaginary sphere concentric with the Earth, on which all celestial bodies appear to be located. Used as a practical tool for spherical astronomy." },
            { term: "Dark Matter", definition: "A hypothetical form of matter that is thought to account for approximately 27% of the mass-energy of the universe. It cannot be seen directly with telescopes; its presence is inferred from its gravitational effects." },
            { term: "Dark Energy", definition: "A hypothetical form of energy that exerts a negative, repulsive pressure, accounting for approximately 68% of the universe's mass-energy and thought to be responsible for the accelerating expansion of the universe." },
            { term: "Dwarf Galaxy", definition: "A small galaxy composed of up to several billion stars, a small number compared to our own Milky Way Galaxy, which has 200–400 billion stars." },
            { term: "Eclipse", definition: "An astronomical event that occurs when an astronomical object is temporarily obscured, either by passing into the shadow of another body or by having another body pass between it and the observer." },
            { term: "Ecliptic", definition: "The plane of Earth's orbit around the Sun. From Earth, it is the apparent path of the Sun across the celestial sphere over the course of a year." },
            { term: "Event Horizon", definition: "The boundary around a black hole beyond which no information, not even light, can escape to an outside observer. It's the 'point of no return'." },
            { term: "Galaxy Cluster", definition: "A structure that consists of anywhere from hundreds to thousands of galaxies that are bound together by gravity." },
            { term: "Gravitational Lensing", definition: "A phenomenon predicted by Einstein's theory of general relativity, where light from a distant source is bent and magnified by the gravity of an intermediate massive object (like a galaxy or cluster) acting as a lens." },
            { term: "Light Curve", definition: "A graph showing the variation in the brightness of a celestial object or region over time. Often used to detect exoplanets (transit method) or study variable stars." },
            { term: "Magnetosphere", definition: "The region around an astronomical object in which charged particles are controlled by that object's magnetic field." },
            { term: "Milky Way Galaxy", definition: "The galaxy containing our Solar System. It is a barred spiral galaxy with a diameter between 100,000 and 180,000 light-years." },
            { term: "Neutron Star", definition: "The collapsed core of a massive supergiant star, which had a total initial mass between 10 and 29 solar masses, at the end of its life cycle." },
            { term: "Orbit", definition: "The gravitationally curved trajectory of an object, such as a planet or moon, around a point in space, for example, the center of a star system." },
            { term: "Parsec", definition: "A unit of length used to measure large distances to objects outside our Solar System. One parsec is approximately 3.26 light-years." },
            { term: "Planetary Nebula", definition: "A type of emission nebula consisting of an expanding, glowing shell of ionized gas ejected from a dying red giant star late in its life." },
            { term: "Pulsar", definition: "A highly magnetized rotating neutron star that emits beams of electromagnetic radiation out of its magnetic poles." },
            { term: "Quasar", definition: "An extremely luminous active galactic nucleus, powered by a supermassive black hole. They are among the most distant and brightest objects in the known universe." },
            { term: "Red Dwarf", definition: "A small and cool star, usually with a mass less than half that of the Sun. They are the most common type of star in the Milky Way." },
            { term: "Red Shift", definition: "The phenomenon where electromagnetic radiation (such as light) from an object undergoes an increase in wavelength. In astronomy, it is primarily used to describe how galaxies appear to be moving away from us due to the expansion of the universe." },
            { term: "Singularity", definition: "In astrophysics, a point in spacetime where the gravitational field becomes infinite, such as at the center of a black hole." },
            { term: "Solar Flare", definition: "A sudden flash of increased brightness on the Sun, usually observed near its surface and in close proximity to a sunspot group. They are the most powerful explosive events in the Solar System." },
            { term: "Spectral Type", definition: "A classification of stars based on their spectral characteristics, which are indicative of the star's surface temperature and chemical composition." },
            { term: "Stellar Nucleosynthesis", definition: "The process by which elements are created within stars by combining lighter nuclei into heavier nuclei, up to iron. Heavier elements are formed during supernova explosions." },
            { term: "Terraforming", definition: "The hypothetical process of deliberately modifying the atmosphere, temperature, surface topography, or ecology of a planet, moon, or other body to make it habitable for Earth-like life." },
            { term: "White Dwarf", definition: "A stellar remnant composed mostly of electron-degenerate matter. It is very dense, with a mass comparable to the Sun's, but a volume comparable to Earth's." },
            { term: "Wormhole", definition: "A hypothetical topological feature of spacetime that would fundamentally be a 'shortcut' through spacetime. It is often visualized as a tunnel connecting two distant points." },
            { term: "Zodiac", definition: "A belt of the celestial sphere extending 9 degrees on either side of the ecliptic, containing the paths of the Sun, Moon, and principal planets. It is divided into twelve astrological signs." }
        ];

        // --- Did You Know Facts Data ---
        const DID_YOU_KNOW_FACTS = [
            "A day on Venus is longer than its year.",
            "There are more stars in the universe than grains of sand on all the beaches on Earth.",
            "The largest known star, UY Scuti, is about 1,700 times wider than the Sun.",
            "Footprints on the Moon will stay there for 100 million years.",
            "The Sun is so big that approximately 1.3 million Earths could fit inside it.",
            "Neutron stars can spin at a rate of 600 rotations per second.",
            "If you could fly a plane to Pluto, it would take over 800 years.",
            "The Milky Way galaxy is estimated to contain 100-400 billion stars.",
            "The universe is thought to be around 13.8 billion years old.",
            "There is a planet made of diamonds, 55 Cancri e, twice the size of Earth.",
            "Jupiter's Great Red Spot is a storm larger than Earth and has been raging for centuries."
        ];


        // --- Quiz Variables ---
        let quizData = {
            easy: [
                {
                    question: "Which planet is known as the 'Red Planet'?",
                    options: ["Earth", "Mars", "Jupiter", "Venus"],
                    answer: "Mars"
                },
                {
                    question: "What is the largest planet in our solar system?",
                    options: ["Mars", "Earth", "Saturn", "Jupiter"],
                    answer: "Jupiter"
                },
                {
                    question: "Which celestial body causes tides on Earth?",
                    options: ["The Sun", "Mars", "The Moon", "Venus"],
                    answer: "The Moon"
                },
                {
                    question: "What is a group of stars forming a recognizable pattern called?",
                    options: ["Galaxy", "Nebula", "Constellation", "Asteroid"],
                    answer: "Constellation"
                },
                {
                    question: "What is the common name for a 'shooting star'?",
                    options: ["Comet", "Meteor", "Asteroid", "Satellite"],
                    answer: "Meteor"
                }
            ],
            medium: [
                {
                    question: "Which galaxy is our solar system a part of?",
                    options: ["Andromeda", "Triangulum", "Pinwheel", "Milky Way"],
                    answer: "Milky Way"
                },
                {
                    question: "What force keeps planets in orbit around the Sun?",
                    options: ["Magnetism", "Air Pressure", "Gravity", "Friction"],
                    answer: "Gravity"
                },
                {
                    question: "What is the name of the nearest star to Earth?",
                    options: ["Sirius", "Alpha Centauri", "Proxima Centauri", "Vega"],
                    answer: "Proxima Centauri"
                },
                {
                    question: "Which planet has a prominent system of rings?",
                    options: ["Jupiter", "Uranus", "Neptune", "Saturn"],
                    answer: "Saturn"
                },
                {
                    question: "What is the term for a star that has collapsed into a very dense object, from which nothing, not even light, can escape?",
                    options: ["Neutron Star", "Red Giant", "White Dwarf", "Black Hole"],
                    answer: "Black Hole"
                }
            ],
            hard: [
                {
                    question: "What is the approximate age of the Universe?",
                    options: ["4.5 billion years", "13.8 billion years", "7.2 billion years", "20 billion years"],
                    answer: "13.8 billion years"
                },
                {
                    question: "Which space telescope was launched in 1990 and revolutionized our understanding of the universe?",
                    options: ["James Webb", "Kepler", "Hubble", "Chandra"],
                    answer: "Hubble"
                },
                {
                    question: "What is the coldest known temperature in the universe?",
                    options: ["Absolute Zero", "Cosmic Microwave Background (CMB)", "Boiling point of liquid nitrogen", "Surface of Pluto"],
                    answer: "Absolute Zero"
                },
                {
                    question: "The hypothetical boundary around a black hole beyond which no events can affect an outside observer is called the:",
                    options: ["Singularity", "Accretion Disk", "Event Horizon", "Schwarzschild Radius"],
                    answer: "Event Horizon"
                },
                {
                    question: "What is the phenomenon where light from distant galaxies is stretched to longer, redder wavelengths as the universe expands?",
                    options: ["Blue Shift", "Gravitational Lensing", "Red Shift", "Cosmic Radiation"],
                    answer: "Red Shift"
                }
            ]
        };

        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedQuizLevel = '';

        // --- DOM Elements for Quiz ---
        const quizLevelSelection = document.getElementById('quiz-level-selection');
        const quizContainer = document.getElementById('quiz-container');
        const quizScoreDisplay = document.getElementById('quiz-score');
        const quizQuestionDisplay = document.getElementById('quiz-question');
        const quizOptionsContainer = document.getElementById('quiz-options');
        const quizFeedbackDisplay = document.getElementById('quiz-feedback');
        const quizNextButton = document.getElementById('quiz-next-btn');
        const quizResetButton = document.getElementById('quiz-reset-btn');


        // --- Space Calendar Variables ---
        let currentCalendarDate = new Date(); // Current date displayed in calendar
        // Sample Space Events data (Expanded to include more historical events)
        const SPACE_EVENTS = [
            { date: "2025-07-20", title: "Apollo 11 Anniversary", description: "56 years since humans first walked on the Moon.", category: "Anniversary" },
            { date: "2025-07-28", title: "Perseid Meteor Shower Peak", description: "One of the brightest meteor showers of the year, visible after midnight.", category: "Meteor Shower" },
            { date: "2025-08-01", title: "Mars Sample Return Launch Window Opens", description: "Start of the launch window for the next Mars mission.", category: "Launch" },
            { date: "2025-08-15", title: "Jupiter Opposition", description: "Jupiter will be directly opposite the Sun, appearing brightest in the night sky.", category: "Alignment" },
            { date: "2025-09-05", title: "Voyager 1 Anniversary", description: "48 years since Voyager 1 launched, carrying humanity's message to the stars.", category: "Anniversary" },
            { date: "2025-09-22", title: "Autumnal Equinox", description: "Astronomical start of Autumn in the Northern Hemisphere.", category: "Astronomical" },
            { date: "2025-10-10", title: "Draconid Meteor Shower", description: "Minor meteor shower, best viewed in the early evening.", category: "Meteor Shower" },
            { date: "2025-11-17", title: "Leonid Meteor Shower Peak", description: "Another active meteor shower, known for potential meteor storms every 33 years.", category: "Meteor Shower" },
            { date: "2025-12-21", title: "Winter Solstice", description: "Astronomical start of Winter in the Northern Hemisphere.", category: "Astronomical" },
            { date: "2026-01-03", title: "Quadrantid Meteor Shower", description: "One of the most active but short-lived meteor showers of the year.", category: "Meteor Shower" },
            { date: "2026-02-18", title: "Perseverance Rover Anniversary on Mars", description: "4 years since the rover landed on Mars.", category: "Anniversary" },
            // Additional historical events for diverse dates
            { date: "1969-07-20", title: "Apollo 11 Moon Landing", description: "First humans land on the Moon (Neil Armstrong, Buzz Aldrin).", category: "Historic Mission" },
            { date: "1976-07-20", title: "Viking 1 Lands on Mars", description: "First successful landing of a U.S. spacecraft on Mars.", category: "Historic Mission" },
            { date: "1962-02-20", title: "John Glenn Orbits Earth", description: "First American to orbit Earth aboard Friendship 7.", category: "Historic Flight" },
            { date: "1990-04-24", title: "Hubble Space Telescope Launched", description: "Deployment of the iconic space telescope.", category: "Launch" },
            { date: "1971-05-30", title: "Mariner 9 Launched", description: "First spacecraft to orbit another planet (Mars).", category: "Launch" },
            { date: "1977-09-05", title: "Voyager 1 Launched", description: "Longest-operating and most distant spacecraft.", category: "Launch" },
            { date: "2006-01-19", title: "New Horizons Launched", description: "Mission to Pluto and the Kuiper Belt.", category: "Launch" },
            { date: "1957-10-04", title: "Sputnik 1 Launched", description: "First artificial Earth satellite.", category: "Historic Launch" },
            { date: "1961-04-12", title: "Yuri Gagarin First Man in Space", description: "First human spaceflight, Vostok 1.", category: "Historic Flight" },
            { date: "2000-11-02", title: "ISS Expedition 1 Arrives", description: "First resident crew arrives at the International Space Station.", category: "Space Station" },
            { date: "1965-03-18", title: "Alexei Leonov First Spacewalk", description: "First person to perform a spacewalk.", category: "Historic Spacewalk" },
            { date: "2012-08-06", title: "Curiosity Rover Lands on Mars", description: "NASA's large rover lands in Gale Crater on Mars.", category: "Historic Mission" },
            { date: "1966-02-03", title: "Luna 9 First Soft Moon Landing", description: "Soviet probe achieves first soft landing on the Moon.", category: "Historic Mission" },
            { date: "1986-01-28", title: "Challenger Disaster", description: "Space Shuttle Challenger breaks apart 73 seconds after launch.", category: "Tragedy" },
            { date: "2003-02-01", title: "Columbia Disaster", description: "Space Shuttle Columbia disintegrates upon re-entry.", category: "Tragedy" },
            { date: "1970-04-17", title: "Apollo 13 Returns to Earth", description: "Crew safely returns after a critical in-flight anomaly.", category: "Historic Return" },
            { date: "1998-11-20", title: "Zarya Module Launched (ISS)", description: "First module of the International Space Station launched.", category: "Launch" },
            { date: "2004-01-04", title: "Spirit Rover Lands on Mars", description: "NASA's Mars Exploration Rover begins its mission.", category: "Historic Mission" },
            { date: "2004-01-25", title: "Opportunity Rover Lands on Mars", description: "Spirit's twin rover lands, exceeding expectations.", category: "Historic Mission" },
            { date: "1965-11-26", title: "Astro-X (French Satellite) Launched", description: "First French satellite launched, making France the third space power.", category: "Historic Launch" },
            { date: "1972-12-07", title: "Apollo 17 Launched", description: "Last Apollo mission to the Moon.", category: "Historic Mission" },
            { date: "1996-12-04", title: "Mars Pathfinder Launched", description: "First spacecraft to land a rover on Mars.", category: "Launch" },
            { date: "2014-11-12", title: "Philae Lander on Comet", description: "Philae lander touches down on Comet 67P.", category: "Historic Landing" },
            { date: "2005-01-14", title: "Huygens Probe Lands on Titan", description: "Huygens probe successfully lands on Saturn's moon Titan.", category: "Historic Landing" },
            { date: "1981-04-12", title: "First Space Shuttle Flight (Columbia)", description: "STS-1, the inaugural flight of the Space Shuttle program.", category: "Historic Flight" },
            { date: "1963-06-16", title: "Valentina Tereshkova First Woman in Space", description: "Vostok 6 mission, first woman in space.", category: "Historic Flight" }
        ];

        // --- Space History Timeline Data ---
        const SPACE_HISTORY_EVENTS = [
            { date: "October 4, 1957", title: "Sputnik 1 Launched", description: "The Soviet Union launches Sputnik 1, the first artificial Earth satellite, marking the start of the Space Age." },
            { date: "November 3, 1957", title: "Laika in Space", description: "Sputnik 2 carries the dog Laika into orbit, making her the first living creature to orbit Earth." },
            { date: "January 31, 1958", title: "Explorer 1 Launched", description: "The United States launches its first satellite, Explorer 1, discovering the Van Allen radiation belts." },
            { date: "April 12, 1961", title: "Yuri Gagarin First Man in Space", description: "Soviet cosmonaut Yuri Gagarin becomes the first human in space, completing one orbit of Earth aboard Vostok 1." },
            { date: "May 5, 1961", title: "Alan Shepard First American in Space", description: "Astronaut Alan Shepard becomes the first American in space aboard Freedom 7." },
            { date: "February 20, 1962", title: "John Glenn Orbits Earth", description: "John Glenn becomes the first American to orbit Earth aboard Friendship 7." },
            { date: "June 16, 1963", title: "Valentina Tereshkova First Woman in Space", description: "Valentina Tereshkova becomes the first woman in space aboard Vostok 6." },
            { date: "March 18, 1965", title: "Alexei Leonov First Spacewalk", description: "Soviet cosmonaut Alexei Leonov performs the first spacewalk." },
            { date: "July 20, 1969", title: "Apollo 11 Moon Landing", description: "Neil Armstrong and Buzz Aldrin become the first humans to walk on the Moon." },
            { date: "April 19, 1971", title: "Salyut 1 Launched", description: "The Soviet Union launches Salyut 1, the first space station." },
            { date: "December 2, 1971", title: "Mars 3 Lands on Mars", description: "The Soviet Mars 3 probe becomes the first to achieve a soft landing on Mars, though it transmitted for only 20 seconds." },
            { date: "December 7, 1972", title: "Apollo 17 Launched", description: "Apollo 17, the last mission of the Apollo program, launches to the Moon." },
            { date: "August 20, 1977", title: "Voyager 2 Launched", description: "NASA launches Voyager 2, which would later visit all four outer planets (Jupiter, Saturn, Uranus, Neptune)." },
            { date: "September 5, 1977", title: "Voyager 1 Launched", description: "NASA launches Voyager 1, now the farthest human-made object from Earth." },
            { date: "April 12, 1981", title: "First Space Shuttle Flight (Columbia)", description: "The Space Shuttle Columbia launches on STS-1, the first flight of NASA's Space Shuttle program." },
            { date: "January 28, 1986", title: "Challenger Disaster", description: "The Space Shuttle Challenger breaks apart 73 seconds after launch, killing all seven astronauts." },
            { date: "April 24, 1990", title: "Hubble Space Telescope Launched", description: "The Hubble Space Telescope is launched into orbit, revolutionizing astronomy." },
            { date: "November 20, 1998", title: "ISS Zarya Module Launched", description: "The first module of the International Space Station (ISS), Zarya, is launched by Russia." },
            { date: "November 2, 2000", title: "ISS Expedition 1 Arrives", description: "The first resident crew arrives at the International Space Station, beginning continuous human presence in orbit." },
            { date: "February 1, 2003", title: "Columbia Disaster", description: "The Space Shuttle Columbia disintegrates upon re-entry, killing all seven astronauts." },
            { date: "January 4, 2004", title: "Spirit Rover Lands on Mars", description: "NASA's Spirit rover lands on Mars, beginning its extended mission to explore the Martian surface." },
            { date: "August 6, 2012", title: "Curiosity Rover Lands on Mars", description: "NASA's Curiosity rover successfully lands on Mars to investigate its habitability." },
            { date: "November 12, 2014", title: "Philae Lander on Comet", description: "The Rosetta mission's Philae lander touches down on Comet 67P/Churyumov-Gerasimenko, the first soft landing on a comet." },
            { date: "July 14, 2015", title: "New Horizons Pluto Flyby", description: "NASA's New Horizons spacecraft performs a close flyby of Pluto, providing the first detailed images." },
            { date: "December 20, 2020", title: "Hayabusa2 Returns Samples", description: "Japan's Hayabusa2 spacecraft returns samples from asteroid Ryugu to Earth." },
            { date: "February 18, 2021", title: "Perseverance Rover Lands on Mars", description: "NASA's Perseverance rover successfully lands in Jezero Crater on Mars, carrying the Ingenuity helicopter." },
            { date: "December 25, 2021", title: "James Webb Space Telescope Launched", description: "The James Webb Space Telescope, the premier observatory of the next decade, is launched." }
        ];

        // --- DOM Elements for Calendar ---
        const currentMonthYearDisplay = document.getElementById('currentMonthYear');
        const calendarDaysContainer = document.getElementById('calendarDays');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');

        // --- DOM Elements for Modal ---
        const eventModal = document.getElementById('eventModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalEventTitle = document.getElementById('modalEventTitle');
        const modalEventDate = document.getElementById('modalEventDate');
        const modalEventDescription = document.getElementById('modalEventDescription');
        const modalMoonPhase = document.getElementById('modalMoonPhase'); // New element for moon phase in modal
        const llmStoryLoading = document.getElementById('llmStoryLoading');

        // --- DOM Elements for Planet Info Popup ---
        const planetMass = document.getElementById('planetMass');
        const planetDiameter = document.getElementById('planetDiameter');
        const planetAvgTemp = document.getElementById('planetAvgTemp');
        const planetOrbitalPeriod = document.getElementById('planetOrbitalPeriod');
        const planetRotationPeriod = document.getElementById('planetRotationPeriod');
        const planetMoons = document.getElementById('planetMoons');
        const planetAtmosphere = document.getElementById('planetAtmosphere');

        // --- DOM Elements for Glossary ---
        const glossaryContainer = document.getElementById('glossary-container');
        const glossaryFilterInput = document.getElementById('glossaryFilterInput');

        // --- DOM Elements for Space History Timeline ---
        const timelineContainer = document.getElementById('timeline-container');

        // --- DOM Elements for Did You Know Facts ---
        const didYouKnowFactContent = document.getElementById('didYouKnowFactContent');
        const didYouKnowPopup = document.getElementById('didYouKnowPopup');
        const nextFactBtn = document.getElementById('nextFactBtn');
        const closeFactBtn = document.getElementById('closeFactBtn');
        const headerTooltip = document.getElementById('headerTooltip');
        const siteTitle = document.getElementById('site-title');

        // --- DOM Elements for Moon Phases Diagram ---
        const moonPhaseSlider = document.getElementById('moonPhaseSlider');
        const moonPhaseLabel = document.getElementById('moonPhaseLabel');

        // --- DOM Elements for Eclipses Diagram ---
        const eclipseSlider = document.getElementById('eclipseSlider');
        const eclipseLabel = document.getElementById('eclipseLabel');


        // --- Multi-Page Navigation Logic ---
        const mainContentContainer = document.getElementById('main-content-container');
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.content-section');

        function showSection(targetId) {
            sections.forEach(section => {
                if (section.id === targetId) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
            // Update URL hash
            window.location.hash = targetId;

            // Manage Three.js scenes based on active section
            if (targetId === 'solar-system-section') {
                if (!solarSystemInitialized) {
                    solarSystemLoadingOverlay = document.getElementById('solarSystemLoadingOverlay');
                    solarSystemLoadingOverlay.style.display = 'flex';
                    setTimeout(() => {
                        initSolarSystem();
                        animateSolarSystem(); // Start animation loop
                        solarSystemInitialized = true;
                    }, 100);
                } else {
                    // Ensure the correct canvas is visible and handling events
                    document.getElementById('solarSystemCanvas').style.display = 'block';
                    onWindowResize(); // Adjust size if window changed
                }
                // Hide other canvases if active
                if (constellationsInitialized) { document.getElementById('constellationsCanvas').style.display = 'none'; }
                if (moonPhaseInitialized) { document.getElementById('moonPhasesCanvas').style.display = 'none'; }
                if (eclipsesInitialized) { document.getElementById('eclipsesCanvas').style.display = 'none'; }
                
                // Clear highlights/popups from other scenes
                if (solarSystemPreviouslyClickedObject) {
                    solarSystemPreviouslyClickedObject.material.emissive.setHex(solarSystemPreviouslyClickedObject.userData.originalEmissive);
                    solarSystemPreviouslyClickedObject = null;
                }
                if (planetInfoPopup) {
                    planetInfoPopup.classList.remove('show');
                    planetInfoPopup.classList.add('hidden');
                }
                if (previouslyClickedConstellationStar) {
                    const previousConstellationName = previouslyClickedConstellationStar.userData.name;
                    constellationsGroup.children.forEach(group => {
                        if (group instanceof THREE.Group) {
                            group.children.forEach(child => {
                                if (child.isMesh && child.geometry.type === 'SphereGeometry' && child.userData.name === previousConstellationName) {
                                    if (child.material && child.material.emissive) {
                                        child.material.emissive.setHex(child.userData.originalEmissive);
                                    }
                                }
                            });
                        }
                    });
                    previouslyClickedConstellationStar = null;
                }
                if (constellationInfoPopup) {
                    constellationInfoPopup.classList.remove('show');
                    constellationInfoPopup.classList.add('hidden');
                }

            } else if (targetId === 'constellations-section') {
                if (!constellationsInitialized) {
                    constellationsLoadingOverlay = document.getElementById('constellationsLoadingOverlay');
                    constellationsLoadingOverlay.style.display = 'flex';
                    setTimeout(() => {
                        initConstellations();
                        animateConstellations(); // Start animation loop
                        constellationsInitialized = true;
                    }, 100);
                } else {
                    // Ensure the correct canvas is visible and handling events
                    document.getElementById('constellationsCanvas').style.display = 'block';
                    onWindowResize(); // Adjust size if window changed
                }
                // Hide other canvases if active
                if (solarSystemInitialized) { document.getElementById('solarSystemCanvas').style.display = 'none'; }
                if (moonPhaseInitialized) { document.getElementById('moonPhasesCanvas').style.display = 'none'; }
                if (eclipsesInitialized) { document.getElementById('eclipsesCanvas').style.display = 'none'; }

                // Clear highlights/popups from other scenes (similar to above)
                if (solarSystemPreviouslyClickedObject) {
                    solarSystemPreviouslyClickedObject.material.emissive.setHex(solarSystemPreviouslyClickedObject.userData.originalEmissive);
                    solarSystemPreviouslyClickedObject = null;
                }
                if (planetInfoPopup) {
                    planetInfoPopup.classList.remove('show');
                    planetInfoPopup.classList.add('hidden');
                }
                if (previouslyClickedConstellationStar) {
                    const previousConstellationName = previouslyClickedConstellationStar.userData.name;
                    constellationsGroup.children.forEach(group => {
                        if (group instanceof THREE.Group) {
                            group.children.forEach(child => {
                                if (child.isMesh && child.geometry.type === 'SphereGeometry' && child.userData.name === previousConstellationName) {
                                    if (child.material && child.material.emissive) {
                                        child.material.emissive.setHex(child.userData.originalEmissive);
                                    }
                                }
                            });
                        }
                    });
                    previouslyClickedConstellationStar = null;
                }
                if (constellationInfoPopup) {
                    constellationInfoPopup.classList.remove('show');
                    constellationInfoPopup.classList.add('hidden');
                }

            } else if (targetId === 'interactive-concepts-section') {
                // Moon Phases
                if (!moonPhaseInitialized) {
                    moonPhaseLoadingOverlay = document.getElementById('moonPhasesLoadingOverlay');
                    moonPhaseLoadingOverlay.style.display = 'flex';
                    setTimeout(() => {
                        initMoonPhases();
                        animateMoonPhases(); // Start animation loop
                        moonPhaseInitialized = true;
                    }, 100);
                } else {
                    document.getElementById('moonPhasesCanvas').style.display = 'block';
                    onWindowResize(); // Adjust size if window changed
                }
                // Eclipses
                if (!eclipsesInitialized) {
                    eclipsesLoadingOverlay = document.getElementById('eclipsesLoadingOverlay');
                    eclipsesLoadingOverlay.style.display = 'flex';
                    setTimeout(() => {
                        initEclipses();
                        animateEclipses(); // Start animation loop
                        eclipsesInitialized = true;
                    }, 100);
                } else {
                    document.getElementById('eclipsesCanvas').style.display = 'block';
                    onWindowResize(); // Adjust size if window changed
                }

                // Hide other canvases
                if (solarSystemInitialized) { document.getElementById('solarSystemCanvas').style.display = 'none'; }
                if (constellationsInitialized) { document.getElementById('constellationsCanvas').style.display = 'none'; }

                // Clear highlights/popups from other scenes
                if (solarSystemPreviouslyClickedObject) {
                    solarSystemPreviouslyClickedObject.material.emissive.setHex(solarSystemPreviouslyClickedObject.userData.originalEmissive);
                    solarSystemPreviouslyClickedObject = null;
                }
                if (planetInfoPopup) {
                    planetInfoPopup.classList.remove('show');
                    planetInfoPopup.classList.add('hidden');
                }
                if (previouslyClickedConstellationStar) {
                    const previousConstellationName = previouslyClickedConstellationStar.userData.name;
                    constellationsGroup.children.forEach(group => {
                        if (group instanceof THREE.Group) {
                            group.children.forEach(child => {
                                if (child.isMesh && child.geometry.type === 'SphereGeometry' && child.userData.name === previousConstellationName) {
                                    if (child.material && child.material.emissive) {
                                        child.material.emissive.setHex(child.userData.originalEmissive);
                                    }
                                }
                            });
                        }
                    });
                    previouslyClickedConstellationStar = null;
                }
                if (constellationInfoPopup) {
                    constellationInfoPopup.classList.remove('show');
                    constellationInfoPopup.classList.add('hidden');
                }

            } else {
                // For other sections, ensure all canvases are hidden
                if (solarSystemInitialized) {
                    document.getElementById('solarSystemCanvas').style.display = 'none';
                    // Clear highlight and popup
                    if (solarSystemPreviouslyClickedObject) {
                        solarSystemPreviouslyClickedObject.material.emissive.setHex(solarSystemPreviouslyClickedObject.userData.originalEmissive);
                        solarSystemPreviouslyClickedObject = null;
                    }
                    if (planetInfoPopup) {
                        planetInfoPopup.classList.remove('show');
                        planetInfoPopup.classList.add('hidden');
                    }
                }
                if (constellationsInitialized) {
                    document.getElementById('constellationsCanvas').style.display = 'none';
                     // Also clear constellation highlight and popup if active
                     if (previouslyClickedConstellationStar) {
                        const previousConstellationName = previouslyClickedConstellationStar.userData.name;
                        constellationsGroup.children.forEach(group => {
                            if (group instanceof THREE.Group) {
                                group.children.forEach(child => {
                                    if (child.isMesh && child.geometry.type === 'SphereGeometry' && child.userData.name === previousConstellationName) {
                                        if (child.material && child.material.emissive) {
                                            child.material.emissive.setHex(child.userData.originalEmissive);
                                        }
                                    }
                                });
                            }
                        });
                        previouslyClickedConstellationStar = null;
                     }
                     if (constellationInfoPopup) {
                        constellationInfoPopup.classList.remove('show');
                        constellationInfoPopup.classList.add('hidden');
                     }
                }
                if (moonPhaseInitialized) {
                    document.getElementById('moonPhasesCanvas').style.display = 'none';
                }
                if (eclipsesInitialized) {
                    document.getElementById('eclipsesCanvas').style.display = 'none';
                }
            }

            // Specific rendering for new sections
            if (targetId === 'glossary-section') {
                renderGlossary();
            } else if (targetId === 'space-history-section') {
                renderSpaceHistoryTimeline();
            }
            // Update "Did You Know?" fact on section change
            displayRandomDidYouKnowFact();
        }

        // Event listeners for navigation links
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent default anchor link behavior
                const targetId = e.target.dataset.target;
                if (targetId) {
                    showSection(targetId);
                }
            });
        });

        // Handle initial load and hash changes
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.substring(1); // Remove the '#'
            if (hash) {
                showSection(hash);
            } else {
                showSection('intro-section'); // Default to intro if no hash
            }
        });

        // --- Three.js Initialization Function (Solar System) ---
        function initSolarSystem() {
            // Get canvas and container
            const canvas = document.getElementById('solarSystemCanvas');
            const container = document.getElementById('solarSystemCanvas-container');
            solarSystemLoadingOverlay = document.getElementById('solarSystemLoadingOverlay');
            const zoomSensitivitySlider = document.getElementById('zoomSensitivity');
            const timeWarpSlider = document.getElementById('timeWarp'); // New: Time warp slider
            const toggleAxialTiltCheckbox = document.getElementById('toggleAxialTilt'); // New: Axial tilt toggle

            // Initialize DOM elements for planet info pop-up
            planetInfoPopup = document.getElementById('planetInfoPopup');
            popupPlanetName = document.getElementById('popupPlanetName');
            popupPlanetFacts = document.getElementById('popupPlanetFacts');
            
            // Assign new DOM elements for detailed info
            // (These are already declared globally)

            // Hide loading overlay once initialization begins
            solarSystemLoadingOverlay.style.display = 'none';

            // Scene setup
            solarSystemScene = new THREE.Scene();
            // Add a higher-density starfield background
            const solarBackgroundGeometry = new THREE.SphereGeometry(500, 32, 32);
            const solarBackgroundMaterial = new THREE.MeshBasicMaterial({
                map: sharedStarfieldTexture,
                side: THREE.BackSide,
                color: 0xAAAAAA // Dimmed slightly
            });
            solarSystemStarsBackground = new THREE.Mesh(solarBackgroundGeometry, solarBackgroundMaterial);
            solarSystemScene.add(solarSystemStarsBackground);


            // Camera setup
            solarSystemCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            solarSystemCamera.position.set(0, 10, 25); // Initial camera position
            solarSystemCamera.lookAt(0, 0, 0); // Look at the origin (where the sun will be)

            // Renderer setup
            solarSystemRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            solarSystemRenderer.setSize(container.clientWidth, 600); // Set initial size
            solarSystemRenderer.setPixelRatio(window.devicePixelRatio); // Optimize for high-DPI screens

            // Sun (now part of PLANET_DATA for consistency in pop-up logic)
            const sunData = PLANET_DATA.find(p => p.name === 'Sun');
            // Store original emissive color from PLANET_DATA for the Sun
            const sunMaterial = new THREE.MeshBasicMaterial({ color: sunData.color, emissive: sunData.emissiveColor, emissiveIntensity: sunData.emissiveIntensity });
            sun = new THREE.Mesh(new THREE.SphereGeometry(sunData.radius, 32, 32), sunMaterial);
            sun.name = "Sun"; // Assign a name for raycasting
            sun.userData = sunData; // Store all data in userData
            solarSystemScene.add(sun);

            // Light source (from the sun) - adjusted intensity
            const pointLight = new THREE.PointLight(0xffffff, 3, 1000); // White light, increased intensity
            sun.add(pointLight); // Attach light to the sun so it moves with it (though sun is static here)

            // Ambient light to ensure planets are visible
            const ambientLight = new THREE.AmbientLight(0x404040); // Soft white light
            solarSystemScene.add(ambientLight);

            // Planets and their orbits
            PLANET_DATA.forEach(data => {
                if (data.name === 'Sun') return; // Sun is handled separately

                const planetGroup = new THREE.Group(); // Group for planet + label + potential rings + moons
                solarSystemScene.add(planetGroup);

                // Use MeshPhongMaterial for better lighting interaction (specular, shininess)
                const planetMaterial = new THREE.MeshPhongMaterial({
                    color: data.color,
                    emissive: data.emissiveColor || 0x000000,
                    emissiveIntensity: data.emissiveIntensity || 0,
                    specular: 0x333333, // Reflective highlight color
                    shininess: 10 // How 'shiny' the surface is
                });
                const planet = new THREE.Mesh(new THREE.SphereGeometry(data.radius, 64, 64), planetMaterial); // Higher segments for smoother sphere
                planet.name = data.name; // Assign name for raycasting
                planet.userData = { ...data, originalAxialTilt: data.axialTilt }; // Store all data and original axial tilt
                
                planetGroup.add(planet); // Add planet mesh to its group
                planets.push({ mesh: planet, data: data, angle: 0, group: planetGroup }); // Store mesh, data, angle, and group

                // Create orbital path
                const orbitGeometry = new THREE.RingGeometry(data.distance - 0.02, data.distance + 0.02, 128); // More segments
                const orbitMaterial = new THREE.MeshBasicMaterial({ color: 0x333333, side: THREE.DoubleSide });
                const orbit = new THREE.Mesh(orbitGeometry, orbitMaterial);
                orbit.rotation.x = Math.PI / 2; // Rotate to lie flat on XZ plane
                solarSystemScene.add(orbit);
                orbitLines.push(orbit); // Store orbit line for toggling

                // Add planet name label
                const textCanvas = document.createElement('canvas');
                const context = textCanvas.getContext('2d');
                const fontSize = 48; // Adjust font size
                context.font = `Bold ${fontSize}px Inter`; // Use Inter font
                context.fillStyle = `white`;
                const textWidth = context.measureText(data.name).width;
                textCanvas.width = textWidth + 20;
                textCanvas.height = fontSize + 20;
                context.font = `Bold ${fontSize}px Inter`;
                context.fillStyle = `white`;
                context.fillText(data.name, 10, fontSize + 5);

                const texture = new THREE.CanvasTexture(textCanvas);
                const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
                const sprite = new THREE.Sprite(spriteMaterial);
                sprite.scale.set(textCanvas.width * 0.02, textCanvas.height * 0.02, 1);
                sprite.position.set(0, data.radius + 0.3, 0); // Position label above the planet relative to its local origin
                planet.add(sprite); // Attach label to planet so it rotates with it

                // Add Saturn's rings (enhanced)
                if (data.name === 'Saturn') {
                    const ringGeometryOuter = new THREE.RingGeometry(data.radius * 1.2, data.radius * 2.0, 64);
                    const ringGeometryInner = new THREE.RingGeometry(data.radius * 0.8, data.radius * 1.1, 64); // Inner ring
                    const ringMaterial = new THREE.MeshBasicMaterial({ color: 0x969696, side: THREE.DoubleSide });

                    const ringsOuter = new THREE.Mesh(ringGeometryOuter, ringMaterial);
                    const ringsInner = new THREE.Mesh(ringGeometryInner, ringMaterial);

                    ringsOuter.rotation.x = Math.PI / 2;
                    ringsInner.rotation.x = Math.PI / 2;
                    
                    // Tilt the rings relative to the planet's own axis
                    // These rings will be children of the planet mesh, so their rotation is relative.
                    // The planet's axial tilt is applied to planet.rotation.z
                    
                    planet.add(ringsOuter); // Add rings to the planet mesh
                    planet.add(ringsInner);
                }

                // Add Earth's atmosphere and clouds
                if (data.name === 'Earth') {
                    // Atmosphere (slight glow/transparency)
                    const atmosphereGeometry = new THREE.SphereGeometry(data.radius * 1.05, 64, 64);
                    const atmosphereMaterial = new THREE.MeshPhongMaterial({
                        color: 0x87CEEB, // Sky blue
                        transparent: true,
                        opacity: 0.2,
                        side: THREE.BackSide // Render inside the atmosphere sphere
                    });
                    const atmosphere = new THREE.Mesh(atmosphereGeometry, atmosphereMaterial);
                    planet.add(atmosphere);

                    // Clouds (procedural texture)
                    const cloudsGeometry = new THREE.SphereGeometry(data.radius * 1.02, 64, 64);
                    const cloudsMaterial = new THREE.MeshStandardMaterial({
                        map: earthCloudTexture,
                        transparent: true,
                        opacity: 0.6,
                        alphaMap: earthCloudTexture, // Use the same texture for alpha to make transparent parts
                        side: THREE.DoubleSide // Render both sides
                    });
                    const clouds = new THREE.Mesh(cloudsGeometry, cloudsMaterial);
                    clouds.name = "EarthClouds"; // Give a name to rotate it independently
                    planet.add(clouds);
                }
            });

            // Add Moons
            const moons = []; // New array to store moon meshes for updating
            MOON_DATA.forEach(moonData => {
                const parentPlanet = planets.find(p => p.name === moonData.parent);
                if (parentPlanet) {
                    const moonMaterial = new THREE.MeshPhongMaterial({
                        color: moonData.color,
                        specular: 0x111111,
                        shininess: 5
                    });
                    const moonMesh = new THREE.Mesh(new THREE.SphereGeometry(moonData.radius, 32, 32), moonMaterial);
                    moonMesh.name = moonData.name; // Assign name for raycasting
                    moonMesh.userData = moonData; // Store all moon data
                    moonMesh.userData.originalEmissive = 0x000000; // For highlighting

                    moonMesh.userData.orbitalAngle = Math.random() * Math.PI * 2; // Random starting angle
                    
                    parentPlanet.mesh.add(moonMesh); // Add moon as child of its parent planet mesh
                    moons.push({ mesh: moonMesh, data: moonData });
                }
            });

            // Meteors (simple random spheres)
            const numMeteors = 100;
            const meteorGeometry = new THREE.SphereGeometry(0.05, 8, 8);
            const meteorMaterial = new THREE.MeshBasicMaterial({ color: 0xFFFFFF }); 
            for (let i = 0; i < numMeteors; i++) {
                const meteor = new THREE.Mesh(meteorGeometry, meteorMaterial);
                // Random position within a certain range
                meteor.position.set(
                    (Math.random() - 0.5) * 50,
                    (Math.random() - 0.5) * 50,
                    (Math.random() - 0.5) * 50
                );
                // Store initial velocity for movement
                meteor.velocity = new THREE.Vector3(
                    (Math.random() - 0.5) * 0.02,
                    (Math.random() - 0.5) * 0.02,
                    (Math.random() - 0.5) * 0.02
                );
                solarSystemScene.add(meteor);
                meteors.push(meteor);
            }

            // Event Listeners for Camera Control
            let rotateSpeed = 0.005;

            canvas.addEventListener('mousedown', (e) => {
                solarSystemIsDragging = true;
                solarSystemPreviousMouseX = e.clientX;
                solarSystemPreviousMouseY = e.clientY;
            });

            canvas.addEventListener('mouseup', () => {
                solarSystemIsDragging = false;
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!solarSystemIsDragging) return;

                const deltaX = e.clientX - solarSystemPreviousMouseX;
                const deltaY = e.clientY - solarSystemPreviousMouseY;

                // Rotate camera around the origin
                const spherical = new THREE.Spherical().setFromVector3(solarSystemCamera.position);
                spherical.theta -= deltaX * rotateSpeed;
                spherical.phi -= deltaY * rotateSpeed;

                // Restrict vertical rotation to prevent flipping
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));

                solarSystemCamera.position.setFromSpherical(spherical);
                solarSystemCamera.lookAt(0, 0, 0); // Always look at the center of the solar system

                solarSystemPreviousMouseX = e.clientX;
                solarSystemPreviousMouseY = e.clientY;
            });

            canvas.addEventListener('wheel', (e) => {
                e.preventDefault(); // Prevent page scrolling

                const zoomFactor = solarSystemZoomSensitivity * 0.005; // Base sensitivity
                const zoomAmount = e.deltaY * solarSystemCamera.position.length() * zoomFactor; 
                let newDistance = solarSystemCamera.position.length() + zoomAmount;

                const minDistance = 2; // Closer minimum distance
                const maxDistance = 200; // Further maximum distance

                newDistance = Math.max(minDistance, Math.min(maxDistance, newDistance));

                solarSystemCamera.position.setLength(newDistance);
                solarSystemCamera.lookAt(0, 0, 0);
            });

            // Event Listener for object interaction (click)
            canvas.addEventListener('click', onSolarSystemCanvasClick);

            // Handle window resizing
            window.addEventListener('resize', onWindowResize);
            // onWindowResize(); // Called by showSection now

            // Zoom Sensitivity Slider Listener
            zoomSensitivitySlider.addEventListener('input', (event) => {
                solarSystemZoomSensitivity = parseFloat(event.target.value);
            });

            // Time Warp Slider Listener
            timeWarpSlider.addEventListener('input', (event) => {
                timeWarpFactor = parseFloat(event.target.value);
            });

            // Axial Tilt Toggle Listener
            toggleAxialTiltCheckbox.addEventListener('change', (event) => {
                showAxialTilt = event.target.checked;
                planets.forEach(p => {
                    if (p.mesh.name !== 'Sun') { // Don't apply to sun
                        p.mesh.rotation.z = showAxialTilt ? p.data.axialTilt : 0;
                    }
                });
                moons.forEach(m => {
                    m.mesh.rotation.z = showAxialTilt ? m.data.axialTilt : 0;
                });
            });

            solarSystemLoadingOverlay.style.display = 'none'; // Hide overlay once everything is rendered
        }

        // Raycasting for planet/moon info pop-up and highlighting
        function onSolarSystemCanvasClick(event) {
            event.preventDefault();

            // Calculate mouse position in normalized device coordinates (-1 to +1)
            const canvas = document.getElementById('solarSystemCanvas');
            const rect = canvas.getBoundingClientRect();
            solarSystemMouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            solarSystemMouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            // Update the raycaster with the camera and mouse position
            solarSystemRaycaster.setFromCamera(solarSystemMouse, solarSystemCamera);

            // Collect all identifiable meshes (planets + sun + moons) for raycasting
            const interactableObjects = [sun];
            planets.forEach(p => {
                interactableObjects.push(p.mesh);
                // Also add moons of this planet
                p.mesh.children.forEach(child => {
                    if (child.isMesh && MOON_DATA.some(m => m.name === child.name)) {
                        interactableObjects.push(child);
                    }
                });
            });

            // Calculate objects intersecting the ray
            const intersects = solarSystemRaycaster.intersectObjects(interactableObjects);

            let clickedCelestialBody = null;
            if (intersects.length > 0) {
                // The first intersected object is the closest one
                clickedCelestialBody = intersects[0].object;
            }

            // --- Highlighting Logic ---
            if (solarSystemPreviouslyClickedObject) {
                // Revert previously clicked object's emissive color to its original state
                const originalColor = solarSystemPreviouslyClickedObject.userData.originalEmissive;
                if (solarSystemPreviouslyClickedObject.material.emissive) {
                    solarSystemPreviouslyClickedObject.material.emissive.setHex(originalColor);
                }
            }

            if (clickedCelestialBody) {
                // Highlight the newly clicked object
                if (clickedCelestialBody.material.emissive) {
                    clickedCelestialBody.material.emissive.setHex(HIGHLIGHT_COLOR); // HIGHLIGHT_COLOR is now 0x000000
                }
                solarSystemPreviouslyClickedObject = clickedCelestialBody; // Store for next click

                // Display planet/moon info popup
                const bodyData = clickedCelestialBody.userData; // Get all data from userData
                if (bodyData) {
                    popupPlanetName.textContent = bodyData.name;
                    popupPlanetFacts.textContent = bodyData.facts;
                    planetMass.textContent = bodyData.mass || 'N/A';
                    planetDiameter.textContent = bodyData.diameter || 'N/A';
                    planetAvgTemp.textContent = bodyData.avgTemp || 'N/A';
                    planetOrbitalPeriod.textContent = bodyData.orbitalPeriod || 'N/A';
                    planetRotationPeriod.textContent = bodyData.rotationPeriod || 'N/A';
                    planetMoons.textContent = bodyData.moons || 'N/A';
                    planetAtmosphere.textContent = bodyData.atmosphere || 'N/A';
                    
                    // Position the popup near the clicked object
                    const vector = new THREE.Vector3();
                    clickedCelestialBody.getWorldPosition(vector);
                    vector.project(solarSystemCamera);

                    const x = (vector.x * .5 + .5) * canvas.offsetWidth;
                    const y = (-vector.y * .5 + .5) * canvas.offsetHeight;

                    planetInfoPopup.style.left = `${x}px`;
                    planetInfoPopup.style.top = `${y}px`;
                    planetInfoPopup.classList.add('show');
                    planetInfoPopup.classList.remove('hidden'); // Ensure it's not display: none
                }
            } else {
                // No object clicked, hide popup and clear highlight
                planetInfoPopup.classList.remove('show');
                planetInfoPopup.classList.add('hidden');
                solarSystemPreviouslyClickedObject = null; // Clear previously clicked object
            }
        }

        function animateSolarSystem() {
            requestAnimationFrame(animateSolarSystem);

            // Animate planets (orbital and axial rotation)
            planets.forEach(p => {
                // Orbital rotation (affected by timeWarpFactor)
                p.angle += p.data.orbitalSpeed * timeWarpFactor;
                p.group.position.x = p.data.distance * Math.cos(p.angle);
                p.group.position.z = p.data.distance * Math.sin(p.angle);

                // Axial rotation (affected by timeWarpFactor)
                p.mesh.rotation.y += p.data.rotationSpeed * timeWarpFactor;
                
                // Earth's clouds rotation
                if (p.name === 'Earth') {
                    const clouds = p.mesh.children.find(c => c.name === 'EarthClouds');
                    if (clouds) {
                        clouds.rotation.y += (p.data.rotationSpeed * timeWarpFactor * 0.8); // Clouds rotate slightly slower
                    }
                }
                
                // Apply axial tilt if toggled
                if (p.name !== 'Sun') { // Do not tilt the sun
                    p.mesh.rotation.z = showAxialTilt ? p.data.axialTilt : 0;
                }
            });

            // Animate Moons (orbital and axial rotation)
            const allMoons = [];
            planets.forEach(p => {
                p.mesh.children.forEach(child => {
                    if (child.isMesh && MOON_DATA.some(m => m.name === child.name)) {
                        allMoons.push({ mesh: child, data: child.userData });
                    }
                });
            });

            allMoons.forEach(m => {
                // Orbital rotation around parent planet
                m.data.orbitalAngle += m.data.orbitalSpeed * timeWarpFactor;
                m.mesh.position.x = m.data.distance * Math.cos(m.data.orbitalAngle);
                m.mesh.position.z = m.data.distance * Math.sin(m.data.orbitalAngle);

                // Axial rotation
                m.mesh.rotation.y += m.data.rotationSpeed * timeWarpFactor;

                // Apply axial tilt if toggled
                m.mesh.rotation.z = showAxialTilt ? m.data.axialTilt : 0;
            });


            // Animate meteors
            meteors.forEach(meteor => {
                meteor.position.add(meteor.velocity.clone().multiplyScalar(timeWarpFactor)); // Meteors also affected by time warp

                // Simple boundary check for meteors to keep them within a reasonable area
                if (meteor.position.length() > 30) {
                    // Reset meteor position if it goes too far
                    meteor.position.set(
                        (Math.random() - 0.5) * 50,
                        (Math.random() - 0.5) * 50,
                        (Math.random() - 0.5) * 50
                    );
                }
            });

            solarSystemRenderer.render(solarSystemScene, solarSystemCamera);
        }

        // --- Three.js Initialization Function (Constellations) ---
        function initConstellations() {
            const canvas = document.getElementById('constellationsCanvas');
            const container = document.getElementById('constellationsCanvas-container');
            constellationsLoadingOverlay = document.getElementById('constellationsLoadingOverlay');

            // Initialize DOM elements for constellation info pop-up
            constellationInfoPopup = document.getElementById('constellationInfoPopup');
            constellationPopupName = document.getElementById('constellationPopupName');
            constellationPopupFolklore = document.getElementById('constellationPopupFolklore');
            constellationPopupEncyclopedic = document.getElementById('constellationPopupEncyclopedic');
            constellationProminentStars = document.getElementById('constellationProminentStars');
            constellationExternalLink = document.getElementById('constellationExternalLink');


            constellationsLoadingOverlay.style.display = 'none';

            constellationsScene = new THREE.Scene();
            // Add a higher-density starfield background
            const constellationsBackgroundGeometry = new THREE.SphereGeometry(500, 32, 32);
            const constellationsBackgroundMaterial = new THREE.MeshBasicMaterial({
                map: sharedStarfieldTexture,
                side: THREE.BackSide,
                color: 0xAAAAAA
            });
            constellationsStarsBackground = new THREE.Mesh(constellationsBackgroundGeometry, constellationsBackgroundMaterial);
            constellationsScene.add(constellationsStarsBackground);

            constellationsCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            constellationsCamera.position.set(0, 20, 50); // Initial camera position for constellations
            constellationsCamera.lookAt(0, 0, 0);

            constellationsRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            constellationsRenderer.setSize(container.clientWidth, 600);
            constellationsRenderer.setPixelRatio(window.devicePixelRatio);

            // Add Sun at the center for constellations view (more stylized)
            const constellationsSunMaterial = new THREE.MeshBasicMaterial({ color: 0xFDB813, emissive: 0xFDB813, emissiveIntensity: 0.5 });
            constellationsSun = new THREE.Mesh(new THREE.SphereGeometry(3, 32, 32), constellationsSunMaterial); // Larger sun for visual emphasis
            constellationsScene.add(constellationsSun);

            // Add Earth orbiting the Sun in the constellation view
            const constellationsEarthMaterial = new THREE.MeshPhongMaterial({ color: 0x10B981, specular: 0x555555, shininess: 20 });
            constellationsEarth = new THREE.Mesh(new THREE.SphereGeometry(0.8, 32, 32), constellationsEarthMaterial); // Earth size relative to sun
            constellationsEarth.position.set(10, 0, 0); // Initial position for Earth
            constellationsScene.add(constellationsEarth);
            constellationsEarth.userData.orbitalAngle = 0; // Custom property to track orbital angle
            constellationsEarth.userData.orbitalRadius = 10; // Radius of Earth's orbit
            constellationsEarth.userData.orbitalSpeed = 0.005; // Speed of Earth's orbit

            // Add light to the constellation scene (from the sun)
            const constellationsPointLight = new THREE.PointLight(0xffffff, 2, 200);
            constellationsSun.add(constellationsPointLight); // Attach light to the sun
            const constellationsAmbientLight = new THREE.AmbientLight(0x404040);
            constellationsScene.add(constellationsAmbientLight);


            // Group for all constellations
            constellationsGroup = new THREE.Group();
            constellationsScene.add(constellationsGroup);

            // Parameters for circular arrangement
            const zodiacOrbitRadius = 40; // How far constellations are from the center
            const constellationScale = 0.8; // Scale down individual constellation shapes

            ZODIAC_CONSTELLATION_DATA.forEach(constellation => {
                const starMeshes = []; // Store star meshes for adding to scene and connecting

                // Calculate position for the constellation group itself
                const angleRad = (constellation.angleOffset * Math.PI) / 180;
                // Add some vertical offset (Y-axis) to avoid all constellations being on the exact same plane if desired, and to better represent the image
                const groupY = (Math.random() - 0.5) * 10; // Random vertical offset
                const groupX = zodiacOrbitRadius * Math.cos(angleRad);
                const groupZ = zodiacOrbitRadius * Math.sin(angleRad);

                const constellationIndividualGroup = new THREE.Group();
                constellationIndividualGroup.position.set(groupX, groupY, groupZ);
                constellationIndividualGroup.rotation.y = -angleRad + Math.PI / 2; // Orient constellation towards center (approx)
                constellationsGroup.add(constellationIndividualGroup);


                constellation.stars.forEach(sPos => {
                    const starGeometry = new THREE.SphereGeometry(0.5, 32, 32); // Higher segments for stars
                    const starMaterial = new THREE.MeshPhongMaterial({
                        color: constellation.color,
                        emissive: constellation.color, // Stars should emit light
                        emissiveIntensity: 0.5, // Brighter emissive
                        specular: 0xFFFFFF,
                        shininess: 100
                    }); 
                    const star = new THREE.Mesh(starGeometry, starMaterial);
                    
                    // Position relative to the constellation's group origin, scaled
                    star.position.set(sPos[0] * constellationScale, sPos[1] * constellationScale, sPos[2] * constellationScale);
                    star.name = constellation.name; // Assign constellation name to star for identification
                    star.userData = constellation; // Store all constellation data in userData
                    // Store original emissive color for highlighting revert
                    star.userData.originalEmissive = constellation.color;
                    constellationIndividualGroup.add(star); // Add star to its individual constellation group
                    starMeshes.push(star);
                });

                // Draw lines connecting stars using indices (relative to constellation group)
                const linePoints = [];
                constellation.lines.forEach(lineIndices => {
                    const startStar = starMeshes[lineIndices[0]];
                    const endStar = starMeshes[lineIndices[1]];
                    if (startStar && endStar) {
                        linePoints.push(startStar.position, endStar.position);
                    }
                });

                if (linePoints.length > 0) {
                    const lineGeometry = new THREE.BufferGeometry().setFromPoints(linePoints);
                    const lineMaterial = new THREE.LineBasicMaterial({ color: constellation.color, linewidth: 3 }); // Thicker lines
                    const constellationLine = new THREE.LineSegments(lineGeometry, lineMaterial); // Use LineSegments for disconnected lines
                    constellationIndividualGroup.add(constellationLine); // Add lines to its individual constellation group
                }
            });

            // Camera controls for constellations
            const canvasConstellations = document.getElementById('constellationsCanvas');
            let rotateSpeedConstellations = 0.005;
            let zoomSpeedConstellations = 0.5;

            canvasConstellations.addEventListener('mousedown', (e) => {
                constellationsIsDragging = true;
                constellationsPreviousMouseX = e.clientX;
                constellationsPreviousMouseY = e.clientY;
            });

            canvasConstellations.addEventListener('mouseup', () => {
                constellationsIsDragging = false;
            });

            canvasConstellations.addEventListener('mousemove', (e) => {
                if (!constellationsIsDragging) return;

                const deltaX = e.clientX - constellationsPreviousMouseX;
                const deltaY = e.clientY - constellationsPreviousMouseY;

                const spherical = new THREE.Spherical().setFromVector3(constellationsCamera.position);
                spherical.theta -= deltaX * rotateSpeedConstellations;
                spherical.phi -= deltaY * rotateSpeedConstellations;
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));

                constellationsCamera.position.setFromSpherical(spherical);
                constellationsCamera.lookAt(0, 0, 0);

                constellationsPreviousMouseX = e.clientX;
                constellationsPreviousMouseY = e.clientY;
            });

            canvasConstellations.addEventListener('wheel', (e) => {
                e.preventDefault();

                const zoomFactor = zoomSpeedConstellations * 0.01;
                let newDistance = constellationsCamera.position.length() + e.deltaY * zoomFactor * constellationsCamera.position.length();

                const minDistance = 10;
                const maxDistance = 100;
                newDistance = Math.max(minDistance, Math.min(maxDistance, newDistance));

                constellationsCamera.position.setLength(newDistance);
                constellationsCamera.lookAt(0, 0, 0);
            });

            // Event Listener for object interaction (click) for constellations
            canvasConstellations.addEventListener('click', onConstellationCanvasClick);
        }

        // Raycasting for constellation info pop-up and highlighting
        function onConstellationCanvasClick(event) {
            event.preventDefault();

            const canvas = document.getElementById('constellationsCanvas');
            const rect = canvas.getBoundingClientRect();
            constellationsMouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            constellationsMouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            constellationsRaycaster.setFromCamera(constellationsMouse, constellationsCamera);

            // We need to check all stars within the constellationsGroup
            // Find all stars to make them clickable (they are nested within individual constellation groups)
            const clickableStars = [];
            constellationsGroup.children.forEach(constellationIndividualGroup => {
                if (constellationIndividualGroup instanceof THREE.Group) { // Ensure it's a group
                    constellationIndividualGroup.children.forEach(child => {
                        if (child.isMesh && child.geometry.type === 'SphereGeometry') { // Ensure it's a star mesh
                            clickableStars.push(child);
                        }
                    });
                }
            });


            const intersects = constellationsRaycaster.intersectObjects(clickableStars);

            let clickedConstellationStar = null;
            if (intersects.length > 0) {
                // Get the closest intersected star
                clickedConstellationStar = intersects[0].object;
            }

            // --- Highlighting Logic ---
            // First, reset any previously highlighted constellation
            if (previouslyClickedConstellationStar) {
                // Find all stars belonging to the previously clicked constellation
                const previousConstellationName = previouslyClickedConstellationStar.userData.name;
                constellationsGroup.children.forEach(group => {
                    if (group instanceof THREE.Group) {
                        group.children.forEach(child => {
                            if (child.isMesh && child.geometry.type === 'SphereGeometry' && child.userData.name === previousConstellationName) {
                                // Defensive check added here
                                if (child.material && child.material.emissive) {
                                    child.material.emissive.setHex(child.userData.originalEmissive);
                                }
                            }
                        });
                    }
                });
            }


            if (clickedConstellationStar) {
                // Highlight all stars belonging to the newly clicked constellation
                const currentConstellationName = clickedConstellationStar.userData.name;
                constellationsGroup.children.forEach(group => {
                    if (group instanceof THREE.Group) {
                        group.children.forEach(child => {
                            if (child.isMesh && child.geometry.type === 'SphereGeometry' && child.userData.name === currentConstellationName) {
                                // Defensive check added here
                                if (child.material && child.material.emissive) {
                                    // Set emissive to highlight color (now 0x000000)
                                    child.material.emissive.setHex(CONSTELLATION_HIGHLIGHT_COLOR);
                                }
                            }
                        });
                    }
                });

                previouslyClickedConstellationStar = clickedConstellationStar; // Store one of the stars from the current constellation

                // Display constellation info popup
                const constellationData = clickedConstellationStar.userData; // Get all data from userData
                if (constellationData) {
                    constellationPopupName.textContent = constellationData.name;
                    constellationPopupFolklore.textContent = constellationData.folklore;
                    constellationPopupEncyclopedic.textContent = constellationData.encyclopedic;
                    
                    constellationProminentStars.innerHTML = ''; // Clear previous list
                    if (constellationData.prominentStars && constellationData.prominentStars.length > 0) {
                        constellationData.prominentStars.forEach(star => {
                            const li = document.createElement('li');
                            li.textContent = `${star.name} (${star.type})`;
                            constellationProminentStars.appendChild(li);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.textContent = 'N/A';
                        constellationProminentStars.appendChild(li);
                    }

                    if (constellationData.externalLink) {
                        constellationExternalLink.href = constellationData.externalLink;
                        constellationExternalLink.style.display = 'inline-block';
                    } else {
                        constellationExternalLink.style.display = 'none';
                    }
                    
                    // Position the popup near the clicked star
                    const vector = new THREE.Vector3();
                    clickedConstellationStar.getWorldPosition(vector);
                    vector.project(constellationsCamera);

                    const x = (vector.x * .5 + .5) * canvas.offsetWidth;
                    const y = (-vector.y * .5 + .5) * canvas.offsetHeight;

                    constellationInfoPopup.style.left = `${x}px`;
                    constellationInfoPopup.style.top = `${y}px`;
                    constellationInfoPopup.classList.add('show');
                    constellationInfoPopup.classList.remove('hidden'); // Ensure it's not display: none
                }
            } else {
                // No object clicked, hide popup and clear highlight
                constellationInfoPopup.classList.remove('show');
                constellationInfoPopup.classList.add('hidden');
                previouslyClickedConstellationStar = null; // Clear previously clicked object
            }
        }

        function animateConstellations() {
            requestAnimationFrame(animateConstellations);

            // Animate Earth's orbit around the constellations Sun
            if (constellationsEarth) {
                constellationsEarth.userData.orbitalAngle += constellationsEarth.userData.orbitalSpeed;
                constellationsEarth.position.x = constellationsEarth.userData.orbitalRadius * Math.cos(constellationsEarth.userData.orbitalAngle);
                constellationsEarth.position.z = constellationsEarth.userData.orbitalRadius * Math.sin(constellationsEarth.userData.orbitalAngle);
            }

            // Optional: Rotate the entire zodiac ring slowly
            if (constellationsGroup) {
                constellationsGroup.rotation.y += 0.0002;
            }
            
            constellationsRenderer.render(constellationsScene, constellationsCamera);
        }

        // --- Three.js Initialization Function (Moon Phases) ---
        function initMoonPhases() {
            const canvas = document.getElementById('moonPhasesCanvas');
            const container = document.getElementById('moonPhasesCanvas-container');
            moonPhaseLoadingOverlay = document.getElementById('moonPhasesLoadingOverlay');

            moonPhaseLoadingOverlay.style.display = 'none';

            moonPhaseScene = new THREE.Scene();
            moonPhaseScene.background = new THREE.Color(0x000000); // Reverted to black background

            moonPhaseCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 100);
            moonPhaseCamera.position.set(0, 5, 10); // Camera looking at the Earth-Moon system
            moonPhaseCamera.lookAt(0, 0, 0);

            moonPhaseRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            moonPhaseRenderer.setSize(container.clientWidth, 600);
            moonPhaseRenderer.setPixelRatio(window.devicePixelRatio);

            // Sun Light (directional, simulating distant sun)
            sunLightMoonPhase = new THREE.DirectionalLight(0xffffff, 2); // White light, strong intensity
            sunLightMoonPhase.position.set(10, 0, 0); // Light coming from the right (simulating the sun)
            moonPhaseScene.add(sunLightMoonPhase);

            // Ambient light to prevent total darkness on shadowed side
            const ambientLightMoonPhase = new THREE.AmbientLight(0x333333); // Soft ambient light
            moonPhaseScene.add(ambientLightMoonPhase);

            // Earth
            const earthGeometry = new THREE.SphereGeometry(1.5, 64, 64);
            const earthMaterial = new THREE.MeshPhongMaterial({ color: 0x0066FF }); // Blue color for Earth
            earthMoonPhase = new THREE.Mesh(earthGeometry, earthMaterial);
            moonPhaseScene.add(earthMoonPhase);

            // Moon
            const moonGeometry = new THREE.SphereGeometry(0.5, 64, 64);
            // Use a material that reacts to light
            const moonMaterial = new THREE.MeshPhongMaterial({ color: 0x888888 }); // Gray color for Moon
            moon = new THREE.Mesh(moonGeometry, moonMaterial);
            earthMoonPhase.add(moon); // Moon orbits Earth

            // Orbit Path for the Moon around Earth
            const moonOrbitRadius = 3;
            const orbitCurve = new THREE.EllipseCurve(
                0,  0,            // ax, aY
                moonOrbitRadius, moonOrbitRadius, // xRadius, yRadius
                0,  2 * Math.PI,  // aStartAngle, aEndAngle
                false,            // aClockwise
                0                 // aRotation
            );
            const orbitPoints = orbitCurve.getPoints(100);
            const orbitGeometry = new THREE.BufferGeometry().setFromPoints(orbitPoints);
            const orbitMaterial = new THREE.LineBasicMaterial({ color: 0x555555 });
            const moonOrbitLine = new THREE.Line(orbitGeometry, orbitMaterial);
            moonOrbitLine.rotation.x = Math.PI / 2; // Rotate to lie flat
            earthMoonPhase.add(moonOrbitLine); // Add orbit line to Earth group

            // Initial Moon Position based on slider
            updateMoonPhaseVisual(moonPhaseSlider.value);

            // Add event listener for the slider
            moonPhaseSlider.addEventListener('input', (event) => {
                moonPhaseCurrentAngle = parseFloat(event.target.value);
                updateMoonPhaseVisual(moonPhaseCurrentAngle);
            });
        }

        function updateMoonPhaseVisual(angleDegrees) {
            // Calculate moon's position around Earth
            const moonOrbitRadius = 3;
            const angleRadians = THREE.MathUtils.degToRad(angleDegrees);
            moon.position.x = moonOrbitRadius * Math.cos(angleRadians);
            moon.position.z = moonOrbitRadius * Math.sin(angleRadians); // Z instead of Y to keep it horizontal

            // Rotate the moon to always face the camera (simplification for phase visualization)
            // Or rotate based on position to simulate tidal locking (more accurate)
            // For phases, we need the "Earth-facing" side to show the phase correctly.
            // A simple approach for showing phases is just adjusting light or material properties,
            // but with a directional light, the phases naturally appear based on relative positions.
            // Let's ensure the moon rotates on its own axis to show its surface,
            // but its *illuminated portion* is determined by the fixed sunLightMoonPhase.

            // To make the visible side of the moon represent the phase from Earth's perspective,
            // the moon itself doesn't need to rotate on its axis for the phase to show up correctly.
            // The phase is entirely determined by the relative angles of Sun, Earth, and Moon.
            // The camera is looking at the Earth-Moon system. The Sun is a fixed light source.

            // Get the phase name
            let phaseName = "";
            let minDiff = Infinity;
            for (let i = 0; i < moonPhaseAngles.length; i++) {
                const diff = Math.abs(angleDegrees - moonPhaseAngles[i]);
                if (diff < minDiff) {
                    minDiff = diff;
                    phaseName = moonPhaseNames[i];
                }
            }
            moonPhaseLabel.textContent = phaseName;
        }


        function animateMoonPhases() {
            requestAnimationFrame(animateMoonPhases);

            // Optional: slight rotation of the whole system for dynamic viewing
            if (moonPhaseScene) {
                moonPhaseScene.rotation.y += 0.001; // Slow overall rotation
            }

            moonPhaseRenderer.render(moonPhaseScene, moonPhaseCamera);
        }

        // --- Three.js Initialization Function (Eclipses) ---
        function initEclipses() {
            const canvas = document.getElementById('eclipsesCanvas');
            const container = document.getElementById('eclipsesCanvas-container');
            eclipsesLoadingOverlay = document.getElementById('eclipsesLoadingOverlay');

            eclipsesLoadingOverlay.style.display = 'none';

            eclipsesScene = new THREE.Scene();
            eclipsesScene.background = new THREE.Color(0x000000); // Reverted to black background

            eclipsesCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 100);
            eclipsesCamera.position.set(0, 5, 20); // Camera position looking at the Earth-Moon-Sun system
            eclipsesCamera.lookAt(0, 0, 0);

            eclipsesRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            eclipsesRenderer.setSize(container.clientWidth, 600);
            eclipsesRenderer.setPixelRatio(window.devicePixelRatio);

            // Sun (light source and visible sphere)
            const sunLightEclipse = new THREE.PointLight(0xffffff, 2); // Bright white light
            sunLightEclipse.position.set(15, 0, 0); // Position the light source
            eclipsesScene.add(sunLightEclipse);

            const sunMaterialEclipse = new THREE.MeshBasicMaterial({ color: 0xFDB813 });
            eclipseSun = new THREE.Mesh(new THREE.SphereGeometry(3, 32, 32), sunMaterialEclipse); // Visible Sun sphere
            eclipseSun.position.set(15, 0, 0);
            eclipsesScene.add(eclipseSun);

            // Earth
            const earthGeometry = new THREE.SphereGeometry(1.5, 64, 64);
            const earthMaterial = new THREE.MeshPhongMaterial({ color: 0x0066FF });
            eclipseEarth = new THREE.Mesh(earthGeometry, earthMaterial);
            eclipseEarth.position.set(0, 0, 0); // Earth at the center
            eclipsesScene.add(eclipseEarth);

            // Moon
            const moonGeometry = new THREE.SphereGeometry(0.5, 32, 32);
            const moonMaterial = new THREE.MeshPhongMaterial({ color: 0x888888 });
            eclipseMoon = new THREE.Mesh(moonGeometry, moonMaterial);
            eclipseMoon.position.set(-5, 0, 0); // Initial position for the Moon
            eclipsesScene.add(eclipseMoon);

            // Earth's Orbit Path around the Sun (conceptual, for alignment)
            const earthOrbitRadius = 15; // Distance of Earth from Sun
            const earthOrbitCurve = new THREE.EllipseCurve(
                0, 0,            // ax, aY
                earthOrbitRadius, earthOrbitRadius, // xRadius, yRadius
                0, 2 * Math.PI,  // aStartAngle, aEndAngle
                false,           // aClockwise
                0                // aRotation
            );
            const earthOrbitPoints = earthOrbitCurve.getPoints(100);
            const earthOrbitGeometry = new THREE.BufferGeometry().setFromPoints(earthOrbitPoints);
            const earthOrbitMaterial = new THREE.LineBasicMaterial({ color: 0x333333 });
            const earthOrbitLine = new THREE.Line(earthOrbitGeometry, earthOrbitMaterial);
            earthOrbitLine.rotation.x = Math.PI / 2; // Rotate to lie flat
            // Offset the orbit to be centered on the sun's actual position (15,0,0)
            earthOrbitLine.position.x = eclipseSun.position.x;
            eclipsesScene.add(earthOrbitLine);

            // Moon's Orbit Path around Earth
            const moonOrbitRadius = 3; // Distance of Moon from Earth
            const moonOrbitCurve = new THREE.EllipseCurve(
                0, 0,            // ax, aY
                moonOrbitRadius, moonOrbitRadius, // xRadius, yRadius
                0, 2 * Math.PI,  // aStartAngle, aEndAngle
                false,           // aClockwise
                0                // aRotation
            );
            const moonOrbitPoints = moonOrbitCurve.getPoints(100);
            const moonOrbitGeometry = new THREE.BufferGeometry().setFromPoints(moonOrbitPoints);
            const moonOrbitMaterial = new THREE.LineBasicMaterial({ color: 0x555555 });
            const moonOrbitLine = new THREE.Line(moonOrbitGeometry, moonOrbitMaterial);
            moonOrbitLine.rotation.x = Math.PI / 2; // Rotate to lie flat
            eclipseEarth.add(moonOrbitLine); // Add to Earth, so it moves with Earth

            // Create shadows (Umbra and Penumbra)
            // Umbra (darkest part of shadow) - cone from moon to earth
            const umbraGeometry = new THREE.ConeGeometry(0.5, 5, 32); // Adjust radius and height
            const umbraMaterial = new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.6, side: THREE.DoubleSide });
            umbraMesh = new THREE.Mesh(umbraGeometry, umbraMaterial);
            umbraMesh.rotation.x = Math.PI / 2; // Orient along Z-axis by default
            eclipsesScene.add(umbraMesh); // Add directly to scene, positions updated in updateEclipsesVisual

            // Penumbra (lighter part of shadow) - wider cone
            const penumbraGeometry = new THREE.ConeGeometry(1.5, 7, 32); // Larger radius and height
            const penumbraMaterial = new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.3, side: THREE.DoubleSide });
            penumbraMesh = new THREE.Mesh(penumbraGeometry, penumbraMaterial);
            penumbraMesh.rotation.x = Math.PI / 2; // Orient along Z-axis by default
            eclipsesScene.add(penumbraMesh); // Add directly to scene

            // Initial positions and update
            updateEclipsesVisual(eclipseSlider.value);

            // Event listener for the slider
            eclipseSlider.addEventListener('input', (event) => {
                eclipseCurrentAngle = parseFloat(event.target.value);
                updateEclipsesVisual(eclipseCurrentAngle);
            });
        }

        function updateEclipsesVisual(angleDegrees) {
            const angleRadians = THREE.MathUtils.degToRad(angleDegrees);

            // Earth's position relative to the Sun (Sun is at (15,0,0) in this scene)
            const earthOrbitRadius = 10; // This is distance from scene origin, not Sun itself for simplicity
            eclipseEarth.position.x = earthOrbitRadius * Math.cos(angleRadians);
            eclipseEarth.position.z = earthOrbitRadius * Math.sin(angleRadians);

            // Moon's position relative to Earth
            const moonOrbitRadius = 3;
            // The moon needs to be on the same "plane" as the sun and earth for eclipses to align.
            // For simplicity, we'll keep it on the same XZ plane, aligning it for eclipses.
            // Solar eclipse: Moon between Sun and Earth (angleDegrees near 0 or 360)
            // Lunar eclipse: Earth between Sun and Moon (angleDegrees near 180)

            // Adjust moon's position relative to Earth to align for eclipses
            // When Earth is at angleRadians, Moon should be at the same angle for Solar, or opposite for Lunar relative to Earth-Sun line.
            // For this diagram, a simpler approach is to make the Moon always directly dependent on the slider to force alignment.

            // The positions for alignment:
            // Sun (15,0,0) -> Earth (earth.x, 0, earth.z)
            // Moon: (moonX, 0, moonZ)

            // To make it interactive with one slider:
            // Slider value 0/360 degrees: Earth is at (earthOrbitRadius, 0, 0).
            // For Solar Eclipse, Moon needs to be between Sun and Earth.
            // Eclipse Sun is at (15,0,0)
            // Eclipse Earth is at (0,0,0) in its own reference frame, but we're moving it in the scene
            // The Moon is child of Earth. Its position relative to Earth is fixed.

            // Re-think: Sun is at a fixed position far left (or right). Earth orbits the Sun. Moon orbits Earth.
            // The slider controls the 'phase' of the moon's orbit *relative to the Earth-Sun line*.
            // Let the Sun be at (-15, 0, 0) for clearer visualization of light path.
            eclipseSun.position.set(-15, 0, 0); // Sun fixed on the left

            const earthDistance = 10;
            eclipseEarth.position.x = earthDistance * Math.cos(angleRadians);
            eclipseEarth.position.z = earthDistance * Math.sin(angleRadians);

            // Moon orbits Earth. Its position relative to Earth is determined by the "eclipse" angle.
            // For a proper solar/lunar alignment, the Moon needs to be on the line connecting Sun and Earth.
            // So, Moon.position = Earth.position + vector_from_Earth_to_Moon.
            // The vector_from_Earth_to_Moon depends on whether it's solar or lunar.

            // Let's make the Moon's orbital angle around Earth correspond to the slider:
            // If angleRadians = 0, Moon is directly between Sun and Earth (Solar Eclipse)
            // If angleRadians = PI, Earth is directly between Sun and Moon (Lunar Eclipse)
            
            // Moon's position relative to Earth (its parent)
            const moonXRelative = moonOrbitRadius * Math.cos(angleRadians + Math.PI); // Offset by PI to put it on the sun-earth line
            const moonZRelative = moonOrbitRadius * Math.sin(angleRadians + Math.PI);

            eclipseMoon.position.set(moonXRelative, 0, moonZRelative); // Set relative to Earth's origin

            // --- Shadow calculations ---
            // The shadow meshes should originate from the Moon and extend towards the Sun.
            // They need to be positioned and oriented correctly.
            // The direction of light is from Sun to Moon.
            const sunToMoonDirection = new THREE.Vector3().subVectors(eclipseMoon.position, eclipseSun.position).normalize();

            // Set Umbra/Penumbra position to be behind the moon, extending away from the sun.
            // The cones point away from the sun, through the moon.
            umbraMesh.position.copy(eclipseMoon.position);
            penumbraMesh.position.copy(eclipseMoon.position);

            // Orient the cones to point along the sunToMoonDirection
            // Use LookAt to point away from the sun.
            const targetForShadows = new THREE.Vector3().copy(eclipseMoon.position).add(sunToMoonDirection.multiplyScalar(10)); // Point 10 units beyond moon
            umbraMesh.lookAt(targetForShadows);
            penumbraMesh.lookAt(targetForShadows);
            
            // Adjust label based on alignment
            let currentEclipseType = eclipseLabels.none;
            const distanceSunMoon = eclipseSun.position.distanceTo(eclipseMoon.position);
            const distanceSunEarth = eclipseSun.position.distanceTo(eclipseEarth.position);
            const distanceMoonEarth = eclipseMoon.position.distanceTo(eclipseEarth.position);

            // Simple alignment check for demonstration purposes
            // Solar: Moon is roughly between Sun and Earth
            // Lunar: Earth is roughly between Sun and Moon

            const tolerance = 1.5; // Tolerance for alignment check

            if (distanceSunEarth - distanceSunMoon - distanceMoonEarth < tolerance && distanceSunEarth - distanceSunMoon - distanceMoonEarth > -tolerance) {
                currentEclipseType = eclipseLabels.solar; // Moon-Earth-Sun roughly aligned
                // If Moon is precisely between Sun and Earth:
                const vectorSunEarth = new THREE.Vector3().subVectors(eclipseEarth.position, eclipseSun.position).normalize();
                const vectorMoonEarth = new THREE.Vector3().subVectors(eclipseEarth.position, eclipseMoon.position).normalize();
                if (vectorSunEarth.dot(vectorMoonEarth) > 0.95) { // Check if directions are similar
                    // Solar eclipse possible
                    umbraMesh.visible = true;
                    penumbraMesh.visible = true;
                    // Position umbra/penumbra to project onto Earth
                    // Calculate intersection point of umbra cone with Earth
                    // For simplification, just show shadows emanating from Moon.
                    // A proper shadow calculation would involve more complex geometry and physics.
                    // For a visual demo, having visible cones is enough.
                } else {
                    umbraMesh.visible = false;
                    penumbraMesh.visible = false;
                }
            } else if (distanceSunMoon - distanceSunEarth - distanceMoonEarth < tolerance && distanceSunMoon - distanceSunEarth - distanceMoonEarth > -tolerance) {
                currentEclipseType = eclipseLabels.lunar; // Earth-Moon-Sun roughly aligned
                 // If Earth is precisely between Sun and Moon:
                const vectorSunMoon = new THREE.Vector3().subVectors(eclipseMoon.position, eclipseSun.position).normalize();
                const vectorEarthMoon = new THREE.Vector3().subVectors(eclipseMoon.position, eclipseEarth.position).normalize();
                if (vectorSunMoon.dot(vectorEarthMoon) > 0.95) { // Check if directions are similar
                    // Lunar eclipse possible
                    umbraMesh.visible = true;
                    penumbraMesh.visible = true;
                } else {
                    umbraMesh.visible = false;
                    penumbraMesh.visible = false;
                }
            } else {
                umbraMesh.visible = false;
                penumbraMesh.visible = false;
            }

            eclipseLabel.textContent = currentEclipseType;
        }


        function animateEclipses() {
            requestAnimationFrame(animateEclipses);

            // Optional: slight rotation of the whole system for dynamic viewing
            if (eclipsesScene) {
                eclipsesScene.rotation.y += 0.001; // Slow overall rotation
            }

            eclipsesRenderer.render(eclipsesScene, eclipsesCamera);
        }


        // --- Shared Window Resize ---
        function onWindowResize() {
            // Solar System Canvas Resize
            const solarSystemCanvas = document.getElementById('solarSystemCanvas');
            const solarSystemContainer = document.getElementById('solarSystemCanvas-container');
            if (solarSystemInitialized && solarSystemCanvas.style.display !== 'none') { // Only resize if initialized and visible
                const newWidth = solarSystemContainer.clientWidth;
                const newHeight = 600;
                solarSystemCamera.aspect = newWidth / newHeight;
                solarSystemCamera.updateProjectionMatrix();
                solarSystemRenderer.setSize(newWidth, newHeight);
            }

            // Constellations Canvas Resize
            const constellationsCanvas = document.getElementById('constellationsCanvas');
            const constellationsContainer = document.getElementById('constellationsCanvas-container');
            if (constellationsInitialized && constellationsCanvas.style.display !== 'none') { // Only resize if initialized and visible
                const newWidth = constellationsContainer.clientWidth;
                const newHeight = 600;
                constellationsCamera.aspect = newWidth / newHeight;
                constellationsCamera.updateProjectionMatrix();
                constellationsRenderer.setSize(newWidth, newHeight);
            }

            // Moon Phases Canvas Resize
            const moonPhasesCanvas = document.getElementById('moonPhasesCanvas');
            const moonPhasesContainer = document.getElementById('moonPhasesCanvas-container');
            if (moonPhaseInitialized && moonPhasesCanvas.style.display !== 'none') {
                const newWidth = moonPhasesContainer.clientWidth;
                const newHeight = 600;
                moonPhaseCamera.aspect = newWidth / newHeight;
                moonPhaseCamera.updateProjectionMatrix();
                moonPhaseRenderer.setSize(newWidth, newHeight);
            }

            // Eclipses Canvas Resize
            const eclipsesCanvas = document.getElementById('eclipsesCanvas');
            const eclipsesContainer = document.getElementById('eclipsesCanvas-container');
            if (eclipsesInitialized && eclipsesCanvas.style.display !== 'none') {
                const newWidth = eclipsesContainer.clientWidth;
                const newHeight = 600;
                eclipsesCamera.aspect = newWidth / newHeight;
                eclipsesCamera.updateProjectionMatrix();
                eclipsesRenderer.setSize(newWidth, newHeight);
            }
        }


        // --- Quiz Functions ---

        // Function to start the quiz with a selected level
        function startQuiz(level) {
            selectedQuizLevel = level;
            currentQuizQuestions = [...quizData[level]]; // Copy to allow shuffling/mutation
            shuffleArray(currentQuizQuestions); // Shuffle questions for variety
            currentQuestionIndex = 0;
            score = 0;

            quizLevelSelection.classList.add('hidden'); // Hide level selection
            quizContainer.classList.remove('hidden'); // Show quiz container
            quizNextButton.classList.remove('hidden'); // Show next button
            quizResetButton.classList.add('hidden'); // Hide reset button initially
            
            displayQuestion();
        }

        // Function to display the current question
        function displayQuestion() {
            quizOptionsContainer.innerHTML = ''; // Clear previous options
            quizFeedbackDisplay.textContent = ''; // Clear feedback
            quizNextButton.classList.add('hidden'); // Hide next button until answer is chosen

            if (currentQuestionIndex < currentQuizQuestions.length) {
                const question = currentQuizQuestions[currentQuestionIndex];
                quizQuestionDisplay.textContent = question.question;
                quizScoreDisplay.textContent = `Score: ${score}`;

                question.options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = 'quiz-option-btn bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-300';
                    button.onclick = () => checkAnswer(option, question.answer);
                    quizOptionsContainer.appendChild(button);
                });
            } else {
                // Quiz finished
                quizQuestionDisplay.textContent = `Quiz Finished! Your final score is: ${score} out of ${currentQuizQuestions.length}`;
                quizOptionsContainer.innerHTML = '';
                quizNextButton.classList.add('hidden'); // Hide next button
                quizResetButton.classList.remove('hidden'); // Show reset button
            }
        }

        // Function to check the selected answer
        function checkAnswer(selectedOption, correctAnswer) {
            // Disable all option buttons after selection
            Array.from(quizOptionsContainer.children).forEach(button => {
                button.disabled = true;
                if (button.textContent === correctAnswer) {
                    button.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                    button.classList.add('bg-green-600'); // Highlight correct answer
                } else if (button.textContent === selectedOption) {
                    button.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                    button.classList.add('bg-red-600'); // Highlight incorrect chosen answer
                }
            });

            if (selectedOption === correctAnswer) {
                score++;
                quizFeedbackDisplay.textContent = "Correct!";
                quizFeedbackDisplay.classList.remove('text-red-400');
                quizFeedbackDisplay.classList.add('text-green-400');
            } else {
                quizFeedbackDisplay.textContent = `Incorrect. The correct answer was: ${correctAnswer}`;
                quizFeedbackDisplay.classList.remove('text-green-400');
                quizFeedbackDisplay.classList.add('text-red-400');
            }
            quizScoreDisplay.textContent = `Score: ${score}`;
            quizNextButton.classList.remove('hidden'); // Show next button to proceed
        }

        // Function to advance to the next question
        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        // Function to reset the quiz
        function resetQuiz() {
            quizContainer.classList.add('hidden'); // Hide quiz container
            quizLevelSelection.classList.remove('hidden'); // Show level selection again
            quizFeedbackDisplay.textContent = ''; // Clear feedback
            quizScoreDisplay.textContent = 'Score: 0';
        }

        // Utility function to shuffle an array (Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- Calendar Functions ---

        /**
         * Calculates the moon phase icon for a given date.
         * A simplified algorithm based on the moon's age in the lunar cycle.
         * @param {number} year - The year.
         * @param {number} month - The month (0-11).
         * @param {number} day - The day of the month.
         * @returns {string} An emoji representing the moon phase.
         */
        function getMoonPhaseIcon(year, month, day) {
            // Calculate Julian date for the given date
            const date = new Date(year, month, day);
            const JD = date.getTime() / 86400000 + 2440587.5; // milliseconds to days + Julian date of Jan 1, 1970

            // Approximate new moon date (Jan 6, 2000, 18:14 UTC in JD)
            const newMoonJD = 2451550.09765;

            const daysSinceNewMoon = JD - newMoonJD;
            const lunarCycleLength = 29.53058867; // Synodic month
            let moonAge = daysSinceNewMoon % lunarCycleLength;
            if (moonAge < 0) moonAge += lunarCycleLength; // Ensure positive

            // Map moon age to phase icon
            if (moonAge < 1.84566) return '🌑 New Moon';
            if (moonAge < 5.53699) return '🌒 Waxing Crescent';
            if (moonAge < 9.22831) return '🌓 First Quarter';
            if (moonAge < 12.91963) return '🌔 Waxing Gibbous';
            if (moonAge < 16.61096) return '🌕 Full Moon';
            if (moonAge < 20.30228) return '🌖 Waning Gibbous';
            if (moonAge < 23.99361) return '🌗 Last Quarter';
            if (moonAge < 27.68493) return '🌘 Waning Crescent';
            return '🌑 New Moon';
        }


        function renderCalendar() {
            calendarDaysContainer.innerHTML = ''; // Clear previous days
            currentMonthYearDisplay.textContent = currentCalendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDayOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const numDaysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday, etc.

            // Add leading empty days for the start of the week
            for (let i = 0; i < firstDayOfWeek; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day', 'other-month');
                calendarDaysContainer.appendChild(dayDiv);
            }

            // Add days of the current month
            for (let day = 1; day <= numDaysInMonth; day++) {
                const dayDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), day);
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day', 'current-month');
                dayDiv.innerHTML = `<div class="calendar-day-number">${day}</div>`;
                dayDiv.dataset.date = dayDate.toISOString().split('T')[0];
                
                // Get moon phase for the current day
                const moonPhase = getMoonPhaseIcon(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate());

                const moonPhaseEl = document.createElement('span');
                moonPhaseEl.classList.add('moon-phase-icon');
                // Extract just the emoji part for display in the calendar cell
                moonPhaseEl.textContent = moonPhase.split(' ')[0]; // Take only the emoji part
                dayDiv.appendChild(moonPhaseEl);


                // Filter events based on exact year, month, and day
                const eventsOnThisDay = SPACE_EVENTS.filter(event => {
                    const eventDate = new Date(event.date);
                    return eventDate.getFullYear() === currentCalendarDate.getFullYear() &&
                           eventDate.getMonth() === currentCalendarDate.getMonth() && // Month is 0-indexed
                           eventDate.getDate() === day;
                }).sort((a, b) => new Date(a.date) - new Date(b.date)); // Sort to ensure consistent order if multiple events


                if (eventsOnThisDay.length > 0) {
                    dayDiv.classList.add('has-event');
                    // Display the first event title as a preview
                    const eventTitleEl = document.createElement('div');
                    eventTitleEl.classList.add('calendar-event-title');
                    // Show title and historical year in preview
                    eventTitleEl.textContent = `${eventsOnThisDay[0].title} (${new Date(eventsOnThisDay[0].date).getFullYear()})`;
                    dayDiv.appendChild(eventTitleEl);

                    // Attach click listener to show modal for the first event, passing moon phase
                    dayDiv.addEventListener('click', () => showEventPopup(eventsOnThisDay[0], moonPhase));
                } else {
                    // Make non-event days also clickable for consistency (optional)
                    dayDiv.addEventListener('click', () => {
                        // For days without events, still show the modal with just the moon phase
                        const clickedDate = new Date(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate());
                        showEventPopup({
                            title: `No major events`,
                            date: clickedDate.toISOString().split('T')[0], // Format toYYYY-MM-DD
                            description: "No significant astronomical events are recorded for this date in history (or future plans)."
                        }, moonPhase);
                    });
                }

                calendarDaysContainer.appendChild(dayDiv);
            }
        }

        async function showEventPopup(event, moonPhase) {
            modalEventTitle.textContent = event.title;
            modalEventDate.textContent = new Date(event.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            modalMoonPhase.textContent = `Moon Phase: ${moonPhase}`;

            // Show loading indicator and clear previous description
            modalEventDescription.textContent = '';
            llmStoryLoading.classList.remove('hidden');

            eventModal.classList.add('show');

            try {
                const prompt = `Write a short, engaging story about the following astronomical event: ${event.title} on ${event.date}. Original description: ${event.description}. Make it captivating for a general audience interested in space. Keep it concise, around 100-150 words.`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyAI2QHPwvtSWbJtvbsCe06PFUzMEP4qPX0"
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    modalEventDescription.textContent = text;
                } else {
                    modalEventDescription.textContent = event.description; // Fallback to original
                }
            }
            catch (error) {
                console.error("Error fetching LLM story:", error);
                modalEventDescription.textContent = `Failed to load cosmic tale. Original event details: ${event.description}`; // Fallback with error
            } finally {
                llmStoryLoading.classList.add('hidden'); // Hide loading indicator
            }
        }

        function closeEventPopup() {
            eventModal.classList.remove('show');
        }

        // --- Glossary Functions ---
        // Moved declarations to top-level scope to avoid redeclaration errors
        // const glossaryContainer = document.getElementById('glossary-container');
        // const glossaryFilterInput = document.getElementById('glossaryFilterInput');

        function renderGlossary(filter = '') {
            glossaryContainer.innerHTML = ''; // Clear existing terms

            const lowerCaseFilter = filter.toLowerCase();

            GLOSSARY_TERMS.forEach(termData => {
                // Check if term or definition matches filter
                if (termData.term.toLowerCase().includes(lowerCaseFilter) ||
                    termData.definition.toLowerCase().includes(lowerCaseFilter)) {

                    const termDiv = document.createElement('div');
                    termDiv.classList.add('glossary-term');
                    termDiv.innerHTML = `
                        <h3>${termData.term}</h3>
                        <p>${termData.definition}</p>
                    `;
                    glossaryContainer.appendChild(termDiv);
                }
            });

            if (glossaryContainer.children.length === 0 && filter !== '') {
                glossaryContainer.innerHTML = '<p class="text-gray-400 text-center">No terms found matching your search.</p>';
            }
        }

        // --- Space History Timeline Functions ---
        function renderSpaceHistoryTimeline() {
            timelineContainer.innerHTML = ''; // Clear existing timeline

            SPACE_HISTORY_EVENTS.forEach((event, index) => {
                const eventDiv = document.createElement('div');
                eventDiv.classList.add('timeline-event');
                if (index % 2 === 0) {
                    eventDiv.classList.add('left');
                } else {
                    eventDiv.classList.add('right');
                }

                eventDiv.innerHTML = `
                    <div class="timeline-content">
                        <h3>${event.date}</h3>
                        <p>${event.title}</p>
                        <p class="text-gray-400 text-sm mt-2">${event.description}</p>
                    </div>
                `;
                timelineContainer.appendChild(eventDiv);
            });
        }

        // --- Did You Know? Functions ---
        function displayRandomDidYouKnowFact() {
            const randomIndex = Math.floor(Math.random() * DID_YOU_KNOW_FACTS.length);
            didYouKnowFactContent.textContent = DID_YOU_KNOW_FACTS[randomIndex];
            // Show fact in the intro section
            const didYouKnowIntroSection = document.getElementById('did-you-know-fact');
            if (didYouKnowIntroSection) {
                didYouKnowIntroSection.textContent = DID_YOU_KNOW_FACTS[randomIndex];
            }
        }

        function showDidYouKnowPopup() {
            displayRandomDidYouKnowFact(); // Display a new random fact
            didYouKnowPopup.classList.add('show');
        }

        function hideDidYouKnowPopup() {
            didYouKnowPopup.classList.remove('show');
        }

        function showHeaderTooltip(fact) {
            headerTooltip.textContent = fact;
            headerTooltip.classList.add('show');
        }

        function hideHeaderTooltip() {
            headerTooltip.classList.remove('show');
        }


        // --- Event Listeners for Quiz ---
        document.querySelectorAll('.quiz-level-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                startQuiz(e.target.dataset.level);
            });
        });

        quizNextButton.addEventListener('click', nextQuestion);
        quizResetButton.addEventListener('click', resetQuiz);

        // --- Event Listeners for Calendar ---
        prevMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        });

        closeModalBtn.addEventListener('click', closeEventPopup);
        eventModal.addEventListener('click', (e) => {
            // Close modal if clicked on the overlay, not the content itself
            if (e.target === eventModal) {
                closeEventPopup();
            }
        });

        // --- Event Listeners for Solar System Controls ---
        const toggleOrbitsCheckbox = document.getElementById('toggleOrbits');
        const toggleMeteorsCheckbox = document.getElementById('toggleMeteors');
        const zoomSensitivitySlider = document.getElementById('zoomSensitivity');
        const timeWarpSlider = document.getElementById('timeWarp'); // Get the time warp slider
        const toggleAxialTiltCheckbox = document.getElementById('toggleAxialTilt'); // Get the axial tilt checkbox


        // Event listener for glossary filter input
        glossaryFilterInput.addEventListener('input', (e) => {
            renderGlossary(e.target.value);
        });

        // Event Listeners for Did You Know? Popup
        nextFactBtn.addEventListener('click', displayRandomDidYouKnowFact);
        closeFactBtn.addEventListener('click', hideDidYouKnowPopup);

        // Event Listeners for Header Tooltip
        siteTitle.addEventListener('mouseenter', () => {
            const randomIndex = Math.floor(Math.random() * DID_YOU_KNOW_FACTS.length);
            showHeaderTooltip(DID_YOU_KNOW_FACTS[randomIndex]);
        });
        siteTitle.addEventListener('mouseleave', hideHeaderTooltip);

        // Event Listener for Eclipses Slider
        eclipseSlider.addEventListener('input', (event) => {
            eclipseCurrentAngle = parseFloat(event.target.value);
            updateEclipsesVisual(eclipseCurrentAngle);
        });


        // Event listeners are added inside window.onload to ensure elements exist
        window.onload = function () {
            // Initial call to show the correct section based on URL hash or default
            const initialHash = window.location.hash.substring(1);
            if (initialHash) {
                showSection(initialHash);
            } else {
                showSection('intro-section'); // Default to 'intro-section'
            }

            // Initialize the calendar (it should render regardless of which section is visible)
            renderCalendar();

            // Render glossary on initial load if it's the active section, or for general readiness
            renderGlossary();

            // Add event listeners for solar system controls after elements are available
            if (toggleOrbitsCheckbox) {
                toggleOrbitsCheckbox.addEventListener('change', (event) => {
                    orbitLines.forEach(orbit => {
                        orbit.visible = event.target.checked;
                    });
                });
            }
            if (toggleMeteorsCheckbox) {
                toggleMeteorsCheckbox.addEventListener('change', (event) => {
                    meteors.forEach(meteor => {
                        meteor.visible = event.target.checked;
                    });
                });
            }
            if (zoomSensitivitySlider) {
                zoomSensitivitySlider.addEventListener('input', (event) => {
                    solarSystemZoomSensitivity = parseFloat(event.target.value);
                });
            }
            // Initialize timeWarpFactor
            if (timeWarpSlider) {
                timeWarpFactor = parseFloat(timeWarpSlider.value);
            }
            // Initialize showAxialTilt
            if (toggleAxialTiltCheckbox) {
                showAxialTilt = toggleAxialTiltCheckbox.checked;
            }

            // Display initial "Did You Know?" fact in the intro section
            displayRandomDidYouKnowFact();
            // Show the floating "Did You Know?" popup after a delay
            setTimeout(showDidYouKnowPopup, 5000); // Show after 5 seconds
        };
    </script>
</body>
</html>
