<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Muse</title>
    <!-- Tailwind CSS CDN for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js CDN for 3D graphics -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Font Awesome for various icons across the site -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Import Google Font 'Inter' for modern typography */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a; /* Deep space background */
            color: #e0e0e0; /* Light gray text for contrast */
            overflow-x: hidden; /* Prevent horizontal scroll on small screens */
            cursor: none; /* Hide the default cursor */
        }
        /* Ensure interactive elements also hide the default cursor */
        a, button, input, select, canvas {
            cursor: none;
        }
        /* Custom scrollbar for a sleek look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6a6a6a;
        }
        /* Canvas elements will dynamically size to their containers */
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        /* Section containers hidden by default, shown by JavaScript */
        .section-container {
            min-height: calc(100vh - 80px); /* Adjust based on header/footer height */
            padding: 2rem;
            display: none;
        }
        .active-section {
            display: block; /* Active section will be displayed */
        }
        /* Gradient for attractive buttons and elements */
        .btn-gradient {
            background: linear-gradient(135deg, #6b46c1, #805ad5);
            transition: all 0.3s ease;
        }
        .btn-gradient:hover {
            background: linear-gradient(135deg, #805ad5, #6b46c1);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(128, 90, 213, 0.4);
        }
        /* Glassmorphism effect for cards and main content areas */
        .glassmorphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        /* Responsive utility classes for smaller text on mobile */
        @media (max-width: 768px) {
            .text-xl-mobile { font-size: 1.25rem; }
            .text-lg-mobile { font-size: 1.125rem; }
            .text-base-mobile { font-size: 1rem; }
            .text-sm-mobile { font-size: 0.875rem; }
        }
        /* Styles for calendar event dots */
        .event-dot {
            position: absolute;
            bottom: 4px; /* Position dots at the bottom of the cell */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 3px;
        }
        .event-dot span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        /* Star name label styling */
        .star-label {
            position: absolute;
            color: rgba(255, 255, 255, 0.7);
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none; /* Allows clicks to pass through to the canvas */
            transform: translate(-50%, -150%); /* Position above the star */
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
        }
        
        /* --- Custom Space Cursor Styles --- */
        #custom-cursor {
            position: fixed;
            top: 0;
            left: 0;
            width: 20px;
            height: 20px;
            pointer-events: none; /* Allows clicks to pass through */
            z-index: 9999;
            transition: transform 0.2s ease-out;
        }
        #cursor-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 12px;
            height: 12px;
            background-color: #ffffff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px #ffffff, 0 0 20px #ffffff, 0 0 30px #a29bfe;
            animation: pulse 2s infinite;
        }
        .cursor-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background-color: #d1d8e0;
            border-radius: 50%;
            box-shadow: 0 0 5px #a5b1c2;
        }
        /* Hover effect for the cursor */
        #custom-cursor.hover {
            transform: scale(1.5);
        }
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.95);
                box-shadow: 0 0 0 0 rgba(162, 155, 254, 0.7);
            }
            70% {
                transform: translate(-50%, -50%) scale(1.1);
                box-shadow: 0 0 10px 15px rgba(162, 155, 254, 0);
            }
            100% {
                transform: translate(-50%, -50%) scale(0.95);
                box-shadow: 0 0 0 0 rgba(162, 155, 254, 0);
            }
        }
    </style>
</head>
<body>
    <!-- Custom Space Cursor HTML -->
    <div id="custom-cursor">
        <div id="cursor-glow"></div>
        <div class="cursor-particle"></div>
        <div class="cursor-particle"></div>
        <div class="cursor-particle"></div>
    </div>

    <!-- Header/Navigation Bar -->
    <nav class="bg-gray-900 bg-opacity-80 p-4 sticky top-0 z-50 shadow-lg rounded-b-lg">
        <div class="container mx-auto flex flex-wrap justify-between items-center">
            <!-- Brand Title with gradient text -->
            <a href="#" class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 rounded-lg p-2">Space Muse</a>
            <!-- Mobile Menu Button -->
            <div class="block lg:hidden">
                <button id="menu-btn" class="text-purple-300 focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>
            <!-- Navigation Links (hidden on mobile by default, shown by JS) -->
            <div id="nav-links" class="hidden lg:flex flex-grow justify-end items-center space-x-4 mt-4 lg:mt-0 w-full lg:w-auto">
                <button class="nav-link text-purple-300 hover:text-white px-3 py-2 rounded-md transition duration-300 btn-gradient" data-section="home">Home</button>
                <button class="nav-link text-purple-300 hover:text-white px-3 py-2 rounded-md transition duration-300 btn-gradient" data-section="solar-system">Solar System</button>
                <button class="nav-link text-purple-300 hover:text-white px-3 py-2 rounded-md transition duration-300 btn-gradient" data-section="constellations">Constellations</button>
                <button class="nav-link text-purple-300 hover:text-white px-3 py-2 rounded-md transition duration-300 btn-gradient" data-section="stories">Space Stories</button>
                <button class="nav-link text-purple-300 hover:text-white px-3 py-2 rounded-md transition duration-300 btn-gradient" data-section="chatbot">AI Chatbot</button>
                <button class="nav-link text-purple-300 hover:text-white px-3 py-2 rounded-md transition duration-300 btn-gradient" data-section="quiz">Space Quiz</button>
                <button class="nav-link text-purple-300 hover:text-white px-3 py-2 rounded-md transition duration-300 btn-gradient" data-section="calendar">Cosmic Calendar</button>
                <button class="nav-link text-purple-300 hover:text-white px-3 py-2 rounded-md transition duration-300 btn-gradient" data-section="timeline">Space Timeline</button>
                <button class="nav-link text-purple-300 hover:text-white px-3 py-2 rounded-md transition duration-300 btn-gradient" data-section="visuals">Interactive Visuals</button>
                <button class="nav-link text-purple-300 hover:text-white px-3 py-2 rounded-md transition duration-300 btn-gradient" data-section="games">Mini Games</button>
                <button class="nav-link text-purple-300 hover:text-white px-3 py-2 rounded-md transition duration-300 btn-gradient" data-section="glossary">Glossary</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area - All sections are contained here -->
    <main class="container mx-auto mt-8 p-4">
        <!-- Home Section: The welcoming page -->
        <section id="home-section" class="section-container active-section flex flex-col items-center justify-center text-center min-h-screen">
            <h1 class="text-5xl lg:text-7xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-500 to-pink-600 animate-pulse-slow">Welcome to Space Muse</h1>
            <p class="text-xl lg:text-3xl text-gray-300 mt-4 max-w-3xl leading-relaxed">Your portal to the cosmos. Explore, learn, and be inspired by the wonders of space.</p>
            <div class="flex flex-wrap justify-center gap-4 mt-8">
                <button class="btn-gradient text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:scale-105 transform transition duration-300 nav-link" data-section="solar-system">Explore Solar System <i class="fas fa-planet ml-2"></i></button>
                <button class="btn-gradient text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:scale-105 transform transition duration-300 nav-link" data-section="stories">Read Space Stories <i class="fas fa-book-open ml-2"></i></button>
                <button class="btn-gradient text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:scale-105 transform transition duration-300 nav-link" data-section="chatbot">Chat with AI <i class="fas fa-robot ml-2"></i></button>
            </div>
            <div class="mt-12 text-gray-400">
                <p>"The cosmos is within us. We are made of star-stuff. We are a way for the universe to know itself." - Carl Sagan</p>
            </div>
        </section>

        <!-- Solar System Section: Interactive 3D model -->
        <section id="solar-system-section" class="section-container">
            <h2 class="text-4xl font-bold text-purple-400 mb-6 text-center">Interactive 3D Solar System</h2>
            <div id="solar-system-container" class="relative w-full h-[600px] rounded-lg overflow-hidden glassmorphism">
                <canvas id="solar-system-canvas" class="w-full h-full"></canvas>
                <div class="absolute top-4 right-4 bg-gray-800 bg-opacity-70 p-3 rounded-lg text-sm text-gray-200">
                    Drag to rotate, Scroll to zoom
                </div>
                <div class="absolute bottom-4 left-4 right-4 flex flex-col items-center">
                    <label for="time-warp-slider" class="text-gray-300 mb-2">Time Warp Speed: <span id="time-warp-value">1x</span></label>
                    <input type="range" id="time-warp-slider" min="0.01" max="1" value="0.05" step="0.01" class="w-2/3 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </section>

        <!-- Constellations Section (ENHANCED) -->
        <section id="constellations-section" class="section-container">
            <h2 class="text-4xl font-bold text-pink-400 mb-6 text-center">Interactive Constellation Viewer</h2>
            <div id="constellations-3d-container" class="relative w-full h-[70vh] rounded-lg overflow-hidden glassmorphism">
                <canvas id="constellations-canvas" class="w-full h-full"></canvas>
                <div id="constellation-labels-container" class="absolute inset-0 pointer-events-none"></div>
                <div class="absolute top-4 right-4 bg-gray-800 bg-opacity-70 p-3 rounded-lg text-sm text-gray-200">
                    Drag to rotate, Scroll to zoom, Hover on stars
                </div>
            </div>
            <p class="text-center text-gray-400 mt-8">Explore the ancient patterns of the night sky. Click on stars for mythology and facts.</p>
        </section>

        <!-- Space Stories Section: Poetic narratives -->
<section id="stories-section" class="section-container">
    <h2 class="text-4xl font-bold text-blue-400 mb-6 text-center">Cosmic Narratives & Space Poetry</h2>
    <div class="space-y-8">
        <div class="glassmorphism p-6 rounded-lg">
            <h3 class="text-2xl font-semibold text-white mb-3">The Whisper of Nebulas</h3>
            <img src="https://placehold.co/600x300/2c3e50/ffffff?text=Nebula+Art" alt="Nebula Art"
                class="w-full h-auto rounded-lg mb-4 shadow-md">
            <p class="text-gray-300 text-base-mobile">
                In the vast tapestry of the cosmos, where stardust is spun into dreams, there exists a place where
                nebulae whisper ancient tales. Their vibrant hues, a palette of cosmic creation, paint canvases
                millions of light-years wide. Each swirling cloud, a birthplace of stars, hums with the promise of new
                worlds, new beginnings. Listen closely, and you might hear the gentle sigh of collapsing gas, the
                joyous burst of a star igniting, a symphony of genesis echoing through the void.
            </p>
        </div>
        <div class="glassmorphism p-6 rounded-lg">
            <h3 class="text-2xl font-semibold text-white mb-3">The Solitude of Mars</h3>
            <img src="https://placehold.co/600x300/8e44ad/ffffff?text=Mars+Landscape" alt="Mars Landscape"
                class="w-full h-auto rounded-lg mb-4 shadow-md">
            <p class="text-gray-300 text-base-mobile">
                Mars, the Red Planet, stands as a silent sentinel in our celestial neighborhood. Its rust-colored
                deserts stretch endlessly under a sky often tinged with an eerie blue. Canyons deeper than any on Earth
                carve through its surface, telling stories of ancient floods, of a past vastly different from its
                present solitude. Humanity gazes upon it with longing, a future home, a cosmic frontier. Soon, perhaps,
                the silence will be broken by the footsteps of explorers, transforming its quietude into a testament of
                courage and discovery.
            </p>
        </div>
        <div class="glassmorphism p-6 rounded-lg">
            <h3 class="text-2xl font-semibold text-white mb-3">Voyage to the Gas Giants</h3>
            <img src="https://placehold.co/600x300/3498db/ffffff?text=Gas+Giants" alt="Gas Giants"
                class="w-full h-auto rounded-lg mb-4 shadow-md">
            <p class="text-gray-300 text-base-mobile">
                Beyond the asteroid belt, majestic titans of gas spin in their grand orbits. Jupiter, a swirling
                masterpiece of storms, its Great Red Spot a timeless eye observing the cosmos. Saturn, adorned with
                rings of ice and rock, a celestial jewel shimmering in the sunlight. Uranus, a serene blue marble
                tilted on its side, and Neptune, the distant, stormy blue giant. These gas giants, with their myriad
                moons, hold secrets of the early solar system, immense pressures and winds that could swallow worlds.
                They are a testament to the raw power and artistry of the universe, beckoning us to understand their
                mysteries.
            </p>
        </div>
        <div class="glassmorphism p-6 rounded-lg">
            <h3 class="text-2xl font-semibold text-white mb-3">The Song of the Stars</h3>
            <img src="https://placehold.co/600x300/e67e22/ffffff?text=Starry+Sky" alt="Starry Sky"
                class="w-full h-auto rounded-lg mb-4 shadow-md">
            <p class="text-gray-300 text-base-mobile">
                Look up on a clear night, and you'll witness the silent, ancient song of the stars. Each twinkling
                point of light is a distant sun, a cosmic furnace burning brightly, some perhaps with planets orbiting
                them, fostering life unknown. From the fiery birth of a supernova to the quiet collapse into a white
                dwarf or black hole, stars live out grand, dramatic lives. Their light, traveling for years, decades,
                even millennia, reaches us as echoes of the past, connecting us to the vastness of time and space, a
                lullaby sung across the light-years.
            </p>
        </div>
    </div>
</section>
        <!-- AI Chatbot Section -->
        <section id="chatbot-section" class="section-container">
            <h2 class="text-4xl font-bold text-green-400 mb-6 text-center">Space AI Assistant</h2>
            <div class="flex flex-col h-[70vh] glassmorphism rounded-lg p-6">
                <div id="chat-output" class="flex-grow overflow-y-auto p-4 bg-gray-800 rounded-lg mb-4 space-y-4">
                    <!-- Chat messages will be dynamically added here -->
                    <div class="flex justify-start">
                        <div class="bg-blue-600 text-white p-3 rounded-lg max-w-xs md:max-w-md">
                            Hello! I am your Space Muse AI. Ask me anything about the cosmos!
                        </div>
                    </div>
                </div>
                <div class="flex">
                    <input type="text" id="chat-input" placeholder="Ask me about space..." class="flex-grow p-3 rounded-l-lg bg-gray-700 text-white border border-gray-600 focus:ring-2 focus:ring-purple-500 outline-none">
                    <button id="send-chat-btn" class="btn-gradient text-white p-3 rounded-r-lg font-semibold flex items-center">
                        <i class="fas fa-paper-plane mr-2"></i> Send
                    </button>
                </div>
                <div id="chat-loading" class="text-center text-gray-400 mt-2 hidden">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Thinking...
                </div>
            </div>
        </section>

        <!-- Quiz Section: Space facts challenge -->
        <section id="quiz-section" class="section-container">
            <h2 class="text-4xl font-bold text-yellow-400 mb-6 text-center">Cosmic Quiz Challenge</h2>
            <div class="glassmorphism p-6 rounded-lg max-w-2xl mx-auto">
                <div id="quiz-intro">
                    <p class="text-lg text-gray-300 mb-4 text-center">Test your knowledge of the universe!</p>
                    <div class="flex justify-center gap-4">
                        <button id="start-easy-quiz" class="btn-gradient text-white py-2 px-5 rounded-full" data-difficulty="easy">Easy</button>
                        <button id="start-medium-quiz" class="btn-gradient text-white py-2 px-5 rounded-full" data-difficulty="medium">Medium</button>
                        <button id="start-hard-quiz" class="btn-gradient text-white py-2 px-5 rounded-full" data-difficulty="hard">Hard</button>
                    </div>
                </div>
                <div id="quiz-questions" class="hidden">
                    <h3 id="quiz-difficulty" class="text-xl font-semibold text-center mb-4"></h3>
                    <p id="question-text" class="text-lg text-white mb-4"></p>
                    <div id="answer-options" class="flex flex-col space-y-3">
                        <!-- Options will be dynamically loaded here -->
                    </div>
                    <button id="next-question-btn" class="btn-gradient text-white mt-6 py-2 px-5 rounded-full w-full">Next Question</button>
                </div>
                <div id="quiz-result" class="hidden text-center">
                    <h3 class="text-3xl font-bold text-purple-300 mb-4">Quiz Complete!</h3>
                    <p id="score-text" class="text-2xl text-white mb-6"></p>
                    <button id="reset-quiz-btn" class="btn-gradient text-white py-2 px-5 rounded-full">Play Again</button>
                </div>
            </div>
        </section>

        <!-- Cosmic Calendar Section: Events & Pop-ups -->
        <section id="calendar-section" class="section-container">
            <h2 class="text-4xl font-bold text-orange-400 mb-6 text-center">Cosmic Events Calendar</h2>
            <div class="glassmorphism p-6 rounded-lg mx-auto max-w-5xl">
                <!-- Calendar Controls: Navigation and Filtering -->
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <div class="flex items-center gap-2">
                        <button id="prev-year" class="btn-gradient text-white p-2 rounded-full" title="Previous Year"><i class="fas fa-backward"></i></button>
                        <button id="prev-month" class="btn-gradient text-white p-2 rounded-full" title="Previous Month"><i class="fas fa-chevron-left"></i></button>
                    </div>
                    <h3 id="current-month-year" class="text-2xl font-semibold text-white text-center flex-grow"></h3>
                    <div class="flex items-center gap-2">
                        <button id="next-month" class="btn-gradient text-white p-2 rounded-full" title="Next Month"><i class="fas fa-chevron-right"></i></button>
                        <button id="next-year" class="btn-gradient text-white p-2 rounded-full" title="Next Year"><i class="fas fa-forward"></i></button>
                    </div>
                    <!-- Event Filter Dropdown -->
                    <div class="w-full md:w-auto">
                        <select id="event-filter" class="w-full bg-gray-700 text-white p-2 rounded-lg border border-gray-600 focus:ring-2 focus:ring-purple-500 outline-none">
                            <option value="all">All Events</option>
                            <option value="Rocket Launch">Rocket Launches</option>
                            <option value="Meteor Shower">Meteor Showers</option>
                            <option value="Eclipse">Eclipses</option>
                            <option value="Historical">Historical</option>
                        </select>
                    </div>
                </div>
                <!-- Calendar Grid and Loading Indicator -->
                <div class="relative">
                    <div class="grid grid-cols-7 gap-2 text-center text-gray-400 font-semibold mb-2">
                        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                        <!-- Calendar days will be rendered here by JavaScript -->
                    </div>
                    <!-- Loading Spinner -->
                    <div id="calendar-loading" class="hidden absolute inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center rounded-lg">
                        <i class="fas fa-spinner fa-spin text-purple-400 text-4xl"></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- Historical Space Timeline -->
        <section id="timeline-section" class="section-container">
            <h2 class="text-4xl font-bold text-cyan-400 mb-6 text-center">Historical Space Timeline</h2>
            <div class="glassmorphism p-8 rounded-lg max-w-4xl mx-auto">
                <div id="timeline-container" class="relative">
                    <!-- Vertical line for the timeline -->
                    <div class="absolute left-1/2 transform -translate-x-1/2 w-1 h-full bg-purple-500 rounded-full"></div>
                    <!-- Timeline events (alternating left/right) -->
                    <div class="timeline-event flex items-center mb-8 relative">
                        <div class="w-1/2 pr-8 text-right">
                            <h3 class="text-xl font-semibold text-white">1957: Sputnik 1</h3>
                            <p class="text-gray-300 text-sm-mobile">The Soviet Union launched the first artificial Earth satellite, marking the beginning of the Space Age.</p>
                        </div>
                        <div class="absolute left-1/2 transform -translate-x-1/2 w-4 h-4 bg-purple-500 rounded-full border-2 border-white z-10"></div>
                        <div class="w-1/2 pl-8"></div>
                    </div>
                    <div class="timeline-event flex items-center mb-8 relative flex-row-reverse">
                        <div class="1/2 pl-8 text-left">
                            <h3 class="text-xl font-semibold text-white">1961: Yuri Gagarin</h3>
                            <p class="text-gray-300 text-sm-mobile">First human in space, orbiting Earth aboard Vostok 1.</p>
                        </div>
                        <div class="absolute left-1/2 transform -translate-x-1/2 w-4 h-4 bg-purple-500 rounded-full border-2 border-white z-10"></div>
                        <div class="w-1/2 pr-8"></div>
                    </div>
                    <div class="timeline-event flex items-center mb-8 relative">
                        <div class="w-1/2 pr-8 text-right">
                            <h3 class="text-xl font-semibold text-white">1969: Apollo 11 Moon Landing</h3>
                            <p class="text-gray-300 text-sm-mobile">Neil Armstrong and Buzz Aldrin become the first humans to walk on the Moon.</p>
                        </div>
                        <div class="absolute left-1/2 transform -translate-x-1/2 w-4 h-4 bg-purple-500 rounded-full border-2 border-white z-10"></div>
                        <div class="w-1/2 pl-8"></div>
                    </div>
                    <div class="timeline-event flex items-center mb-8 relative flex-row-reverse">
                        <div class="w-1/2 pl-8 text-left">
                            <h3 class="text-xl font-semibold text-white">2000: ISS First Crew</h3>
                            <p class="text-gray-300 text-sm-mobile">The International Space Station receives its first resident crew, beginning continuous human presence in space.</p>
                        </div>
                        <div class="absolute left-1/2 transform -translate-x-1/2 w-4 h-4 bg-purple-500 rounded-full border-2 border-white z-10"></div>
                        <div class="w-1/2 pr-8"></div>
                    </div>
                     <div class="timeline-event flex items-center mb-8 relative">
                        <div class="w-1/2 pr-8 text-right">
                            <h3 class="text-xl font-semibold text-white">2020: SpaceX Crew Dragon</h3>
                            <p class="text-300 text-sm-mobile">SpaceX becomes the first private company to launch astronauts to the ISS.</p>
                        </div>
                        <div class="absolute left-1/2 transform -translate-x-1/2 w-4 h-4 bg-purple-500 rounded-full border-2 border-white z-10"></div>
                        <div class="w-1/2 pl-8"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Interactive Visuals Section: Simulations -->
        <section id="visuals-section" class="section-container">
            <h2 class="text-4xl font-bold text-rose-400 mb-6 text-center">Interactive Cosmic Visuals</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Moon Phases Simulation -->
                <div class="glassmorphism p-6 rounded-lg flex flex-col items-center text-center">
                    <h3 class="text-2xl font-semibold text-white mb-4">Moon Phases Simulator</h3>
                    <canvas id="moon-phases-canvas" width="300" height="300" class="rounded-full border border-gray-600 shadow-md"></canvas>
                    <div class="mt-4 w-full">
                        <input type="range" id="moon-phase-slider" min="0" max="360" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        <p id="moon-phase-text" class="text-gray-300 mt-2">New Moon</p>
                    </div>
                </div>

                <!-- Eclipse Simulation -->
                <div class="glassmorphism p-6 rounded-lg flex flex-col items-center text-center">
                    <h3 class="text-2xl font-semibold text-white mb-4">Eclipse Simulation</h3>
                    <canvas id="eclipse-canvas" width="400" height="300" class="rounded-lg border border-gray-600 shadow-md"></canvas>
                    <button id="start-eclipse-sim" class="btn-gradient text-white py-2 px-5 rounded-full mt-4">Start Simulation</button>
                    <p class="text-gray-400 text-sm-mobile mt-2">A simplified representation of a solar eclipse.</p>
                </div>

                <!-- Rocket Launch Simulation -->
                <div class="glassmorphism p-6 rounded-lg md:col-span-2 flex flex-col items-center text-center">
                    <h3 class="text-2xl font-semibold text-white mb-4">Rocket Launch & Orbit Simulation</h3>
                    <canvas id="rocket-launch-canvas" width="800" height="400" class="rounded-lg border border-gray-600 shadow-md"></canvas>
                    <button id="start-rocket-sim" class="btn-gradient text-white py-2 px-5 rounded-full mt-4">Launch Rocket</button>
                    <p class="text-gray-400 text-sm-mobile mt-2">Watch a simplified rocket launch into orbit.</p>
                </div>
            </div>
        </section>

        <!-- Mini Games Section -->
        <section id="games-section" class="section-container">
            <h2 class="text-4xl font-bold text-teal-400 mb-6 text-center">Cosmic Mini Games</h2>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Gravity Slingshot Simulator -->
                <div class="glassmorphism p-6 rounded-lg flex flex-col items-center text-center">
                    <h3 class="text-2xl font-semibold text-white mb-4">Gravity Slingshot</h3>
                    <canvas id="slingshot-canvas" width="300" height="300" class="bg-gray-900 rounded-lg border border-gray-600"></canvas>
                    <button id="start-slingshot" class="btn-gradient text-white py-2 px-5 rounded-full mt-4">Launch Ship</button>
                    <p class="text-gray-400 text-sm-mobile mt-2">Utilize planetary gravity to boost your ship's speed!</p>
                </div>

                <!-- Meteor Dodge Game -->
                <div class="glassmorphism p-6 rounded-lg flex flex-col items-center text-center">
                    <h3 class="text-2xl font-semibold text-white mb-4">Meteor Dodge</h3>
                    <canvas id="meteor-dodge-canvas" width="300" height="300" class="bg-gray-900 rounded-lg border border-gray-600"></canvas>
                    <button id="start-meteor-dodge" class="btn-gradient text-white py-2 px-5 rounded-full mt-4">Start Game</button>
                    <p class="text-gray-400 text-sm-mobile mt-2">Navigate your ship through an asteroid field!</p>
                </div>

                <!-- Space Maze Game -->
                <div class="glassmorphism p-6 rounded-lg flex flex-col items-center text-center">
                    <h3 class="text-2xl font-semibold text-white mb-4">Space Maze</h3>
                    <canvas id="space-maze-canvas" width="300" height="300" class="bg-gray-900 rounded-lg border border-gray-600"></canvas>
                    <button id="start-space-maze" class="btn-gradient text-white py-2 px-5 rounded-full mt-4">Start Maze</button>
                    <p class="text-gray-400 text-sm-mobile mt-2">Find your way through the cosmic labyrinth.</p>
                </div>
            </div>
        </section>

        <!-- Glossary Section: Cosmic terms with search -->
        <section id="glossary-section" class="section-container">
            <h2 class="text-4xl font-bold text-indigo-400 mb-6 text-center">Glossary of Cosmic Terms</h2>
            <div class="glassmorphism p-6 rounded-lg max-w-3xl mx-auto">
                <input type="text" id="glossary-search" placeholder="Search terms..." class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-2 focus:ring-purple-500 outline-none mb-4">
                <div id="glossary-list" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Glossary terms (filterable by search) -->
                    <div class="glossary-item">
                        <h3 class="text-xl font-semibold text-white">Asteroid</h3>
                        <p class="text-gray-300 text-base-mobile">A small rocky body orbiting the Sun, much smaller than a planet. Asteroids are primarily found in the asteroid belt between Mars and Jupiter.</p>
                    </div>
                    <div class="glossary-item">
                        <h3 class="text-xl font-semibold text-white">Black Hole</h3>
                        <p class="text-gray-300 text-base-mobile">A region of spacetime where gravity is so strong that nothing—no particles or even electromagnetic radiation such as light—can escape from it.</p>
                    </div>
                    <div class="glossary-item">
                        <h3 class="text-xl font-semibold text-white">Galaxy</h3>
                        <p class="text-gray-300 text-base-mobile">A massive, gravitationally bound system consisting of stars, stellar remnants, an interstellar medium of gas and dust, and dark matter. The word galaxy is derived from the Greek galaxias, literally "milky", a reference to the Milky Way galaxy.</p>
                    </div>
                    <div class="glossary-item">
                        <h3 class="text-xl font-semibold text-white">Nebula</h3>
                        <p class="text-gray-300 text-base-mobile">An interstellar cloud of dust, hydrogen, helium and other ionized gases. It is the birthplace of stars.</p>
                    </div>
                    <div class="glossary-item">
                        <h3 class="text-xl font-semibold text-white">Supernova</h3>
                        <p class="text-gray-300 text-base-mobile">A powerful and luminous stellar explosion. It is the largest explosion that takes place in space.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Generic Modal Structure (for alerts, planet info, etc.) -->
        <div id="custom-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100]">
            <div class="glassmorphism p-6 rounded-lg max-w-sm md:max-w-md w-full relative">
                <button id="modal-close-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white text-xl"><i class="fas fa-times"></i></button>
                <h4 id="modal-title" class="text-xl font-bold text-purple-300 mb-3 text-center"></h4>
                <div id="modal-content" class="text-gray-200 mb-5 overflow-y-auto max-h-[70vh]"></div>
                <div id="modal-actions" class="flex justify-center gap-4 mt-4"></div>
            </div>
        </div>

        <!-- "Did You Know?" Pop-up (controlled by JavaScript) -->
        <div id="did-you-know-popup" class="hidden fixed bottom-4 right-4 bg-gray-900 bg-opacity-90 glassmorphism p-4 rounded-lg shadow-xl max-w-sm z-50">
            <button class="absolute top-2 right-2 text-gray-400 hover:text-white" onclick="document.getElementById('did-you-know-popup').classList.add('hidden')"><i class="fas fa-times"></i></button>
            <h4 class="text-lg font-bold text-purple-300 mb-2">Did You Know? <i class="fas fa-lightbulb ml-1"></i></h4>
            <p id="did-you-know-fact" class="text-gray-200"></p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 bg-opacity-80 p-4 mt-8 text-center text-gray-500 text-sm rounded-t-lg">
        <p>&copy; 2025 Space Muse. All rights reserved. Built with passion for the cosmos.</p>
    </footer>

    <script type="module">
        // Global variables for Firebase (if persistence were to be added) - provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Custom Cursor Logic ---
        const cursor = document.getElementById('custom-cursor');
        const particles = document.querySelectorAll('.cursor-particle');
        const interactiveElements = document.querySelectorAll('a, button, input, select, [data-section]');

        // Particle properties (angle, speed, distance from center)
        const particleData = [
            { angle: 0, speed: 0.05, distance: 15 },
            { angle: 120, speed: 0.06, distance: 20 },
            { angle: 240, speed: 0.04, distance: 25 }
        ];

        // Update cursor position on mouse move
        window.addEventListener('mousemove', e => {
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';
        });

        // Animate orbiting particles
        function animateParticles() {
            const cursorRect = cursor.getBoundingClientRect();
            const cursorCenterX = cursorRect.width / 2;
            const cursorCenterY = cursorRect.height / 2;

            particles.forEach((particle, index) => {
                const data = particleData[index];
                data.angle += data.speed; // Update angle for rotation

                // Calculate particle position around the cursor's center
                const x = cursorCenterX + data.distance * Math.cos(data.angle) - (particle.offsetWidth / 2);
                const y = cursorCenterY + data.distance * Math.sin(data.angle) - (particle.offsetHeight / 2);

                particle.style.transform = `translate(${x}px, ${y}px)`;
            });

            requestAnimationFrame(animateParticles);
        }
        
        // Add hover effects for interactive elements
        interactiveElements.forEach(el => {
            el.addEventListener('mouseenter', () => cursor.classList.add('hover'));
            el.addEventListener('mouseleave', () => cursor.classList.remove('hover'));
        });
        
        // Start the particle animation
        animateParticles();


        // Helper function to dispose of Three.js objects to prevent memory leaks
        function disposeThreeJsObject(obj) {
            if (obj.geometry) {
                obj.geometry.dispose();
            }
            if (obj.material) {
                if (Array.isArray(obj.material)) {
                    obj.material.forEach(material => material.dispose());
                } else {
                    obj.material.dispose();
                }
            }
            if (obj.children) {
                obj.children.forEach(child => disposeThreeJsObject(child));
            }
        }

        // --- Generic Modal Logic ---
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalActions = document.getElementById('modal-actions');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // Function to show a generic modal
        function showModal(title, contentHTML, actionsHTML = '', showCloseButton = true) {
            modalTitle.innerHTML = title;
            modalContent.innerHTML = contentHTML;
            modalActions.innerHTML = actionsHTML;
            if (showCloseButton) {
                modalCloseBtn.classList.remove('hidden');
            } else {
                modalCloseBtn.classList.add('hidden');
            }
            customModal.classList.remove('hidden');
        }

        // Function to hide the generic modal
        function hideModal() {
            customModal.classList.add('hidden');
            // Clear content for next use
            modalTitle.innerHTML = '';
            modalContent.innerHTML = '';
            modalActions.innerHTML = '';
        }

        // Event listener for the modal close button
        modalCloseBtn.addEventListener('click', hideModal);

        // --- Custom Alert Box (re-using the generic modal) ---
        function alertBox(title, message, onConfirm = null) {
            const actions = `<button id="alert-ok-btn" class="btn-gradient text-white py-2 px-5 rounded-full">OK</button>`;
            showModal(title, `<p>${message}</p>`, actions);

            document.getElementById('alert-ok-btn').addEventListener('click', () => {
                hideModal();
                if (onConfirm) onConfirm();
            }, { once: true }); // Use once: true to ensure the event listener is removed after first click
        }
        
        // Function to display planet information using the generic modal
        function showPlanetInfo(planet) {
            const content = `
                <p class="text-gray-300 mb-2"><strong>Radius:</strong> ${planet.radius} units</p>
                <p class="text-gray-300 mb-2"><strong>Average Distance from Sun:</strong> ${planet.distance} units</p>
                <p class="text-gray-300 mb-4">${planet.description}</p>
            `;
            showModal(`Information about ${planet.name}`, content);
        }

        // Function to display star information
        function showStarInfo(star) {
            const content = `
                <p class="text-gray-300 mb-2"><strong>Constellation:</strong> ${star.constellationName}</p>
                <p class="text-gray-300 mb-4">${star.info}</p>
                <p class="text-gray-400 text-sm italic">${star.constellationDesc}</p>
            `;
            showModal(`Star: ${star.id.charAt(0).toUpperCase() + star.id.slice(1)}`, content);
        }

        // --- Navigation Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.section-container');
            const menuBtn = document.getElementById('menu-btn');
            const navLinksContainer = document.getElementById('nav-links');

            // Function to stop all Three.js animations and dispose scenes
            function stopAllThreeJsScenes() {
                if (solarSystemAnimationId) {
                    cancelAnimationFrame(solarSystemAnimationId);
                    solarSystemAnimationId = null;
                }
                if (solarSystemScene) { // Check if solar system scene exists globally
                    disposeThreeJsObject(solarSystemScene);
                    solarSystemScene = null;
                    solarSystemRenderer = null;
                    solarSystemCamera = null;
                    solarSystemRaycaster = null;
                    solarSystemMouse = null;
                    solarSystemPlanets = [];
                }

                if (constellationsAnimationId) {
                    cancelAnimationFrame(constellationsAnimationId);
                    constellationsAnimationId = null;
                }
                if (constellationsScene) { // Check if constellations scene exists globally
                    disposeThreeJsObject(constellationsScene);
                    constellationsScene = null;
                    constellationsRenderer = null;
                    constellationsCamera = null;
                    constellationsRaycaster = null;
                    constellationsMouse = null;
                    constellationsStars = []; // Ensure stars array is cleared
                }
            }


            // Toggle mobile navigation menu
            menuBtn.addEventListener('click', () => {
                navLinksContainer.classList.toggle('hidden');
                navLinksContainer.classList.toggle('flex');
            });

            // Handle section switching when a navigation link is clicked
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetSectionId = link.dataset.section + '-section';

                    // Stop and dispose of all active Three.js scenes before switching
                    stopAllThreeJsScenes();

                    // Hide all sections
                    sections.forEach(section => {
                        section.classList.remove('active-section');
                        section.style.display = 'none';
                    });

                    // Show the target section
                    const targetSection = document.getElementById(targetSectionId);
                    if (targetSection) {
                        targetSection.classList.add('active-section');
                        targetSection.style.display = 'block';
                    }

                    // Hide mobile menu after selection on smaller screens
                    if (window.innerWidth < 1024) {
                         navLinksContainer.classList.add('hidden');
                         navLinksContainer.classList.remove('flex');
                    }

                    // Initialize specific section components if they are active
                    // This ensures Three.js scenes or canvas games are only rendered when visible
                    if (targetSectionId === 'solar-system-section') {
                        initSolarSystem();
                    } else if (targetSectionId === 'constellations-section') {
                        initConstellations();
                    } else if (targetSectionId === 'visuals-section') {
                        initMoonPhases();
                        initEclipse();
                        initRocketLaunch();
                    } else if (targetSectionId === 'games-section') {
                        initSlingshotGame();
                        initMeteorDodgeGame();
                        initSpaceMazeGame();
                    } else if (targetSectionId === 'calendar-section') {
                        renderCalendar(); // Now an async function
                    }
                });
            });

            // Set 'home' section as active by default on page load
            document.getElementById('home-section').classList.add('active-section');
            document.getElementById('home-section').style.display = 'flex';
        });

        // --- "Did You Know?" Pop-up Logic ---
        const didYouKnowFacts = [
            "A day on Venus is longer than its year.",
            "There are more stars in the universe than grains of sand on all the beaches on Earth.",
            "The largest known volcano in our solar system is on Mars, called Olympus Mons.",
            "Saturn's rings are made up of billions of pieces of ice and rock.",
            "The Sun is so massive that it accounts for 99.86% of the total mass of the solar system.",
            "Neutron stars are so dense that a teaspoon of their material would weigh about 6 billion tons.",
            "The sound of space is completely silent because there is no atmosphere to carry sound waves.",
            "There are more trees on Earth than stars in the Milky Way galaxy."
        ];

        // Function to display a random "Did You Know?" fact
        function showDidYouKnownFact() {
            const popup = document.getElementById('did-you-know-popup');
            const factText = document.getElementById('did-you-know-fact');
            const randomIndex = Math.floor(Math.random() * didYouKnowFacts.length);
            factText.textContent = didYouKnowFacts[randomIndex];
            popup.classList.remove('hidden'); // Show the pop-up
            setTimeout(() => {
                popup.classList.add('hidden'); // Hide after 15 seconds
            }, 15000);
        }

        // Show a fact immediately on page load and then every 60 seconds
        document.addEventListener('DOMContentLoaded', showDidYouKnownFact);
        setInterval(showDidYouKnownFact, 60000);

        // --- Three.js Solar System ---
        let solarSystemScene, solarSystemCamera, solarSystemRenderer, solarSystemRaycaster, solarSystemMouse; // Declare Three.js core components including raycaster and mouse
        let solarSystemSun;
        let solarSystemPlanets = []; // Array to hold planet Mesh objects
        let solarSystemAnimationId; // To control animation frame
        let solarSystemSpeedFactor = 0.05; // Adjustable speed factor for time warp

        // Data for planets: radius, color, distance from Sun, orbital speed, and detailed description
        const planetData = [
            { name: 'Mercury', radius: 0.8, color: 0x888888, distance: 20, orbitSpeed: 0.05, selfRotationSpeed: 0.01, description: "The smallest planet in our solar system, closest to the Sun. It has a heavily cratered surface and experiences extreme temperature variations. A day on Mercury is about 59 Earth days, and a year is only 88 Earth days." },
            { name: 'Venus', radius: 1.5, color: 0xffa500, distance: 30, orbitSpeed: 0.03, selfRotationSpeed: -0.005, description: "Often called Earth's 'sister planet' due to its similar size. It has a thick, toxic atmosphere of carbon dioxide and is the hottest planet. Interestingly, it rotates in the opposite direction to most planets, and its day is longer than its year." },
            { name: 'Earth', radius: 1.6, color: 0x0000ff, distance: 40, orbitSpeed: 0.02, selfRotationSpeed: 0.03, description: "Our home planet, the only known celestial body to harbor life. Known for its vast oceans, diverse ecosystems, and a single natural satellite, the Moon. Its year is 365.25 days." },
            { name: 'Mars', radius: 1.2, color: 0xff0000, distance: 50, orbitSpeed: 0.015, selfRotationSpeed: 0.025, description: "Known as the 'Red Planet' due to its iron oxide-rich surface. It has polar ice caps, volcanoes, and evidence of ancient river valleys, making it a prime candidate for future human exploration. It has two small moons, Phobos and Deimos." },
            { name: 'Jupiter', radius: 5, color: 0xcc9966, distance: 80, orbitSpeed: 0.01, selfRotationSpeed: 0.04, description: "The largest planet in our solar system, a gas giant with a distinctive Great Red Spot—a colossal storm larger than Earth. It has a powerful magnetic field and at least 79 known moons, including the four Galilean moons (Io, Europa, Ganymede, Callisto)." },
            { name: 'Saturn', radius: 4, color: 0xd2b48c, distance: 100, orbitSpeed: 0.008, selfRotationSpeed: 0.035, description: "Famous for its magnificent ring system, composed of countless ice particles and rocky debris. Saturn is another gas giant with a vast family of moons, the largest being Titan, which has a thick atmosphere." },
            { name: 'Uranus', radius: 3, color: 0xaaffff, distance: 120, orbitSpeed: 0.005, selfRotationSpeed: 0.02, description: "An ice giant that rotates on its side, giving it unique seasonal cycles. Its atmosphere contains methane, which gives it a blue-green color. It has faint rings and many moons." },
            { name: 'Neptune', radius: 2.8, color: 0x00008b, distance: 140, orbitSpeed: 0.003, selfRotationSpeed: 0.018, description: "The farthest known planet from the Sun, another ice giant with powerful winds and a deep blue appearance due to methane in its atmosphere. It has a notable moon, Triton, which orbits in a retrograde direction." }
        ];

        // Initialize the 3D Solar System scene
        function initSolarSystem() {
            // Cancel any previous animation to prevent multiple animation loops running
            if (solarSystemAnimationId) {
                cancelAnimationFrame(solarSystemAnimationId);
            }
            // Clear existing scene elements if re-initialization is needed
            if (solarSystemScene) {
                disposeThreeJsObject(solarSystemScene);
            }

            const container = document.getElementById('solar-system-container');
            const canvas = document.getElementById('solar-system-canvas');
            const timeWarpSlider = document.getElementById('time-warp-slider');
            const timeWarpValue = document.getElementById('time-warp-value');

            if (!container || !canvas || !timeWarpSlider || !timeWarpValue) {
                console.error("Solar system elements not found. Cannot initialize 3D.");
                return;
            }

            // Set canvas width and height for proper rendering resolution
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            // Scene setup
            solarSystemScene = new THREE.Scene();
            solarSystemCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            solarSystemRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            solarSystemRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
            solarSystemRenderer.setPixelRatio(window.devicePixelRatio);
            solarSystemRenderer.setClearColor(0x000000, 0); // Transparent background

            // Add a starry background using Points (particles)
            const starGeometry = new THREE.BufferGeometry();
            const starVertices = [];
            for (let i = 0; i < 10000; i++) {
                const x = (Math.random() - 0.5) * 2000;
                const y = (Math.random() - 0.5) * 2000;
                const z = (Math.random() - 0.5) * 2000;
                starVertices.push(x, y, z);
            }
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(new Float32Array(starVertices), 3));
            const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.5 });
            const stars = new THREE.Points(starGeometry, starMaterial);
            solarSystemScene.add(stars);

            // Sun: Central object and light source
            const sunGeometry = new THREE.SphereGeometry(10, 32, 32);
            // Increased emissive component for a more luminous Sun
            const sunMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00, emissive: 0xffaa00, emissiveIntensity: 0.8 });
            solarSystemSun = new THREE.Mesh(sunGeometry, sunMaterial);
            solarSystemSun.userData = { // Add Sun information for pop-up
                name: 'Sun',
                radius: '695,000 km', // Approximate actual radius
                distance: '0 km', // Reference point
                description: "The Sun is the star at the center of our Solar System. It is a nearly perfect sphere of hot plasma, heated to incandescence by nuclear fusion reactions in its core. It provides the energy for almost all life on Earth."
            };
            solarSystemScene.add(solarSystemSun);

            // PointLight: Illuminates the scene from the Sun's position
            const pointLight = new THREE.PointLight(0xffffff, 2, 1000);
            pointLight.position.set(0, 0, 0);
            solarSystemScene.add(pointLight);

            // Clear previous planets array
            solarSystemPlanets = [];

            // Create each planet and its orbit
            planetData.forEach(data => {
                const planetGeometry = new THREE.SphereGeometry(data.radius, 32, 32);
                const planetMaterial = new THREE.MeshLambertMaterial({ color: data.color });
                const planet = new THREE.Mesh(planetGeometry, planetMaterial);
                planet.position.x = data.distance;
                planet.userData = { ...data }; // Store all data in userData for easy access
                solarSystemPlanets.push(planet);
                solarSystemScene.add(planet);

                // Add orbit line for the planet
                const orbitRadius = data.distance;
                const orbitGeometry = new THREE.TorusGeometry(orbitRadius, 0.05, 16, 100);
                const orbitMaterial = new THREE.MeshBasicMaterial({ color: 0x444444, side: THREE.DoubleSide });
                const orbit = new THREE.Mesh(orbitGeometry, orbitMaterial);
                orbit.rotation.x = Math.PI / 2;
                solarSystemScene.add(orbit);
            });

            solarSystemCamera.position.z = 200; // Initial camera position

            // Camera Controls: Mouse interaction for rotation and zoom
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;

                const rotationSpeed = 0.005;
                solarSystemScene.rotation.y += deltaX * rotationSpeed;
                solarSystemScene.rotation.x += deltaY * rotationSpeed;
                solarSystemScene.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, solarSystemScene.rotation.x));
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomSpeed = 0.1;
                solarSystemCamera.position.z += e.deltaY * zoomSpeed;
                solarSystemCamera.position.z = Math.max(50, Math.min(500, solarSystemCamera.position.z));
            });

            // Initialize Raycaster for Sun and planet clicks
            solarSystemRaycaster = new THREE.Raycaster();
            solarSystemMouse = new THREE.Vector2();

            // Event listener for clicks on the canvas
            canvas.addEventListener('click', onSolarSystemCanvasClick);

            // Time Warp Slider Event Listener
            timeWarpSlider.addEventListener('input', (e) => {
                solarSystemSpeedFactor = parseFloat(e.target.value);
                timeWarpValue.textContent = `${solarSystemSpeedFactor.toFixed(2)}x`; // Changed to 2 decimal places
            });
            timeWarpValue.textContent = `${solarSystemSpeedFactor.toFixed(2)}x`; // Initialize display value


            // Animation Loop for Solar System
            function animateSolarSystem() {
                solarSystemAnimationId = requestAnimationFrame(animateSolarSystem);

                solarSystemSun.rotation.y += 0.002 * solarSystemSpeedFactor;

                solarSystemPlanets.forEach((planet) => {
                    const angle = Date.now() * planet.userData.orbitSpeed * solarSystemSpeedFactor;
                    planet.position.x = planet.userData.distance * Math.cos(angle);
                    planet.position.z = planet.userData.distance * Math.sin(angle);
                    planet.rotation.y += planet.userData.selfRotationSpeed * solarSystemSpeedFactor; // Add self-rotation
                });

                solarSystemRenderer.render(solarSystemScene, solarSystemCamera);
            }

            animateSolarSystem(); // Start the animation loop

            // Handle window resize for responsiveness
            window.addEventListener('resize', () => {
                const width = container.clientWidth;
                const height = container.clientHeight;
                solarSystemCamera.aspect = width / height;
                solarSystemCamera.updateProjectionMatrix();
                solarSystemRenderer.setSize(width, height);
                canvas.width = width;
                canvas.height = height;
            });
        }

        // Function to handle clicks on the Solar System canvas
        function onSolarSystemCanvasClick(event) {
            // Get the bounding rectangle of the canvas
            const canvasBounds = solarSystemRenderer.domElement.getBoundingClientRect();
            // Calculate mouse position relative to the canvas
            solarSystemMouse.x = ((event.clientX - canvasBounds.left) / canvasBounds.width) * 2 - 1;
            solarSystemMouse.y = - ((event.clientY - canvasBounds.top) / canvasBounds.height) * 2 + 1;

            // Update the raycaster with the camera and mouse position
            solarSystemRaycaster.setFromCamera(solarSystemMouse, solarSystemCamera);

            // Include both Sun and Planets for intersection detection
            const objectsToIntersect = [solarSystemSun, ...solarSystemPlanets];
            const intersects = solarSystemRaycaster.intersectObjects(objectsToIntersect);

            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                // Ensure it's an object with defined userData (planet or sun)
                if (clickedObject.userData && clickedObject.userData.name) {
                    showPlanetInfo(clickedObject.userData);
                }
            }
        }

        // --- Three.js Constellations (ENHANCED) ---
        let constellationsScene, constellationsCamera, constellationsRenderer, constellationsRaycaster, constellationsMouse;
        let constellationsStars = []; // Store actual star Mesh objects
        let constellationsAnimationId;
        let starLabels = {}; // To manage HTML labels for stars
        let hoveredStar = null; // To track the currently hovered star

        const constellationData = [
            {
                name: "Orion",
                description: "The Hunter, one of the most recognizable constellations. Famous for its belt and bright stars Betelgeuse and Rigel.",
                stars: [
                    { id: "betelgeuse", name: "Betelgeuse", x: 40, y: 50, z: 10, info: "A red supergiant, one of the largest and brightest stars. It forms Orion's right shoulder." },
                    { id: "bellatrix", name: "Bellatrix", x: -40, y: 45, z: -10, info: "A blue-white giant star, forming Orion's left shoulder." },
                    { id: "alnilam", name: "Alnilam", x: 0, y: 0, z: 0, info: "The central star in Orion's Belt, a luminous blue supergiant." },
                    { id: "alnitak", name: "Alnitak", x: -20, y: -5, z: -5, info: "The easternmost star in Orion's Belt." },
                    { id: "mintaka", name: "Mintaka", x: 20, y: 5, z: 5, info: "The westernmost star in Orion's Belt." },
                    { id: "saiph", name: "Saiph", x: -35, y: -50, z: -15, info: "A blue supergiant, marking Orion's right knee." },
                    { id: "rigel", name: "Rigel", x: 35, y: -55, z: 15, info: "A brilliant blue-white supergiant, the brightest star in Orion, marking his left foot." }
                ],
                lines: [
                    ["betelgeuse", "mintaka"], ["mintaka", "rigel"], ["rigel", "saiph"], ["saiph", "alnitak"], ["alnitak", "betelgeuse"],
                    ["mintaka", "alnilam"], ["alnilam", "alnitak"],
                    ["betelgeuse", "bellatrix"], ["saiph", "bellatrix"]
                ]
            },
            {
                name: "Ursa Major",
                description: "The Great Bear, famous for containing the Big Dipper asterism.",
                stars: [
                    { id: "dubhe", name: "Dubhe", x: -60, y: 40, z: 0, info: "A pointer star in the Big Dipper, helping to locate Polaris." },
                    { id: "merak", name: "Merak", x: -80, y: -20, z: 0, info: "The other pointer star in the Big Dipper's bowl." },
                    { id: "phecda", name: "Phecda", x: -20, y: -30, z: 0, info: "The star at the bottom left of the Big Dipper's bowl." },
                    { id: "megrez", name: "Megrez", x: 0, y: 20, z: 0, info: "The star connecting the bowl to the handle." },
                    { id: "alioth", name: "Alioth", x: 40, y: 30, z: 0, info: "The brightest star in Ursa Major, located in the handle." },
                    { id: "mizar", name: "Mizar", x: 80, y: 20, z: 0, info: "A famous double star in the middle of the handle." },
                    { id: "alkaid", name: "Alkaid", x: 100, y: -10, z: 0, info: "The star at the end of the Big Dipper's handle." }
                ],
                lines: [
                    ["dubhe", "merak"], ["merak", "phecda"], ["phecda", "megrez"], ["megrez", "dubhe"],
                    ["megrez", "alioth"], ["alioth", "mizar"], ["mizar", "alkaid"]
                ]
            },
            {
                name: "Cassiopeia",
                description: "The Queen, easily recognizable by its 'W' shape.",
                stars: [
                    { id: "schedar", name: "Schedar", x: -60, y: -20, z: 10, info: "An orange giant, the brightest star in Cassiopeia." },
                    { id: "caph", name: "Caph", x: -30, y: 20, z: 5, info: "A white giant star." },
                    { id: "gamma_cas", name: "Gamma Cassiopeiae", x: 0, y: -10, z: 0, info: "A blue subgiant that is the central star of the 'W'." },
                    { id: "ruchbah", name: "Ruchbah", x: 30, y: 20, z: -5, info: "A binary star system." },
                    { id: "segin", name: "Segin", x: 60, y: -20, z: -10, info: "A blue-white giant star." }
                ],
                lines: [
                    ["schedar", "caph"], ["caph", "gamma_cas"], ["gamma_cas", "ruchbah"], ["ruchbah", "segin"]
                ]
            },
            {
                name: "Leo",
                description: "The Lion, which contains the Sickle asterism, a backward question mark.",
                stars: [
                    { id: "regulus", name: "Regulus", x: -50, y: -60, z: 0, info: "The brightest star in Leo, a blue-white main-sequence star." },
                    { id: "algieba", name: "Algieba", x: 0, y: 40, z: 10, info: "A binary star system, appearing as a single bright star." },
                    { id: "denebola", name: "Denebola", x: 80, y: -50, z: -10, info: "A rapidly rotating star, marking the lion's tail." },
                    { id: "zossma", name: "Zosma", x: 40, y: -30, z: 5, info: "A white main-sequence star." },
                    { id: "chertan", name: "Chertan", x: 60, y: -40, z: -5, info: "A white giant star." },
                    { id: "rasalas", name: "Rasalas", x: -30, y: 20, z: 15, info: "A star in the lion's head." }
                ],
                lines: [
                    ["regulus", "algieba"], ["algieba", "rasalas"], ["rasalas", "zossma"], ["zossma", "denebola"], ["denebola", "chertan"], ["chertan", "regulus"]
                ]
            },
            {
                name: "Scorpius",
                description: "The Scorpion, a large constellation in the southern hemisphere, with the bright red star Antares.",
                stars: [
                    { id: "antares", name: "Antares", x: 0, y: 0, z: 0, info: "A red supergiant, the heart of the scorpion." },
                    { id: "graffias", name: "Graffias", x: -40, y: 50, z: 10, info: "A triple star system, part of the scorpion's claws." },
                    { id: "dschubba", name: "Dschubba", x: -20, y: 30, z: 5, info: "A multiple star system, also in the claws." },
                    { id: "sargas", name: "Sargas", x: 40, y: -70, z: -15, info: "A bright giant star in the scorpion's tail." },
                    { id: "shaula", name: "Shaula", x: 60, y: -90, z: -20, info: "The second-brightest star in Scorpius, marking the stinger." },
                    { id: "lesath", name: "Lesath", x: 55, y: -85, z: -18, info: "A hot blue-white star, close to Shaula in the stinger." }
                ],
                lines: [
                    ["graffias", "dschubba"], ["dschubba", "antares"], ["antares", "sargas"], ["sargas", "shaula"], ["shaula", "lesath"]
                ]
            },
            {
                name: "Cygnus",
                description: "The Swan, which contains the Northern Cross asterism.",
                stars: [
                    { id: "deneb", name: "Deneb", x: 0, y: 80, z: 0, info: "A blue-white supergiant, one of the most distant stars visible to the naked eye." },
                    { id: "albireo", name: "Albireo", x: 0, y: -80, z: 10, info: "A beautiful double star with contrasting colors, often called the 'beak star'." },
                    { id: "sadr", name: "Sadr", x: 0, y: 0, z: -5, info: "A supergiant star at the center of the Northern Cross." },
                    { id: "fawaris", name: "Fawaris", x: -50, y: 10, z: 5, info: "A star forming the western arm of the cross." },
                    { id: "glenah", name: "Gienah", x: 50, y: 10, z: -10, info: "A star forming the eastern arm of the cross." }
                ],
                lines: [
                    ["deneb", "sadr"], ["sadr", "albireo"], ["sadr", "fawaris"], ["sadr", "glenah"]
                ]
            },
            {
                name: "Taurus",
                description: "The Bull, known for the bright star Aldebaran and the Pleiades star cluster.",
                stars: [
                    { id: "aldebaran", name: "Aldebaran", x: 0, y: 0, z: 0, info: "A red giant, the 'eye' of the bull." },
                    { id: "elnath", name: "Elnath", x: 60, y: 50, z: 10, info: "A blue-white giant, marking the tip of the bull's northern horn." },
                    { id: "tianguan", name: "Tianguan", x: -50, y: 40, z: 5, info: "A star marking the tip of the bull's southern horn." },
                    { id: "hyadum_i", name: "Hyadum I", x: -20, y: -20, z: -5, info: "Part of the Hyades star cluster, which forms the bull's face." },
                    { id: "hyadum_ii", name: "Hyadum II", x: 20, y: -20, z: -8, info: "Another star in the Hyades cluster." }
                ],
                lines: [
                    ["hyadum_i", "aldebaran"], ["aldebaran", "hyadum_ii"], ["aldebaran", "elnath"], ["aldebaran", "tianguan"]
                ]
            }
        ];

        function initConstellations() {
            if (constellationsAnimationId) cancelAnimationFrame(constellationsAnimationId);
            if (constellationsScene) disposeThreeJsObject(constellationsScene);

            const container = document.getElementById('constellations-3d-container');
            const canvas = document.getElementById('constellations-canvas');
            const labelsContainer = document.getElementById('constellation-labels-container');

            if (!container || !canvas || !labelsContainer) {
                console.error("Constellations elements not found.");
                return;
            }

            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            labelsContainer.innerHTML = ''; // Clear old labels

            constellationsScene = new THREE.Scene();
            constellationsCamera = new THREE.PerspectiveCamera(60, canvas.clientWidth / canvas.clientHeight, 0.1, 2000);
            constellationsRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            constellationsRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
            constellationsRenderer.setPixelRatio(window.devicePixelRatio);
            constellationsRenderer.setClearColor(0x000000, 0);

            constellationsCamera.position.z = 200;

            // FIX: Initialize mouse vector here to prevent error on the first animation frame
            constellationsMouse = new THREE.Vector2();

            // Add a more dynamic, twinkling starfield background
            const bgStarsGeometry = new THREE.BufferGeometry();
            const bgStarVertices = [];
            const bgStarColors = [];
            const color = new THREE.Color();
            for (let i = 0; i < 15000; i++) {
                const x = THREE.MathUtils.randFloatSpread(2000);
                const y = THREE.MathUtils.randFloatSpread(2000);
                const z = THREE.MathUtils.randFloatSpread(2000);
                bgStarVertices.push(x, y, z);
                color.setHSL(Math.random(), 0.1, 0.5 + Math.random() * 0.2);
                bgStarColors.push(color.r, color.g, color.b);
            }
            bgStarsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(bgStarVertices, 3));
            bgStarsGeometry.setAttribute('color', new THREE.Float32BufferAttribute(bgStarColors, 3));
            const bgStarMaterial = new THREE.PointsMaterial({ size: 1, vertexColors: true, transparent: true });
            const backgroundStars = new THREE.Points(bgStarsGeometry, bgStarMaterial);
            constellationsScene.add(backgroundStars);

            const starTexture = new THREE.TextureLoader().load('https://placehold.co/64x64/ffffff/ffffff.png'); // Simple white dot for glow
            const baseStarMaterial = new THREE.SpriteMaterial({ map: starTexture, color: 0xffffff, blending: THREE.AdditiveBlending, transparent: true, opacity: 0.8 });
            const hoverStarMaterial = new THREE.SpriteMaterial({ map: starTexture, color: 0x99ccff, blending: THREE.AdditiveBlending, transparent: true, opacity: 1 });

            const lineMaterial = new THREE.LineBasicMaterial({ color: 0x4a90e2, transparent: true, opacity: 0.3 });
            const mythMaterial = new THREE.LineBasicMaterial({ color: 0x8e44ad, transparent: true, opacity: 0, fog: false });

            constellationsStars = [];
            starLabels = {};

            constellationData.forEach((constellation, cIdx) => {
                const constellationGroup = new THREE.Group();
                // Distribute constellations in a grid-like pattern
                const angle = (cIdx / constellationData.length) * Math.PI * 2;
                const radius = 250;
                constellationGroup.position.x = radius * Math.cos(angle);
                constellationGroup.position.y = radius * Math.sin(angle);
                constellationGroup.position.z = Math.random() * 100 - 50;


                const starMap = new Map();

                // Create stars with sprites for glow effect
                constellation.stars.forEach(starData => {
                    const starSprite = new THREE.Sprite(baseStarMaterial.clone());
                    starSprite.position.set(starData.x, starData.y, starData.z);
                    starSprite.scale.set(4, 4, 1); // Base size
                    starSprite.userData = { ...starData, constellationName: constellation.name, constellationDesc: constellation.description, type: 'star' };
                    constellationGroup.add(starSprite);
                    constellationsStars.push(starSprite);
                    starMap.set(starData.id, starSprite.position);

                    // Create HTML labels
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'star-label';
                    labelDiv.textContent = starData.name;
                    labelsContainer.appendChild(labelDiv);
                    starLabels[starData.id] = { element: labelDiv, star: starSprite };
                });

                // Create animated constellation lines
                constellation.lines.forEach(line => {
                    const startPos = starMap.get(line[0]);
                    const endPos = starMap.get(line[1]);
                    if (startPos && endPos) {
                        const geometry = new THREE.BufferGeometry().setFromPoints([startPos, startPos]); // Start with a zero-length line
                        const lineMesh = new THREE.Line(geometry, lineMaterial.clone());
                        lineMesh.userData = { type: 'line', start: startPos, end: endPos, progress: 0 };
                        constellationGroup.add(lineMesh);
                    }
                });

                constellationsScene.add(constellationGroup);
            });

            // Camera Controls
            let isDragging = false, prevMouseX = 0, prevMouseY = 0;
            canvas.onmousedown = e => { isDragging = true; prevMouseX = e.clientX; prevMouseY = e.clientY; };
            canvas.onmouseup = () => isDragging = false;
            canvas.onmouseleave = () => isDragging = false;
            canvas.onmousemove = e => {
                if (isDragging) {
                    const deltaX = e.clientX - prevMouseX;
                    const deltaY = e.clientY - prevMouseY;
                    constellationsScene.rotation.y += deltaX * 0.005;
                    constellationsScene.rotation.x += deltaY * 0.005;
                    prevMouseX = e.clientX; prevMouseY = e.clientY;
                }
                // Hover detection
                const canvasBounds = canvas.getBoundingClientRect();
                // FIX: Update the existing mouse vector instead of creating a new one
                constellationsMouse.x = ((e.clientX - canvasBounds.left) / canvasBounds.width) * 2 - 1;
                constellationsMouse.y = -((e.clientY - canvasBounds.top) / canvasBounds.height) * 2 + 1;
            };
            canvas.onwheel = e => {
                e.preventDefault();
                constellationsCamera.position.z += e.deltaY * 0.1;
                constellationsCamera.position.z = Math.max(80, Math.min(600, constellationsCamera.position.z));
            };
            
            // Raycaster for interaction
            constellationsRaycaster = new THREE.Raycaster();
            canvas.addEventListener('click', onConstellationsCanvasClick);

            const clock = new THREE.Clock();
            function animateConstellations() {
                constellationsAnimationId = requestAnimationFrame(animateConstellations);
                const delta = clock.getDelta();
                const elapsedTime = clock.getElapsedTime();

                // Animate twinkling background stars
                backgroundStars.material.opacity = 0.5 + Math.sin(elapsedTime * 0.5) * 0.2;

                // Animate drawing of constellation lines
                constellationsScene.children.forEach(group => {
                    group.children.forEach(child => {
                        if (child.userData.type === 'line' && child.userData.progress < 1) {
                            child.userData.progress += delta * 0.5; // Animation speed
                            const currentPos = new THREE.Vector3().lerpVectors(child.userData.start, child.userData.end, child.userData.progress);
                            child.geometry.setFromPoints([child.userData.start, currentPos]);
                            child.geometry.verticesNeedUpdate = true;
                        }
                    });
                });

                // Hover effect logic
                constellationsRaycaster.setFromCamera(constellationsMouse, constellationsCamera);
                const intersects = constellationsRaycaster.intersectObjects(constellationsStars);
                
                if (intersects.length > 0) {
                    const intersectedStar = intersects[0].object;
                    if (hoveredStar !== intersectedStar) {
                        if (hoveredStar) { // Reset previous star
                           hoveredStar.scale.set(4, 4, 1);
                        }
                        hoveredStar = intersectedStar;
                        hoveredStar.scale.set(8, 8, 1); // Enlarge hovered star
                    }
                } else {
                    if (hoveredStar) { // Reset when no star is hovered
                        hoveredStar.scale.set(4, 4, 1);
                        hoveredStar = null;
                    }
                }
                
                // Update HTML labels position
                Object.values(starLabels).forEach(({ element, star }) => {
                    const vector = new THREE.Vector3().copy(star.position);
                    const parentGroup = star.parent;
                    if(parentGroup) {
                        vector.applyMatrix4(parentGroup.matrixWorld);
                    }
                    vector.project(constellationsCamera);

                    const x = (vector.x * 0.5 + 0.5) * canvas.clientWidth;
                    const y = (vector.y * -0.5 + 0.5) * canvas.clientHeight;
                    
                    const isVisible = vector.z < 1;
                    element.style.left = `${x}px`;
                    element.style.top = `${y}px`;
                    
                    const distance = star.position.distanceTo(constellationsCamera.position);
                    const opacity = isVisible ? Math.min(1, 150 / distance) : 0;
                    
                    element.style.opacity = opacity;
                    if(star === hoveredStar) {
                        element.style.opacity = 1;
                        element.style.transform = 'translate(-50%, -200%) scale(1.2)';
                        element.style.color = '#99ccff';
                    } else {
                        element.style.transform = 'translate(-50%, -150%) scale(1)';
                        element.style.color = 'rgba(255, 255, 255, 0.7)';
                    }
                });

                // Pulsating effect for all stars
                constellationsStars.forEach(star => {
                    if (star !== hoveredStar) {
                        const scale = 4 + Math.sin(elapsedTime * 2 + star.position.x) * 0.5;
                        star.scale.set(scale, scale, 1);
                    }
                });


                constellationsRenderer.render(constellationsScene, constellationsCamera);
            }
            animateConstellations();

            window.addEventListener('resize', () => {
                const width = container.clientWidth;
                const height = container.clientHeight;
                constellationsCamera.aspect = width / height;
                constellationsCamera.updateProjectionMatrix();
                constellationsRenderer.setSize(width, height);
                canvas.width = width;
                canvas.height = height;
            });
        }

        // Function to handle clicks on the Constellations canvas
        function onConstellationsCanvasClick(event) {
            if (hoveredStar && hoveredStar.userData.info) {
                showStarInfo(hoveredStar.userData);
            }
        }

        // --- AI Chatbot Logic ---
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const chatOutput = document.getElementById('chat-output');
        const chatLoading = document.getElementById('chat-loading');

        // Stores conversation history to maintain context for the AI
        let chatHistory = [];

        // Function to send a message to the AI chatbot
        async function sendMessage() {
            const prompt = chatInput.value.trim();
            if (prompt === "") return; // Don't send empty messages

            // Display user's message in the chat output
            const userMessageDiv = document.createElement('div');
            userMessageDiv.classList.add('flex', 'justify-end'); // Align to the right for user messages
            userMessageDiv.innerHTML = `<div class="bg-purple-600 text-white p-3 rounded-lg max-w-xs md:max-w-md">${prompt}</div>`;
            chatOutput.appendChild(userMessageDiv);
            chatOutput.scrollTop = chatOutput.scrollHeight; // Scroll to the newest message

            chatInput.value = ''; // Clear input field
            chatLoading.classList.remove('hidden'); // Show loading indicator
            sendChatBtn.disabled = true; // Disable send button to prevent multiple submissions

            try {
                // Add user's message to chat history for context
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // API key will be provided by the Canvas runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                // Make the API call to Gemini
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json(); // Parse the JSON response

                // Check if the AI response is valid and contains text
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;

                    // Display AI's response in the chat output
                    const aiMessageDiv = document.createElement('div');
                    aiMessageDiv.classList.add('flex', 'justify-start'); // Align to the left for AI messages
                    aiMessageDiv.innerHTML = `<div class="bg-blue-600 text-white p-3 rounded-lg max-w-xs md:max-w-md">${text}</div>`;
                    chatOutput.appendChild(aiMessageDiv);
                    chatOutput.scrollTop = chatOutput.scrollHeight; // Scroll to the newest message

                    // Add AI's response to chat history
                    chatHistory.push({ role: "model", parts: [{ text: text }] });

                } else {
                    console.error("AI response structure unexpected:", result);
                    const errorMessageDiv = document.createElement('div');
                    errorMessageDiv.classList.add('flex', 'justify-start');
                    errorMessageDiv.innerHTML = `<div class="bg-red-600 text-white p-3 rounded-lg max-w-xs md:max-w-md">Error: Could not get a response. Please try again.</div>`;
                    chatOutput.appendChild(errorMessageDiv);
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.classList.add('flex', 'justify-start');
                errorMessageDiv.innerHTML = `<div class="bg-red-600 text-white p-3 rounded-lg max-w-xs md:max-w-md">Network Error: Could not connect to the AI.</div>`;
                chatOutput.appendChild(errorMessageDiv);
            } finally {
                chatLoading.classList.add('hidden'); // Hide loading indicator
                sendChatBtn.disabled = false; // Re-enable send button
            }
        }

        // Event listeners for sending messages (click and Enter key)
        sendChatBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // --- Space Quiz Logic ---
        // Quiz data organized by difficulty
        const quizData = {
            easy: [
                { question: "Which planet is known as the 'Red Planet'?", options: ["Jupiter", "Mars", "Venus", "Saturn"], answer: "Mars" },
                { question: "What is the largest planet in our solar system?", options: ["Earth", "Mars", "Jupiter", "Neptune"], answer: "Jupiter" },
                { question: "What galaxy do we live in?", options: ["Andromeda", "Triangulum", "Pinwheel", "Milky Way"], answer: "Milky Way" }
            ],
            medium: [
                { question: "What is the name of the first artificial satellite launched into space?", options: ["Explorer 1", "Sputnik 1", "Vanguard 1", "Telstar 1"], answer: "Sputnik 1" },
                { question: "Which moon of Saturn is known for its thick atmosphere and lakes of liquid methane?", options: ["Titan", "Enceladus", "Rhea", "Iapetus"], answer: "Titan" },
                { question: "What astronomical unit is defined as the average distance between the Earth and the Sun?", options: ["Light-year", "Parsec", "Astronomical Unit (AU)", "Kilometer"], answer: "Astronomical Unit (AU)" }
            ],
            hard: [
                { question: "What is the theoretical boundary around a black hole beyond which no light or information can escape?", options: ["Singularity", "Accretion Disk", "Event Horizon", "Photon Sphere"], answer: "Event Horizon" },
                { question: "Which space telescope was launched in 1990 and has provided incredible images of the universe?", options: ["James Webb", "Chandra", "Hubble", "Kepler"], answer: "Hubble" },
                { question: "What is the process by which a star generates energy by fusing lighter elements into heavier ones?", options: ["Nuclear Fission", "Chemical Reaction", "Nuclear Fusion", "Gravitational Collapse"], answer: "Nuclear Fusion" }
            ]
        };

        let currentQuizQuestions = []; // Stores questions for the current quiz difficulty
        let currentQuestionIndex = 0; // Tracks the current question
        let score = 0; // Tracks the user's score

        // Get references to quiz UI elements
        const quizIntro = document.getElementById('quiz-intro');
        const quizQuestionsDiv = document.getElementById('quiz-questions');
        const quizResultDiv = document.getElementById('quiz-result');
        const questionText = document.getElementById('question-text');
        const answerOptions = document.getElementById('answer-options');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const scoreText = document.getElementById('score-text');
        const quizDifficulty = document.getElementById('quiz-difficulty');

        // Get references to quiz difficulty buttons and reset button
        const startEasyQuizBtn = document.getElementById('start-easy-quiz');
        const startMediumQuizBtn = document.getElementById('start-medium-quiz');
        const startHardQuizBtn = document.getElementById('start-hard-quiz');
        const resetQuizBtn = document.getElementById('reset-quiz-btn');

        // Function to start the quiz based on selected difficulty
        function startQuiz(difficulty) {
            currentQuizQuestions = quizData[difficulty]; // Load questions for selected difficulty
            currentQuestionIndex = 0;
            score = 0;
            quizDifficulty.textContent = `Difficulty: ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`; // Display difficulty

            quizIntro.classList.add('hidden'); // Hide intro screen
            quizQuestionsDiv.classList.remove('hidden'); // Show questions screen
            quizResultDiv.classList.add('hidden'); // Ensure result screen is hidden
            loadQuestion(); // Load the first question
        }

        // Function to load and display the current question
        function loadQuestion() {
            if (currentQuestionIndex < currentQuizQuestions.length) {
                const q = currentQuizQuestions[currentQuestionIndex];
                questionText.textContent = q.question;
                answerOptions.innerHTML = ''; // Clear previous answer options

                // Create buttons for each answer option
                q.options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.classList.add('btn-gradient', 'text-white', 'py-2', 'px-5', 'rounded-full', 'hover:bg-opacity-80', 'transition', 'duration-200', 'text-base-mobile');
                    // Attach click listener to check answer
                    button.addEventListener('click', () => selectAnswer(option, q.answer, button)); // Use addEventListener
                    answerOptions.appendChild(button);
                });
                nextQuestionBtn.style.display = 'none'; // Hide "Next Question" button until an answer is selected
            } else {
                showResult(); // If all questions answered, show results
            }
        }

        // Function to handle answer selection and check correctness
        function selectAnswer(selectedOption, correctAnswer, clickedButton) {
            // Disable all answer options after one is selected
            Array.from(answerOptions.children).forEach(btn => btn.disabled = true);

            if (selectedOption === correctAnswer) {
                score++;
                clickedButton.classList.remove('btn-gradient'); // Remove gradient style
                clickedButton.classList.add('bg-green-600', 'hover:bg-green-700'); // Style as correct
            } else {
                clickedButton.classList.remove('btn-gradient'); // Remove gradient style
                clickedButton.classList.add('bg-red-600', 'hover:bg-red-700'); // Style as incorrect
                // Highlight the correct answer
                Array.from(answerOptions.children).forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.remove('btn-gradient');
                        btn.classList.add('bg-green-600', 'border-2', 'border-white'); // Highlight correct answer
                    }
                });
            }
            nextQuestionBtn.style.display = 'block'; // Show "Next Question" button
        }

        // Event listener for "Next Question" button
        nextQuestionBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            loadQuestion(); // Load the next question
        });

        // Function to display the quiz result
        function showResult() {
            quizQuestionsDiv.classList.add('hidden'); // Hide questions
            quizResultDiv.classList.remove('hidden'); // Show results
            scoreText.textContent = `You scored ${score} out of ${currentQuizQuestions.length}!`; // Display final score
        }

        // Function to reset the quiz and go back to the intro screen
        function resetQuiz() {
            quizIntro.classList.remove('hidden');
            quizResultDiv.classList.add('hidden');
        }

        // Event listeners for quiz difficulty and reset buttons
        startEasyQuizBtn.addEventListener('click', () => startQuiz('easy'));
        startMediumQuizBtn.addEventListener('click', () => startQuiz('medium'));
        startHardQuizBtn.addEventListener('click', () => startQuiz('hard'));
        resetQuizBtn.addEventListener('click', resetQuiz);

        // --- Cosmic Calendar Logic (API Integrated) ---

        // Helper function to format date toemplate-MM-DD
        function formatDateToYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Expanded static events database
        const staticEvents = {
            "Historical": {
                "01-04": "Sputnik 1, first artificial satellite, burns up in atmosphere (1958).",
                "07-20": "Apollo 11 lands on the Moon (1969).",
                "10-04": "Sputnik 1 launched by the Soviet Union (1957)."
            },
            "Meteor Shower": {
                "01-03": "Quadrantids Meteor Shower peak.",
                "04-22": "Lyrids Meteor Shower peak.",
                "05-05": "Eta Aquariids Meteor Shower peak.",
                "07-28": "Delta Aquariids Meteor Shower peak.",
                "08-12": "Perseids Meteor Shower peak.",
                "10-21": "Orionids Meteor Shower peak.",
                "11-17": "Leonids Meteor Shower peak.",
                "12-14": "Geminids Meteor Shower peak."
            },
            "Eclipse": {
                "2024-04-08": "Total Solar Eclipse over North America.",
                "2024-10-02": "Annular Solar Eclipse over South America.",
                "2026-08-12": "Total Solar Eclipse over Greenland, Iceland, Spain."
            }
        };

        // State variables for the calendar
        let currentCalendarDate = new Date();
        let eventCache = {}; // Cache for fetched API data, e.g., {"2024-07": [events]}
        let currentFilter = 'all';

        // UI Element references
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthYear = document.getElementById('current-month-year');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const prevYearBtn = document.getElementById('prev-year');
        const nextYearBtn = document.getElementById('next-year');
        const eventFilterSelect = document.getElementById('event-filter');
        const calendarLoading = document.getElementById('calendar-loading');

        // Fetches events for a given month and year, combining API and static data
        async function fetchEventsForMonth(year, month) {
            const cacheKey = `${year}-${month}`;
            if (eventCache[cacheKey]) {
                return eventCache[cacheKey]; // Return cached data if available
            }

            calendarLoading.classList.remove('hidden'); // Show loading spinner

            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const startDate = formatDateToYYYYMMDD(firstDay);
            const endDate = formatDateToYYYYMMDD(lastDay);

            const launchApiUrl = `https://ll.thespacedevs.com/2.2.0/launch/?net__gte=${startDate}T00:00:00Z&net__lte=${endDate}T23:59:59Z&limit=100`;
            
            let allEvents = {};

            try {
                // Fetch launch data from Launch Library 2 API
                const response = await fetch(launchApiUrl);
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const data = await response.json();
                
                data.results.forEach(launch => {
                    const date = launch.net.split('T')[0]; // Extractemplate-MM-DD
                    if (!allEvents[date]) allEvents[date] = [];
                    allEvents[date].push({
                        type: 'Rocket Launch',
                        title: launch.name,
                        description: launch.mission ? launch.mission.description : 'No description available.',
                        url: launch.url // URL for more details
                    });
                });
            } catch (error) {
                console.error("Failed to fetch launch data:", error);
                // Optionally show an error message to the user
            }

            // Merge with static events
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month - 1, day);
                const dateString = formatDateToYYYYMMDD(date);
                const monthDayString = dateString.substring(5); // "MM-DD" format

                Object.keys(staticEvents).forEach(type => {
                    let eventDescription = null;
                    if (type === "Eclipse") {
                        eventDescription = staticEvents[type][dateString];
                    } else {
                        eventDescription = staticEvents[type][monthDayString];
                    }
                    
                    if (eventDescription) {
                        if (!allEvents[dateString]) allEvents[dateString] = [];
                        allEvents[dateString].push({
                            type: type,
                            title: eventDescription,
                            description: `A recurring ${type.toLowerCase()} event.`,
                            url: null
                        });
                    }
                });
            }

            eventCache[cacheKey] = allEvents; // Cache the combined results
            calendarLoading.classList.add('hidden'); // Hide loading spinner
            return allEvents;
        }

        // Renders the calendar grid with events
        async function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth() + 1;
            
            const eventsForMonth = await fetchEventsForMonth(year, month);

            calendarGrid.innerHTML = ''; // Clear previous days
            currentMonthYear.textContent = currentCalendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month - 1, 1);
            const lastDayOfMonth = new Date(year, month, 0);
            const numDaysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay();

            for (let i = 0; i < firstDayOfWeek; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= numDaysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dateString = formatDateToYYYYMMDD(date);
                const dayCell = document.createElement('div');
                dayCell.classList.add('p-2', 'text-center', 'rounded-md', 'cursor-pointer', 'transition', 'duration-200', 'relative', 'min-h-[60px]');
                dayCell.textContent = day;

                const today = new Date();
                if (date.toDateString() === today.toDateString()) {
                    dayCell.classList.add('bg-purple-600', 'text-white', 'font-bold');
                } else {
                    dayCell.classList.add('bg-gray-800', 'hover:bg-gray-700');
                }

                const eventsOnDay = eventsForMonth[dateString] || [];
                const filteredEvents = eventsOnDay.filter(event => currentFilter === 'all' || event.type === currentFilter);

                if (filteredEvents.length > 0) {
                    dayCell.dataset.events = JSON.stringify(filteredEvents); // Store events in the cell
                    dayCell.addEventListener('click', () => showEventsForDate(dateString, filteredEvents));

                    // Add color-coded dots
                    const eventDotContainer = document.createElement('div');
                    eventDotContainer.className = 'event-dot';
                    
                    const eventTypes = [...new Set(filteredEvents.map(e => e.type))]; // Get unique event types
                    eventTypes.slice(0, 4).forEach(type => { // Show max 4 dots
                        const dot = document.createElement('span');
                        dot.style.backgroundColor = getEventColor(type);
                        dot.title = type; // Tooltip for the dot
                        eventDotContainer.appendChild(dot);
                    });
                    dayCell.appendChild(eventDotContainer);
                }
                calendarGrid.appendChild(dayCell);
            }
        }

        // Gets a color based on the event type
        function getEventColor(type) {
            switch (type) {
                case 'Rocket Launch': return '#3498db'; // Blue
                case 'Meteor Shower': return '#f1c40f'; // Yellow
                case 'Eclipse': return '#e74c3c'; // Red
                case 'Historical': return '#9b59b6'; // Purple
                default: return '#95a5a6'; // Gray
            }
        }

        // Displays events for a selected date in the modal
        function showEventsForDate(dateString, events) {
            const formattedDate = new Date(dateString + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            let content = '';

            if (events && events.length > 0) {
                content = '<div class="space-y-4">';
                events.forEach(event => {
                    content += `
                        <div class="border-l-4 p-3 rounded-r-lg bg-gray-800" style="border-color: ${getEventColor(event.type)};">
                            <h5 class="font-bold text-white">${event.title}</h5>
                            <p class="text-sm text-gray-400 font-semibold">${event.type}</p>
                            <p class="text-gray-300 mt-2 text-sm">${event.description}</p>
                            ${event.url ? `<a href="${event.url}" target="_blank" class="text-blue-400 hover:underline mt-2 inline-block">More Info &rarr;</a>` : ''}
                        </div>
                    `;
                });
                content += '</div>';
            } else {
                content = `<p class="text-center text-gray-400">No major event recorded for this date.</p>`;
            }
            showModal(`Events on ${formattedDate}`, content);
        }

        // Event listeners for calendar navigation and filtering
        prevMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        });
        nextMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        });
        prevYearBtn.addEventListener('click', () => {
            currentCalendarDate.setFullYear(currentCalendarDate.getFullYear() - 1);
            renderCalendar();
        });
        nextYearBtn.addEventListener('click', () => {
            currentCalendarDate.setFullYear(currentCalendarDate.getFullYear() + 1);
            renderCalendar();
        });
        eventFilterSelect.addEventListener('change', (e) => {
            currentFilter = e.target.value;
            renderCalendar(); // Re-render with the new filter
        });

        // --- Interactive Visuals: Moon Phases Simulation ---
        let moonPhaseCanvas, moonPhaseCtx, moonPhaseSlider, moonPhaseText;

        // Initializes the Moon Phases canvas and interactivity
        function initMoonPhases() {
            moonPhaseCanvas = document.getElementById('moon-phases-canvas');
            moonPhaseCtx = moonPhaseCanvas.getContext('2d');
            moonPhaseSlider = document.getElementById('moon-phase-slider');
            moonPhaseText = document.getElementById('moon-phase-text');

            if (!moonPhaseCanvas || !moonPhaseCtx || !moonPhaseSlider || !moonPhaseText) {
                console.error("Moon phases simulation elements not found.");
                return;
            }

            // Function to draw the moon phase based on an angle (0-360 degrees)
            function drawMoonPhase(angle) {
                moonPhaseCtx.clearRect(0, 0, moonPhaseCanvas.width, moonPhaseCanvas.height);

                const centerX = moonPhaseCanvas.width / 2;
                const centerY = moonPhaseCanvas.height / 2;
                const radius = Math.min(centerX, centerY) * 0.8;

                // Draw the full circle of the moon (dark side)
                moonPhaseCtx.beginPath();
                moonPhaseCtx.arc(centerX, centerY, radius, 0, Math.PI * 2, false);
                moonPhaseCtx.fillStyle = '#444444'; // Dark gray for the moon's body
                moonPhaseCtx.fill();
                moonPhaseCtx.strokeStyle = '#666666'; // Border color
                moonPhaseCtx.lineWidth = 2;
                moonPhaseCtx.stroke();

                // Calculate the illuminated portion based on the angle
                // Cosine wave ranges from -1 (new moon) to 1 (full moon)
                let illuminatedPortion = Math.cos(angle * Math.PI / 180);
                let phaseText = "";

                // Determine the phase name based on the illuminated portion
                if (illuminatedPortion > 0.95) phaseText = "Full Moon";
                else if (illuminatedPortion < -0.95) phaseText = "New Moon";
                else if (illuminatedPortion > 0.05) phaseText = "Waxing Gibbous"; // More than half lit and growing
                else if (illuminatedPortion < -0.05) phaseText = "Waning Gibbous"; // More than half lit and shrinking
                else if (angle > 0 && angle <= 90) phaseText = "Waxing Crescent";
                else if (angle > 90 && angle <= 180) phaseText = "First Quarter";
                else if (angle > 180 && angle <= 270) phaseText = "Waning Crescent";
                else if (angle > 270 && angle <= 360) phaseText = "Last Quarter";

                moonPhaseText.textContent = phaseText; // Update text display

                // Draw the illuminated part of the moon
                moonPhaseCtx.save(); // Save current canvas state
                moonPhaseCtx.beginPath();
                moonPhaseCtx.arc(centerX, centerY, radius, 0, Math.PI * 2, false); // Draw full moon circle
                moonPhaseCtx.clip(); // Clip everything outside this circle

                moonPhaseCtx.beginPath();
                moonPhaseCtx.arc(centerX, centerY, radius, 0, Math.PI * 2, false); // Full circle again (background for illuminated part)
                moonPhaseCtx.fillStyle = '#dddddd'; // Brighter color for illuminated part
                moonPhaseCtx.fill();

                // Draw the "shadow" to create the crescent/gibbous shapes
                if (Math.abs(illuminatedPortion) < 0.99) { // Only draw shadow if not full or new moon
                    moonPhaseCtx.beginPath();
                    // Create an ellipse for the terminator (line between lit and dark)
                    // The width of the ellipse varies with illuminatedPortion
                    moonPhaseCtx.ellipse(centerX - (radius * illuminatedPortion), centerY, radius * Math.abs(illuminatedPortion), radius, 0, Math.PI / 2, Math.PI * 3 / 2, illuminatedPortion < 0);
                    moonPhaseCtx.fillStyle = '#444444'; // Dark side color
                    if (illuminatedPortion > 0) { // Waxing phases: shadow from right
                        moonPhaseCtx.rect(centerX - radius, 0, radius - (radius * illuminatedPortion), moonPhaseCanvas.height);
                    } else { // Waning phases: shadow from left
                        moonPhaseCtx.rect(centerX + (radius * illuminatedPortion), 0, radius - (radius * Math.abs(illuminatedPortion)), moonPhaseCanvas.height);
                    }
                    moonPhaseCtx.fill();
                }
                moonPhaseCtx.restore(); // Restore canvas state to remove clipping path
            }

            // Update moon phase when slider value changes
            moonPhaseSlider.addEventListener('input', (e) => {
                drawMoonPhase(parseFloat(e.target.value));
            });

            // Initial draw on load
            drawMoonPhase(parseFloat(moonPhaseSlider.value));
        }


        // --- Interactive Visuals: Eclipse Simulation ---
        let eclipseCanvas, eclipseCtx, eclipseAnimationId;

        // Initializes the Eclipse simulation canvas
        function initEclipse() {
            eclipseCanvas = document.getElementById('eclipse-canvas');
            eclipseCtx = eclipseCanvas.getContext('2d');
            const startEclipseBtn = document.getElementById('start-eclipse-sim');

            if (!eclipseCanvas || !eclipseCtx || !startEclipseBtn) {
                console.error("Eclipse simulation elements not found.");
                return;
            }

            // Set canvas dimensions
            eclipseCanvas.width = eclipseCanvas.offsetWidth;
            eclipseCanvas.height = eclipseCanvas.offsetHeight;

            // Parameters for celestial bodies and their movement
            let sunRadius = 50;
            let earthRadius = 20;
            let moonRadius = 10;
            let earthOrbitRadius = 120;
            let moonOrbitRadius = 40;
            let angle = 0; // Starting angle for animation
            let animationSpeed = 0.005; // Speed of the orbital animation

            // Function to draw the eclipse simulation
            function drawEclipse() {
                eclipseCtx.clearRect(0, 0, eclipseCanvas.width, eclipseCanvas.height); // Clear canvas
                eclipseCtx.fillStyle = '#0a0a0a'; // Background color
                eclipseCtx.fillRect(0, 0, eclipseCanvas.width, eclipseCanvas.height); // Fill background

                const centerX = eclipseCanvas.width / 2;
                const centerY = eclipseCanvas.height / 2;

                // Draw Sun (fixed position)
                eclipseCtx.beginPath();
                eclipseCtx.arc(centerX - 100, centerY, sunRadius, 0, Math.PI * 2);
                eclipseCtx.fillStyle = 'yellow';
                eclipseCtx.fill();
                eclipseCtx.closePath();

                // Calculate Earth's position based on its orbit angle
                const earthX = centerX + earthOrbitRadius * Math.cos(angle);
                const earthY = centerY + earthOrbitRadius * Math.sin(angle);

                // Calculate Moon's position (orbiting Earth, faster than Earth orbits Sun)
                const moonX = earthX + moonOrbitRadius * Math.cos(angle * 5);
                const moonY = earthY + moonOrbitRadius * Math.sin(angle * 5);

                // Draw Earth's orbit (dashed line)
                eclipseCtx.beginPath();
                eclipseCtx.arc(centerX, centerY, earthOrbitRadius, 0, Math.PI * 2);
                eclipseCtx.strokeStyle = 'rgba(255,255,255,0.2)';
                eclipseCtx.setLineDash([5, 5]); // Set dashed line style
                eclipseCtx.stroke();
                eclipseCtx.setLineDash([]); // Reset to solid line for other drawings

                // Draw Earth
                eclipseCtx.beginPath();
                eclipseCtx.arc(earthX, earthY, earthRadius, 0, Math.PI * 2);
                eclipseCtx.fillStyle = 'blue';
                eclipseCtx.fill();
                eclipseCtx.closePath();

                // Draw Moon
                eclipseCtx.beginPath();
                eclipseCtx.arc(moonX, moonY, moonRadius, 0, Math.PI * 2);
                eclipseCtx.fillStyle = 'gray';
                eclipseCtx.fill();
                eclipseCtx.closePath();

                // Simple collision/alignment detection for "Eclipse!" message
                const sunX = centerX - 100;
                const tolerance = 10; // Pixels for alignment check
                // Check if Moon is between Sun and Earth, and roughly aligned vertically
                if (Math.abs(moonY - centerY) < tolerance && Math.abs(earthY - centerY) < tolerance &&
                    (moonX > sunX && moonX < earthX) || (moonX < sunX && moonX > earthX) // Moon is between Sun and Earth
                ) {
                    eclipseCtx.font = '20px Inter';
                    eclipseCtx.fillStyle = 'red';
                    eclipseCtx.textAlign = 'center';
                    eclipseCtx.fillText('ECLIPSE!', centerX, 30);
                }

                angle += animationSpeed; // Increment angle for animation
                eclipseAnimationId = requestAnimationFrame(drawEclipse); // Request next animation frame
            }

            // Event listener to start/restart the simulation
            startEclipseBtn.addEventListener('click', () => {
                if (eclipseAnimationId) {
                    cancelAnimationFrame(eclipseAnimationId); // Stop any existing animation
                }
                angle = 0; // Reset animation angle
                drawEclipse(); // Start drawing
            });

            drawEclipse(); // Initial draw (static)
        }

        // --- Interactive Visuals: Rocket Launch Simulation ---
        let rocketLaunchCanvas, rocketLaunchCtx, rocketAnimationId;

        // Initializes the Rocket Launch simulation canvas
        function initRocketLaunch() {
            rocketLaunchCanvas = document.getElementById('rocket-launch-canvas');
            rocketLaunchCtx = rocketLaunchCanvas.getContext('2d');
            const startRocketBtn = document.getElementById('start-rocket-sim');

            if (!rocketLaunchCanvas || !rocketLaunchCtx || !startRocketBtn) {
                console.error("Rocket launch simulation elements not found.");
                return;
            }

            // Set canvas dimensions
            rocketLaunchCanvas.width = rocketLaunchCanvas.offsetWidth;
            rocketLaunchCanvas.height = rocketLaunchCanvas.offsetHeight;

            // Rocket properties and simulation state
            let rocketX = rocketLaunchCanvas.width / 2;
            let rocketY = rocketLaunchCanvas.height; // Starts at the bottom
            let velocityY = 0; // Vertical velocity
            let launchPhase = 'pre-launch'; // 'pre-launch', 'launch', 'orbit'
            let orbitAngle = 0; // Angle for orbital phase
            const orbitRadius = 150; // Radius of the orbit
            const earthRadius = 50; // Visual radius for Earth's representation

            // Function to draw the rocket simulation
            function drawRocketSimulation() {
                rocketLaunchCtx.clearRect(0, 0, rocketLaunchCanvas.width, rocketLaunchCanvas.height); // Clear canvas
                rocketLaunchCtx.fillStyle = '#0a0a0a'; // Background color
                rocketLaunchCtx.fillRect(0, 0, rocketLaunchCanvas.width, rocketLaunchCanvas.height); // Fill background

                // Draw Earth (bottom part of the canvas)
                rocketLaunchCtx.beginPath();
                rocketLaunchCtx.arc(rocketLaunchCanvas.width / 2, rocketLaunchCanvas.height + earthRadius, earthRadius, 0, Math.PI * 2);
                rocketLaunchCtx.fillStyle = 'darkgreen';
                rocketLaunchCtx.fill();
                rocketLaunchCtx.closePath();

                // Draw atmosphere line and fill
                rocketLaunchCtx.beginPath();
                rocketLaunchCtx.moveTo(0, rocketLaunchCanvas.height - earthRadius);
                rocketLaunchCtx.lineTo(rocketLaunchCanvas.width, rocketLaunchCanvas.height - earthRadius);
                rocketLaunchCtx.strokeStyle = 'rgba(0, 191, 255, 0.5)'; // Light blue for atmosphere
                rocketLaunchCtx.lineWidth = 2;
                rocketLaunchCtx.stroke();
                rocketLaunchCtx.closePath();
                rocketLaunchCtx.fillStyle = 'rgba(0, 191, 255, 0.1)';
                rocketLaunchCtx.fillRect(0, rocketLaunchCanvas.height - earthRadius, rocketLaunchCanvas.width, earthRadius);


                // Draw rocket body
                rocketLaunchCtx.beginPath();
                rocketLaunchCtx.fillStyle = 'silver';
                rocketLaunchCtx.fillRect(rocketX - 10, rocketY - 40, 20, 40); // Main body
                // Draw rocket nose cone
                rocketLaunchCtx.beginPath();
                rocketLaunchCtx.moveTo(rocketX - 10, rocketY - 40);
                rocketLaunchCtx.lineTo(rocketX, rocketY - 60);
                rocketLaunchCtx.lineTo(rocketX + 10, rocketY - 40);
                rocketLaunchCtx.fill();

                // Draw rocket flame during launch phase
                if (launchPhase === 'launch') {
                    rocketLaunchCtx.beginPath();
                    rocketLaunchCtx.moveTo(rocketX - 10, rocketY);
                    rocketLaunchCtx.lineTo(rocketX, rocketY + 20);
                    rocketLaunchCtx.lineTo(rocketX + 10, rocketY);
                    rocketLaunchCtx.fillStyle = 'orange';
                    rocketLaunchCtx.fill();
                }

                // Update rocket position based on current phase
                if (launchPhase === 'launch') {
                    velocityY -= 0.1; // Accelerate upwards (negative Y direction)
                    rocketY += velocityY;

                    // Transition to orbit phase when reaching altitude
                    if (rocketY < rocketLaunchCanvas.height - orbitRadius - 50) {
                        launchPhase = 'orbit';
                    }
                } else if (launchPhase === 'orbit') {
                    orbitAngle += 0.02; // Increment orbit angle for rotation
                    // Calculate orbital position around the canvas center
                    rocketX = rocketLaunchCanvas.width / 2 + orbitRadius * Math.cos(orbitAngle);
                    rocketY = rocketLaunchCanvas.height / 2 + orbitRadius * Math.sin(orbitAngle);

                    // Draw orbital path (dashed circle)
                    rocketLaunchCtx.beginPath();
                    rocketLaunchCtx.arc(rocketLaunchCanvas.width / 2, rocketLaunchCanvas.height / 2, orbitRadius, 0, Math.PI * 2);
                    rocketLaunchCtx.strokeStyle = 'rgba(255,255,255,0.3)';
                    rocketLaunchCtx.setLineDash([5, 5]);
                    rocketLaunchCtx.stroke();
                    rocketLaunchCtx.setLineDash([]); // Reset line style
                }

                rocketAnimationId = requestAnimationFrame(drawRocketSimulation); // Request next animation frame
            }

            // Event listener to start/restart the simulation
            startRocketBtn.addEventListener('click', () => {
                if (rocketAnimationId) {
                    cancelAnimationFrame(rocketAnimationId); // Stop any previous animation
                }
                // Reset rocket state for a new launch
                rocketX = rocketLaunchCanvas.width / 2;
                rocketY = rocketLaunchCanvas.height;
                velocityY = 0;
                launchPhase = 'launch'; // Start in launch phase
                orbitAngle = 0;
                drawRocketSimulation(); // Start the simulation
            });

            drawRocketSimulation(); // Initial draw (static view before launch)
        }

        // --- Mini Games: Gravity Slingshot Simulator ---
        let slingshotCanvas, slingshotCtx, slingshotAnimationId;

        // Initializes the Gravity Slingshot game
        function initSlingshotGame() {
            slingshotCanvas = document.getElementById('slingshot-canvas');
            slingshotCtx = slingshotCanvas.getContext('2d');
            const startSlingshotBtn = document.getElementById('start-slingshot');

            if (!slingshotCanvas || !slingshotCtx || !startSlingshotBtn) {
                console.error("Slingshot game elements not found.");
                return;
            }

            slingshotCanvas.width = slingshotCanvas.offsetWidth;
            slingshotCanvas.height = slingshotCanvas.offsetHeight;

            // Player ship properties
            let player = { x: 50, y: slingshotCanvas.height / 2, radius: 5, vx: 2, vy: 0, color: 'white' };
            // Planet (gravity source) properties
            let planet = { x: slingshotCanvas.width - 100, y: slingshotCanvas.height / 2, radius: 30, color: 'blue' };
            let gameActive = false; // Game state

            // Function to draw the game elements
            function drawSlingshot() {
                slingshotCtx.clearRect(0, 0, slingshotCanvas.width, slingshotCanvas.height); // Clear canvas
                slingshotCtx.fillStyle = '#0a0a0a'; // Background color
                slingshotCtx.fillRect(0, 0, slingshotCanvas.width, slingshotCanvas.height); // Fill background

                // Draw planet
                slingshotCtx.beginPath();
                slingshotCtx.arc(planet.x, planet.y, planet.radius, 0, Math.PI * 2);
                slingshotCtx.fillStyle = planet.color;
                slingshotCtx.fill();

                // Draw player ship
                slingshotCtx.beginPath();
                slingshotCtx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
                slingshotCtx.fillStyle = player.color;
                slingshotCtx.fill();

                if (gameActive) {
                    // Update player position based on velocity
                    player.x += player.vx;
                    player.y += player.vy;

                    // Calculate gravity effect from the planet
                    const dx = planet.x - player.x;
                    const dy = planet.y - player.y;
                    const distSq = dx * dx + dy * dy; // Distance squared
                    const dist = Math.sqrt(distSq); // Actual distance

                    if (dist > planet.radius + player.radius / 2) { // Apply gravity only if not colliding
                        const G = 50; // Simplified Gravitational constant
                        const force = G / distSq; // Inverse square law for force
                        player.vx += force * (dx / dist); // Update x velocity component
                        player.vy += force * (dy / dist); // Update y velocity component
                    } else {
                        // Collision with planet detected
                        gameActive = false;
                        player.color = 'red'; // Indicate collision visually
                        alertBox("Collision!", "Your ship hit the planet!", () => resetSlingshotGame());
                    }

                    // Boundary check: if player goes off-screen
                    if (player.x < 0 || player.x > slingshotCanvas.width || player.y < 0 || player.y > slingshotCanvas.height) {
                        gameActive = false;
                        player.color = 'gray'; // Indicate lost visually
                        alertBox("Lost in Space!", "Your ship drifted too far!", () => resetSlingshotGame());
                    }
                }

                slingshotAnimationId = requestAnimationFrame(drawSlingshot); // Request next animation frame
            }

            // Function to reset the game state
            function resetSlingshotGame() {
                player = { x: 50, y: slingshotCanvas.height / 2, radius: 5, vx: 2, vy: 0, color: 'white' };
                gameActive = false;
                if (slingshotAnimationId) cancelAnimationFrame(slingshotAnimationId); // Stop animation
                drawSlingshot(); // Draw initial state
            }

            // Event listener to start/restart the game
            startSlingshotBtn.addEventListener('click', () => {
                resetSlingshotGame(); // Ensure game is reset before starting
                gameActive = true;
                drawSlingshot(); // Start drawing loop
            });

            drawSlingshot(); // Initial draw of the game
        }

        // --- Mini Games: Meteor Dodge (2D) ---
        let meteorDodgeCanvas, meteorDodgeCtx, meteorDodgeAnimationId;

        // Initializes the Meteor Dodge game
        function initMeteorDodgeGame() {
            meteorDodgeCanvas = document.getElementById('meteor-dodge-canvas');
            meteorDodgeCtx = meteorDodgeCanvas.getContext('2d');
            const startMeteorDodgeBtn = document.getElementById('start-meteor-dodge');

            if (!meteorDodgeCanvas || !meteorDodgeCtx || !startMeteorDodgeBtn) {
                console.error("Meteor Dodge game elements not found.");
                return;
            }

            meteorDodgeCanvas.width = meteorDodgeCanvas.offsetWidth;
            meteorDodgeCanvas.height = meteorDodgeCanvas.offsetHeight;

            // Player ship properties
            let player = { x: meteorDodgeCanvas.width / 2, y: meteorDodgeCanvas.height - 30, size: 20, color: 'blue' };
            let meteors = []; // Array to store active meteors
            let score = 0;
            let gameActive = false;
            let meteorSpeed = 2; // Initial meteor speed
            let lastMeteorTime = 0; // Timestamp of last meteor spawn
            const meteorSpawnInterval = 1000; // Interval for spawning new meteors (milliseconds)

            // Function to create and add a new meteor to the game
            function createMeteor() {
                const x = Math.random() * (meteorDodgeCanvas.width - 20) + 10; // Random X position
                const size = 10 + Math.random() * 20; // Random size
                meteors.push({ x: x, y: -size, size: size, color: 'gray' }); // Add meteor above canvas
            }

            // Main game drawing and update loop
            function drawMeteorDodge() {
                meteorDodgeCtx.clearRect(0, 0, meteorDodgeCanvas.width, meteorDodgeCanvas.height); // Clear canvas
                meteorDodgeCtx.fillStyle = '#0a0a0a'; // Background
                meteorDodgeCtx.fillRect(0, 0, meteorDodgeCanvas.width, meteorDodgeCanvas.height);

                // Draw player ship
                meteorDodgeCtx.fillStyle = player.color;
                meteorDodgeCtx.fillRect(player.x - player.size / 2, player.y - player.size / 2, player.size, player.size);

                // Iterate through meteors (backwards to handle removal during iteration)
                for (let i = meteors.length - 1; i >= 0; i--) {
                    const meteor = meteors[i];
                    meteorDodgeCtx.fillStyle = meteor.color;
                    meteorDodgeCtx.beginPath();
                    meteorDodgeCtx.arc(meteor.x, meteor.y, meteor.size / 2, 0, Math.PI * 2); // Draw meteor as a circle
                    meteorDodgeCtx.fill();

                    if (gameActive) {
                        meteor.y += meteorSpeed; // Move meteor downwards

                        // Simple AABB (Axis-Aligned Bounding Box) collision detection
                        if (player.x - player.size / 2 < meteor.x + meteor.size / 2 &&
                            player.x + player.size / 2 > meteor.x - meteor.size / 2 &&
                            player.y - player.size / 2 < meteor.y + meteor.size / 2 &&
                            player.y + player.size / 2 > meteor.y - meteor.size / 2) {
                            endMeteorDodgeGame(); // End game on collision
                            return; // Stop animation loop immediately
                        }

                        // Remove meteors that go off-screen and increment score
                        if (meteor.y > meteorDodgeCanvas.height + meteor.size) {
                            meteors.splice(i, 1);
                            score++;
                        }
                    }
                }

                // Spawn new meteors if game is active and interval has passed
                if (gameActive && Date.now() - lastMeteorTime > meteorSpawnInterval) {
                    createMeteor();
                    lastMeteorTime = Date.now();
                }

                // Display current score
                meteorDodgeCtx.fillStyle = 'white';
                meteorDodgeCtx.font = '16px Inter';
                meteorDodgeCtx.fillText('Score: ' + score, 10, 25);

                if (gameActive) {
                    meteorDodgeAnimationId = requestAnimationFrame(drawMeteorDodge); // Continue animation
                }
            }

            // Keyboard input handler for player movement
            function handleKeyDown(e) {
                if (!gameActive) return; // Only move if game is active
                const playerSpeed = 10;
                if (e.key === 'ArrowLeft' && player.x > player.size / 2) {
                    player.x -= playerSpeed;
                } else if (e.key === 'ArrowRight' && player.x < meteorDodgeCanvas.width - player.size / 2) {
                    player.x += playerSpeed;
                }
            }

            // Touch event handlers for mobile control
            let touchStartX = 0;
            meteorDodgeCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // Prevent scrolling
                touchStartX = e.touches[0].clientX;
            });

            meteorDodgeCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault(); // Prevent scrolling
                if (!gameActive) return;
                const touchCurrentX = e.touches[0].clientX;
                const deltaX = touchCurrentX - touchStartX;
                player.x += deltaX * 0.5; // Move player based on swipe, adjust sensitivity
                // Keep player within bounds
                if (player.x < player.size / 2) player.x = player.size / 2;
                if (player.x > meteorDodgeCanvas.width - player.size / 2) player.x = meteorDodgeCanvas.width - player.size / 2;
                touchStartX = touchCurrentX; // Update touch start position for continuous movement
            });

            // Function to start the game
            function startMeteorDodgeGame() {
                if (meteorDodgeAnimationId) cancelAnimationFrame(meteorDodgeAnimationId); // Stop any previous animation
                // Reset game state
                player = { x: meteorDodgeCanvas.width / 2, y: meteorDodgeCanvas.height - 30, size: 20, color: 'blue' };
                meteors = [];
                score = 0;
                gameActive = true;
                meteorSpeed = 2;
                lastMeteorTime = Date.now();
                drawMeteorDodge(); // Start the game loop
            }

            // Function to end the game
            function endMeteorDodgeGame() {
                gameActive = false;
                if (meteorDodgeAnimationId) cancelAnimationFrame(meteorDodgeAnimationId); // Stop animation
                alertBox("Game Over!", `You dodged ${score} meteors!`, () => startMeteorDodgeBtn.click()); // Custom alert
            }

            // Event listeners
            startMeteorDodgeBtn.addEventListener('click', startMeteorDodgeGame);
            document.addEventListener('keydown', handleKeyDown);

            drawMeteorDodge(); // Initial draw for static display
        }

        // --- Mini Games: Space Maze (2D) ---
        let spaceMazeCanvas, spaceMazeCtx, spaceMazeAnimationId;

        // Initializes the Space Maze game
        function initSpaceMazeGame() {
            spaceMazeCanvas = document.getElementById('space-maze-canvas');
            spaceMazeCtx = spaceMazeCanvas.getContext('2d');
            const startSpaceMazeBtn = document.getElementById('start-space-maze');

            if (!spaceMazeCanvas || !spaceMazeCtx || !startSpaceMazeBtn) {
                console.error("Space Maze game elements not found.");
                return;
            }

            spaceMazeCanvas.width = spaceMazeCanvas.offsetWidth;
            spaceMazeCanvas.height = spaceMazeCanvas.offsetHeight;

            // Maze grid (1s are walls, 0s are paths)
            const maze = [
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 0, 0, 0, 1, 0, 0, 0, 0, 1],
                [1, 1, 1, 0, 1, 0, 1, 1, 0, 1],
                [1, 0, 0, 0, 0, 0, 1, 0, 0, 1],
                [1, 0, 1, 1, 1, 1, 1, 0, 1, 1],
                [1, 0, 1, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 1, 0, 1, 1, 1, 1, 0, 1],
                [1, 0, 0, 0, 1, 0, 0, 0, 0, 1],
                [1, 1, 1, 0, 1, 1, 1, 1, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
            ];
            const cellSize = spaceMazeCanvas.width / maze[0].length; // Calculate cell size based on canvas width
            // Player properties (initial position is grid coordinates)
            let player = { x: 1, y: 1, color: 'lime', size: cellSize * 0.6 };
            // End point coordinates
            const end = { x: maze[0].length - 2, y: maze.length - 2 };

            let gameActive = false;

            // Function to draw the maze and player
            function drawMaze() {
                spaceMazeCtx.clearRect(0, 0, spaceMazeCanvas.width, spaceMazeCanvas.height); // Clear canvas
                spaceMazeCtx.fillStyle = '#0a0a0a'; // Background
                spaceMazeCtx.fillRect(0, 0, spaceMazeCanvas.width, spaceMazeCanvas.height);

                // Draw maze walls
                for (let row = 0; row < maze.length; row++) {
                    for (let col = 0; col < maze[row].length; col++) {
                        if (maze[row][col] === 1) { // If it's a wall
                            spaceMazeCtx.fillStyle = '#333333'; // Wall color
                            spaceMazeCtx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                        }
                    }
                }

                // Draw end point (target for the player)
                spaceMazeCtx.fillStyle = 'gold';
                spaceMazeCtx.beginPath();
                spaceMazeCtx.arc((end.x + 0.5) * cellSize, (end.y + 0.5) * cellSize, player.size / 2, 0, Math.PI * 2);
                spaceMazeCtx.fill();

                // Draw player
                spaceMazeCtx.fillStyle = player.color;
                spaceMazeCtx.beginPath();
                spaceMazeCtx.arc((player.x + 0.5) * cellSize, (player.y + 0.5) * cellSize, player.size / 2, 0, Math.PI * 2);
                spaceMazeCtx.fill();

                if (gameActive) {
                    spaceMazeAnimationId = requestAnimationFrame(drawMaze); // Continue animation
                }
            }

            // Function to move the player
            function movePlayer(dx, dy) {
                if (!gameActive) return;

                const newX = player.x + dx;
                const newY = player.y + dy;

                // Check if new position is within bounds and is not a wall
                if (newX >= 0 && newX < maze[0].length && newY >= 0 && newY < maze.length && maze[newY][newX] === 0) {
                    player.x = newX;
                    player.y = newY;
                }

                // Check for win condition
                if (player.x === end.x && player.y === end.y) {
                    endSpaceMazeGame(true); // Player won
                }
            }

            // Keyboard input handler for player movement
            function handleMazeKeyDown(e) {
                switch (e.key) {
                    case 'ArrowUp': movePlayer(0, -1); break;
                    case 'ArrowDown': movePlayer(0, 1); break;
                    case 'ArrowLeft': movePlayer(-1, 0); break;
                    case 'ArrowRight': movePlayer(1, 0); break;
                }
            }

            // Touch event handlers for mobile control (swipe)
            let touchStartXMaze = 0;
            let touchStartYMaze = 0;

            spaceMazeCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                touchStartXMaze = e.touches[0].clientX;
                touchStartYMaze = e.touches[0].clientY;
            });

            spaceMazeCanvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (!gameActive) return;

                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;

                const dx = touchEndX - touchStartXMaze;
                const dy = touchEndY - touchStartYMaze;

                // Determine direction based on the larger displacement
                if (Math.abs(dx) > Math.abs(dy)) {
                    if (dx > 10) movePlayer(1, 0); // Swipe right
                    else if (dx < -10) movePlayer(-1, 0); // Swipe left
                } else {
                    if (dy > 10) movePlayer(0, 1); // Swipe down
                    else if (dy < -10) movePlayer(0, -1); // Swipe up
                }
            });

            // Function to start the game
            function startSpaceMazeGame() {
                if (spaceMazeAnimationId) cancelAnimationFrame(spaceMazeAnimationId); // Stop previous animation
                player = { x: 1, y: 1, color: 'lime', size: cellSize * 0.6 }; // Reset player position
                gameActive = true;
                drawMaze(); // Start game loop
            }

            // Function to end the game
            function endSpaceMazeGame(won) {
                gameActive = false;
                if (spaceMazeAnimationId) cancelAnimationFrame(spaceMazeAnimationId); // Stop animation
                if (won) {
                    alertBox("Congratulations!", "You found your way through the cosmic labyrinth!", () => startSpaceMazeBtn.click());
                } else {
                    alertBox("Game Over!", "You gave up.", () => startSpaceMazeBtn.click());
                }
            }

            // Event listeners
            startSpaceMazeBtn.addEventListener('click', startSpaceMazeGame);
            document.addEventListener('keydown', handleMazeKeyDown);

            drawMaze(); // Initial draw for static display
        }

        // --- Glossary Search Logic ---
        const glossarySearchInput = document.getElementById('glossary-search');
        const glossaryListDiv = document.getElementById('glossary-list');
        // Store all glossary items initially to filter them
        const allGlossaryItems = Array.from(glossaryListDiv.children);

        glossarySearchInput.addEventListener('input', () => {
            const searchTerm = glossarySearchInput.value.toLowerCase().trim();

            allGlossaryItems.forEach(item => {
                const termText = item.querySelector('h3').textContent.toLowerCase();
                const definitionText = item.querySelector('p').textContent.toLowerCase();

                // Show item if term or definition includes the search term, otherwise hide
                if (termText.includes(searchTerm) || definitionText.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Global window.onload ensures all DOM elements are fully loaded and available
        // before any initializations that depend on them.
        window.onload = function() {
            // No direct calls here. Functions are called when sections become active via navigation.
        };

    </script>
</body>
</html>
