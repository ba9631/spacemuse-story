<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Muse</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- three.js CDN for 3D rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- cannon.js CDN (still included but not heavily used for orbital physics here) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <style>
        /* Custom styles for the body and canvas */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0a09; /* Even darker, almost black background */
            color: #d1d5db; /* Lighter gray text for better contrast */
        }
        /* Focus styles for the search input */
        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* Blue ring focus */
            border-color: #3b82f6; /* Blue border on focus */
        }
        /* Styling for the 3D canvas (shared styles) */
        .threejs-canvas {
            display: block;
            width: 100%;
            height: 600px; /* Fixed height for the canvas, can be adjusted or made responsive with JS */
            background-color: #000000; /* Black background for space */
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15); /* Darker shadow */
        }
        /* Styling for the loading indicator */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            border-radius: 1rem;
            z-index: 10;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Calendar specific styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem; /* Gap between days */
        }
        .calendar-day {
            padding: 1rem;
            min-height: 80px; /* Ensure a minimum height for each day cell */
            background-color: rgba(30, 41, 59, 0.5); /* slate-800 with transparency */
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border: 1px solid transparent;
            position: relative;
        }
        .calendar-day:hover {
            background-color: rgba(51, 65, 85, 0.7); /* slate-700 with transparency */
            border-color: #60a5fa; /* Blue border on hover */
        }
        .calendar-day.current-month {
            color: #d1d5db; /* Light gray for current month days */
        }
        .calendar-day.other-month {
            color: #6b7280; /* Darker gray for other month days */
        }
        .calendar-day.has-event {
            border-color: #34d399; /* Green border for days with events */
            background-color: rgba(16, 185, 129, 0.2); /* green-500 with transparency */
        }
        .calendar-day-number {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            margin-bottom: 0.5rem;
        }
        .calendar-event-title {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #a7f3d0; /* green-200 */
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }
        .moon-phase-icon {
            font-size: 1.5rem; /* Make moon icons visible */
            margin-top: 0.5rem;
            align-self: flex-end; /* Push to bottom right */
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
        }

        /* Modal (Pop-up) styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* High z-index to be on top */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1f2937; /* Darker gray background for modal */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 90%;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close-btn:hover {
            color: #e5e7eb;
        }

        /* Main content sections - initially hidden */
        .content-section {
            display: none;
            width: 100%; /* Ensure sections take full width when visible */
        }
        .content-section.active {
            display: block;
        }

        /* Info Pop-ups (shared styles) */
        .info-popup {
            position: absolute;
            background-color: rgba(30, 41, 59, 0.9); /* slate-800 with transparency */
            border: 1px solid #60a5fa; /* Blue border */
            border-radius: 0.75rem;
            padding: 1rem;
            max-width: 250px;
            pointer-events: none; /* Allows clicks to pass through to canvas if not on pop-up itself */
            opacity: 0;
            visibility: hidden;
            transform: translate(-50%, -100%); /* Center horizontally, push up vertically */
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out, transform 0.2s ease-in-out;
            z-index: 50; /* Above canvas, below main modal */
        }
        .info-popup.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -110%); /* Adjust slightly for hover effect */
        }
        .info-popup h4 {
            font-size: 1.25rem; /* text-xl */
            font-weight: bold;
            color: #fff;
            margin-bottom: 0.5rem;
        }
        .info-popup p {
            font-size: 0.875rem; /* text-sm */
            color: #cbd5e1; /* slate-300 */
        }
        .info-popup .category-title {
            font-weight: bold;
            color: #93c5fd; /* light blue */
            margin-top: 0.5rem;
            margin-bottom: 0.2rem;
        }

        /* Glossary specific styles */
        .glossary-term {
            margin-bottom: 1.5rem;
        }
        .glossary-term h3 {
            font-size: 1.75rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            color: #67e8f9; /* cyan-300 */
            margin-bottom: 0.5rem;
        }
        .glossary-term p {
            font-size: 1rem; /* text-base */
            color: #a78bfa; /* violet-400 */
            line-height: 1.6;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased">

    <!-- Header Section -->
    <header class="bg-gradient-to-r from-gray-900 to-slate-900 p-6 shadow-2xl rounded-b-xl mb-10 mx-auto w-full max-w-7xl">
        <div class="container mx-auto flex flex-col md:flex-row items-center justify-between">
            <h1 class="text-4xl md:text-5xl font-extrabold text-teal-400 mb-4 md:mb-0 drop-shadow-lg">
                Space Muse
            </h1>
            <!-- Search Bar -->
            <div class="flex items-center space-x-2 mb-4 md:mb-0 w-full md:w-auto">
                <input type="text" placeholder="Search stories..." class="search-input p-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 w-full md:w-64">
                <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-300">
                    Search
                </button>
            </div>
            <!-- Navigation -->
            <nav>
                <ul class="flex flex-wrap justify-center md:justify-end space-x-4 md:space-x-6">
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="intro-section">Introduction</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="solar-system-section">Solar System</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="constellations-section">Constellations</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="stories-section">Stories</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="quiz-section">Quiz</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="calendar-section">Space Calendar</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="glossary-section">Cosmic Glossary</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="about-section">About</a></li>
                    <li><a href="#" class="nav-link text-gray-200 text-lg hover:text-teal-300 transition-colors duration-300 font-medium" data-target="contact-section">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Container (for managing page visibility) -->
    <div id="main-content-container" class="flex-grow container mx-auto p-6 max-w-7xl">

        <!-- Introduction Section -->
        <section id="intro-section" class="content-section py-10">
            <h2 class="text-4xl font-bold text-sky-400 mb-6 drop-shadow">Welcome to the Cosmic Canvas</h2>
            <p class="text-xl leading-relaxed text-gray-300 font-light">
                Step into the boundless expanse of imagination, where stars whisper ancient tales and nebulae paint vibrant sagas across the cosmic loom. Space Muse is your sanctuary for interstellar narratives, a collection of stories born from the silence of vacuum and the roar of supernovas. Explore the mysteries, the wonders, and the profound beauty of the universe, one story at a time.
            </p>
        </section>

        <!-- Interactive Solar System Section -->
        <section id="solar-system-section" class="content-section py-10 relative">
            <h2 class="text-4xl font-bold text-orange-400 mb-6 drop-shadow">Interactive Solar System</h2>
            <p class="text-lg leading-relaxed text-gray-300 mb-6">
                Explore a simplified 3D model of our solar system! Click and drag to change your view, and zoom with your scroll wheel. Click on planets for more info!
            </p>
            
            <!-- Solar System Controls -->
            <div class="flex flex-wrap gap-4 mb-6 justify-center">
                <label class="inline-flex items-center text-gray-300 cursor-pointer">
                    <input type="checkbox" id="toggleOrbits" class="form-checkbox h-5 w-5 text-blue-600 rounded" checked>
                    <span class="ml-2">Show Orbits</span>
                </label>
                <label class="inline-flex items-center text-gray-300 cursor-pointer">
                    <input type="checkbox" id="toggleMeteors" class="form-checkbox h-5 w-5 text-blue-600 rounded" checked>
                    <span class="ml-2">Show Meteors</span>
                </label>
                 <div class="flex items-center">
                    <label for="zoomSensitivity" class="text-gray-300 mr-2">Zoom Sensitivity:</label>
                    <input type="range" id="zoomSensitivity" min="0.1" max="2.0" value="0.5" step="0.1" class="w-32">
                </div>
            </div>

            <div id="solarSystemCanvas-container" class="relative w-full">
                <canvas id="solarSystemCanvas" class="threejs-canvas"></canvas>
                <div id="solarSystemLoadingOverlay" class="loading-overlay">
                    <div class="spinner"></div>
                    <span class="ml-4">Loading Solar System...</span>
                </div>
                 <!-- Planet Info Pop-up (hidden by default) -->
                <div id="planetInfoPopup" class="info-popup hidden">
                    <h4 id="popupPlanetName"></h4>
                    <p id="popupPlanetFacts"></p>
                </div>
            </div>
        </section>

        <!-- Constellations Section (Now independent of the Solar System 3D model) -->
        <section id="constellations-section" class="content-section py-10 relative">
            <h2 class="text-4xl font-bold text-indigo-400 mb-6 drop-shadow">Constellations: Patterns in the Stars</h2>
            <p class="text-xl leading-relaxed text-gray-300 font-light mb-6">
                Explore the mesmerizing patterns of constellations that have guided navigators and inspired storytellers for millennia. Click and drag to rotate, and zoom with your scroll wheel. Click on any star to learn more about the constellation!
            </p>
             <!-- Constellation Controls (optional, could add toggle for labels etc.) -->
            <div class="flex flex-wrap gap-4 mb-6 justify-center">
                <p class="text-gray-400">Interact with the 3D model below!</p>
            </div>
            <div id="constellationsCanvas-container" class="relative w-full">
                <canvas id="constellationsCanvas" class="threejs-canvas"></canvas>
                <div id="constellationsLoadingOverlay" class="loading-overlay">
                    <div class="spinner"></div>
                    <span class="ml-4">Loading Constellations...</span>
                </div>
                 <!-- Constellation Info Pop-up (hidden by default) -->
                <div id="constellationInfoPopup" class="info-popup hidden">
                    <h4 id="constellationPopupName"></h4>
                    <div class="category-title">Folklore:</div>
                    <p id="constellationPopupFolklore"></p>
                    <div class="category-title">Encyclopedic Info:</div>
                    <p id="constellationPopupEncyclopedic"></p>
                </div>
            </div>
        </section>

        <!-- Stories Section - Container for all story snippets -->
        <section id="stories-section" class="content-section py-10 space-y-16">
            <h2 class="text-4xl font-bold text-teal-400 mb-6 drop-shadow">Cosmic Narratives</h2>

            <!-- Story Snippet 1: The Echoes of Cygnus X-1 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-center">
                <div class="order-2 md:order-1">
                    <h3 class="text-3xl font-semibold text-purple-300 mb-4">The Echoes of Cygnus X-1</h3>
                    <p class="text-lg leading-relaxed text-gray-300 mb-6 font-light">
                        Deep within the heart of the Cygnus constellation, lies a whisper that spans light-years. It is said that Cygnus X-1, the ravenous black hole, doesn't merely consume, but preserves the echoes of civilizations swallowed whole. A lone voyager, adrift near its event horizon, tunes into these faint signals, hoping to piece together the final melodies of a vanished world. What secrets do the gravitational waves truly carry?
                    </p>
                    <a href="#" class="inline-flex items-center text-purple-400 hover:text-purple-200 transition-colors duration-300 font-medium text-lg">Read More
                        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                    </a>
                </div>
                <div class="order-1 md:order-2">
                    <img src="https://placehold.co/600x400/312E81/ffffff?text=Cygnus+X-1+Echoes" alt="Cygnus X-1 black hole illustration" class="rounded-xl shadow-lg w-full h-auto object-cover">
                </div>
            </div>

            <!-- Story Snippet 2: The Flora of Kepler-186f -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-center">
                <div>
                    <img src="https://placehold.co/600x400/064E3B/ffffff?text=Kepler-186f+Flora" alt="Alien flora on Kepler-186f" class="rounded-xl shadow-lg w-full h-auto object-cover">
                </div>
                <div>
                    <h3 class="text-3xl font-semibold text-emerald-300 mb-4">The Flora of Kepler-186f</h3>
                    <p class="text-lg leading-relaxed text-gray-300 mb-6 font-light">
                        On the exoplanet Kepler-186f, life thrives in hues unknown to Earth. Its forests glow with bioluminescent flora, casting an ethereal light under a crimson sun. Botanists from Earth dispatch a research probe, eager to catalog these otherworldly plants. But as they delve deeper, they uncover a symbiotic network far more intricate and intelligent than they could have imagined, a network that guards ancient secrets.
                    </p>
                    <a href="#" class="inline-flex items-center text-emerald-400 hover:text-emerald-200 transition-colors duration-300 font-medium text-lg">Read More
                        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                    </a>
                </div>
            </div>

            <!-- Story Snippet 3: The Lost Starchild -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-center">
                <div class="order-2 md:order-1">
                    <h3 class="text-3xl font-semibold text-fuchsia-300 mb-4">The Lost Starchild</h3>
                    <p class="text-lg leading-relaxed text-gray-300 mb-6 font-light">
                        Legend speaks of a Starchild, born from cosmic dust and nebula gas, whose laughter could ignite dying stars. Prophecy foretold its return, but centuries passed with only silence. Now, a young space scavenger, scavenging through forgotten asteroid fields, stumbles upon an artifact that hums with an ancient energy, leading them on a perilous journey to find the lost Starchild and avert a galactic cataclysm.
                    </p>
                    <a href="#" class="inline-flex items-center text-fuchsia-400 hover:text-fuchsia-200 transition-colors duration-300 font-medium text-lg">Read More
                        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                    </a>
                </div>
                <div class="order-1 md:order-2">
                    <img src="https://placehold.co/600x400/7E22CE/ffffff?text=Lost+Starchild" alt="Cosmic child illustration" class="rounded-xl shadow-lg w-full h-auto object-cover">
                </div>
            </div>
        </section>

        <!-- Quiz Section -->
        <section id="quiz-section" class="content-section py-10">
            <h2 class="text-4xl font-bold text-green-400 mb-6 drop-shadow">Space Quiz Challenge!</h2>
            <p class="text-xl leading-relaxed text-gray-300 font-light mb-8">
                Test your knowledge of the cosmos! Select a difficulty level and start your stellar challenge.
            </p>

            <!-- Quiz Controls and Display -->
            <div class="w-full max-w-2xl mx-auto text-center">
                <div id="quiz-level-selection" class="mb-8 flex flex-wrap justify-center gap-4">
                    <button class="quiz-level-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-300" data-level="easy">Easy</button>
                    <button class="quiz-level-btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-300" data-level="medium">Medium</button>
                    <button class="quiz-level-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-300" data-level="hard">Hard</button>
                </div>

                <div id="quiz-container" class="hidden">
                    <p id="quiz-score" class="text-2xl font-bold text-yellow-300 mb-4">Score: 0</p>
                    <p id="quiz-question" class="text-2xl font-medium text-gray-200 mb-6"></p>
                    <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <!-- Answer buttons will be injected here by JavaScript -->
                    </div>
                    <p id="quiz-feedback" class="text-lg font-semibold mb-4"></p>
                    <button id="quiz-next-btn" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 hidden">Next Question</button>
                    <button id="quiz-reset-btn" class="bg-red-700 hover:bg-red-800 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 hidden">Restart Quiz</button>
                </div>
            </div>
        </section>

        <!-- New Space Calendar Section -->
        <section id="calendar-section" class="content-section py-10">
            <h2 class="text-4xl font-bold text-yellow-400 mb-6 drop-shadow">Space Event Calendar</h2>
            <p class="text-xl leading-relaxed text-gray-300 font-light mb-8">
                Stay updated with major space events like rocket launches, meteor showers, and planetary alignments!
            </p>

            <div class="w-full max-w-4xl mx-auto bg-gray-900 p-8 rounded-xl shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <button id="prevMonthBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-300">&larr; Previous</button>
                    <h3 id="currentMonthYear" class="text-3xl font-bold text-white"></h3>
                    <button id="nextMonthBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-300">Next &rarr;</button>
                </div>

                <div class="calendar-grid text-center font-semibold text-lg mb-4">
                    <div class="text-gray-400">Sun</div>
                    <div class="text-gray-400">Mon</div>
                    <div class="text-gray-400">Tue</div>
                    <div class="text-gray-400">Wed</div>
                    <div class="text-gray-400">Thu</div>
                    <div class="text-gray-400">Fri</div>
                    <div class="text-gray-400">Sat</div>
                </div>

                <div id="calendarDays" class="calendar-grid">
                    <!-- Calendar days will be injected here by JavaScript -->
                </div>
            </div>
        </section>

        <!-- New Cosmic Glossary Section -->
        <section id="glossary-section" class="content-section py-10">
            <h2 class="text-4xl font-bold text-cyan-400 mb-8 drop-shadow">Cosmic Glossary</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="glossary-term">
                    <h3>Black Hole</h3>
                    <p>A region of spacetime where gravity is so strong that nothing—no particles or even electromagnetic radiation such as light—can escape from it. The theory of general relativity predicts that a sufficiently compact mass can deform spacetime to form a black hole.</p>
                </div>
                <div class="glossary-term">
                    <h3>Galaxy</h3>
                    <p>A gravitationally bound system of stars, stellar remnants, interstellar gas, dust, and dark matter. The word galaxy is derived from the Greek galaxias (γαλαξίας), literally "milky", in reference to the Milky Way galaxy.</p>
                </div>
                <div class="glossary-term">
                    <h3>Nebula</h3>
                    <p>A giant cloud of dust and gas in space, sometimes referred to as a "stellar nursery" where stars are born. Nebulae can also be the remnants of dead stars, like supernova remnants or planetary nebulae.</p>
                </div>
                <div class="glossary-term">
                    <h3>Supernova</h3>
                    <p>A powerful and luminous stellar explosion. It occurs during the last evolutionary stages of a massive star or when a white dwarf star undergoes runaway nuclear fusion.</p>
                </div>
                <div class="glossary-term">
                    <h3>Light-year</h3>
                    <p>A unit of length used to express astronomical distances, equal to the distance that light travels in one Julian year (365.25 days). Due to the vast distances in space, light-years are commonly used instead of miles or kilometers.</p>
                </div>
                <div class="glossary-term">
                    <h3>Exoplanet</h3>
                    <p>A planet located outside our Solar System, orbiting a star other than our Sun. Thousands of exoplanets have been discovered, ranging greatly in size, composition, and orbital characteristics.</p>
                </div>
                <div class="glossary-term">
                    <h3>Constellation</h3>
                    <p>A group of stars that forms a recognizable pattern or outline, typically representing an animal, mythological person or creature, or inanimate object. Historically, constellations were used for navigation and storytelling.</p>
                </div>
                <div class="glossary-term">
                    <h3>Asteroid</h3>
                    <p>A minor planet of the inner Solar System. Larger than meteoroids, asteroids are rocky, airless worlds that orbit our Sun, but are too small to be called planets.</p>
                </div>
                <div class="glossary-term">
                    <h3>Comet</h3>
                    <p>An icy, small Solar System body that, when passing close to the Sun, warms and begins to outgas, displaying a visible atmosphere or coma, and sometimes also a tail.</p>
                </div>
                <div class="glossary-term">
                    <h3>Dwarf Planet</h3>
                    <p>A celestial body orbiting the Sun that is massive enough to be rounded by its own gravity but has not cleared its orbital neighborhood of other debris and is not a satellite.</p>
                </div>
            </div>
        </section>

        <!-- New About Section -->
        <section id="about-section" class="content-section py-10">
            <h2 class="text-4xl font-bold text-purple-400 mb-6 drop-shadow">About Space Muse</h2>
            <p class="text-xl leading-relaxed text-gray-300 font-light mb-4">
                Space Muse is a passion project dedicated to exploring the wonders of the cosmos through storytelling, interactive simulations, and educational challenges. Our goal is to inspire curiosity about space and science for all ages.
            </p>
            <p class="text-lg leading-relaxed text-gray-400">
                From ancient myths woven into constellations to the latest discoveries from distant galaxies, we aim to provide an engaging platform for cosmic exploration.
            </p>
        </section>

        <!-- New Contact Section -->
        <section id="contact-section" class="content-section py-10">
            <h2 class="text-4xl font-bold text-pink-400 mb-6 drop-shadow">Contact Us</h2>
            <p class="text-xl leading-relaxed text-gray-300 font-light mb-8">
                Have a question, suggestion, or a cosmic story to share? We'd love to hear from you!
            </p>
            <form class="max-w-md mx-auto">
                <div class="mb-6">
                    <label for="name" class="block text-gray-300 text-lg font-medium mb-2">Your Name</label>
                    <input type="text" id="name" name="name" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="John Doe">
                </div>
                <div class="mb-6">
                    <label for="email" class="block text-gray-300 text-lg font-medium mb-2">Your Email</label>
                    <input type="email" id="email" name="email" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="your.email@example.com">
                </div>
                <div class="mb-6">
                    <label for="message" class="block text-gray-300 text-lg font-medium mb-2">Your Message</label>
                    <textarea id="message" name="message" rows="5" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Tell us your cosmic thoughts..."></textarea>
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition-colors duration-300">
                        Send Message
                    </button>
                </div>
            </form>
        </section>

    </div> <!-- End of main-content-container -->

    <!-- Modal for Event Details -->
    <div id="eventModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeModalBtn" class="modal-close-btn">&times;</button>
            <h3 id="modalEventTitle" class="text-3xl font-bold text-white mb-3"></h3>
            <p id="modalEventDate" class="text-lg text-gray-400 mb-4"></p>
            <p id="modalEventDescription" class="text-md text-gray-300 leading-relaxed"></p>
            <div id="modalMoonPhase" class="text-lg text-white mt-4"></div>
             <!-- Loading indicator for LLM story -->
            <div id="llmStoryLoading" class="hidden text-center text-gray-400 mt-4">
                <div class="spinner inline-block mr-2"></div> Loading cosmic tale...
            </div>
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="bg-gray-950 p-8 mt-12 rounded-t-xl mx-auto w-full max-w-7xl">
        <div class="container mx-auto text-center text-gray-500 text-sm">
            &copy; 2025 Space Muse. All rights reserved. Journey through the cosmos.
        </div>
    </footer>

    <script>
        // III. JavaScript for 3D Solar System Simulation, Quiz Logic, Space Calendar, and Multi-Page Navigation

        // --- Three.js Variables (Solar System) ---
        let solarSystemScene, solarSystemCamera, solarSystemRenderer;
        let sun;
        const planets = [];
        const orbitLines = []; // Store orbit meshes for toggling
        const meteors = [];
        let solarSystemStarsBackground; // For the new starfield
        let solarSystemMouseX = 0, solarSystemMouseY = 0; // Mouse position for camera control
        let solarSystemIsDragging = false;
        let solarSystemPreviousMouseX = 0, solarSystemPreviousMouseY = 0;
        let solarSystemLoadingOverlay;
        let solarSystemInitialized = false; // Flag to ensure Three.js initializes only once
        let solarSystemZoomSensitivity = 0.5; // Initial zoom sensitivity

        // For planet info pop-up and highlighting (Solar System)
        const solarSystemRaycaster = new THREE.Raycaster();
        const solarSystemMouse = new THREE.Vector2();
        let solarSystemPreviouslyClickedObject = null; // To store the currently highlighted object
        let planetInfoPopup = null;
        let popupPlanetName = null;
        let popupPlanetFacts = null;
        const HIGHLIGHT_COLOR = 0x00FF00; // Green color for highlight

        // --- Three.js Variables (Constellations) ---
        let constellationsScene, constellationsCamera, constellationsRenderer;
        let constellationsGroup; // Group to hold all constellation elements
        let constellationsStarsBackground;
        let constellationsSun, constellationsEarth; // Sun and Earth for constellation view
        let constellationsMouseX = 0, constellationsMouseY = 0;
        let constellationsIsDragging = false;
        let constellationsPreviousMouseX = 0, constellationsPreviousMouseY = 0;
        let constellationsLoadingOverlay;
        let constellationsInitialized = false; // Flag for constellation Three.js initialization

        // For constellation info pop-up and highlighting
        const constellationsRaycaster = new THREE.Raycaster();
        const constellationsMouse = new THREE.Vector2();
        let previouslyClickedConstellationStar = null; // To store the currently highlighted constellation star
        let constellationInfoPopup = null;
        let constellationPopupName = null;
        let constellationPopupFolklore = null;
        let constellationPopupEncyclopedic = null;


        // --- Solar System Data ---
        const PLANET_DATA = [
            // Note: Radii and distances are highly scaled for visibility in a single view.
            // Distances are relative to the sun. Orbital speed is adjusted for visual effect.
            // axialTilt in radians (approximate for visual representation)
            { name: 'Mercury', radius: 0.1, color: 0x71717A, distance: 2, orbitalSpeed: 0.03, axialTilt: 0.01, rotationSpeed: 0.005, originalEmissive: 0x000000, facts: "Closest and smallest planet. Has extreme temperature variations from scorching hot to freezing cold due to lack of atmosphere." },
            { name: 'Venus', radius: 0.2, color: 0xCA8A04, distance: 3.5, orbitalSpeed: 0.02, axialTilt: 2.9, rotationSpeed: 0.002, originalEmissive: 0x000000, facts: "Earth's 'sister planet' with a thick, toxic atmosphere and extreme greenhouse effect, making it the hottest planet." },
            { name: 'Earth', radius: 0.22, color: 0x10B981, distance: 5, orbitalSpeed: 0.015, axialTilt: 0.41, rotationSpeed: 0.01, originalEmissive: 0x000000, facts: "Our home planet, the only known celestial body to harbor life, with abundant liquid water and a protective atmosphere." },
            { name: 'Mars', radius: 0.15, color: 0xDC2626, distance: 6.5, orbitalSpeed: 0.012, axialTilt: 0.43, rotationSpeed: 0.009, originalEmissive: 0x000000, facts: "The Red Planet, known for its rusty surface, polar ice caps, and thin atmosphere. A primary target for human exploration." },
            { name: 'Jupiter', radius: 1.2, color: 0xFACC15, distance: 12, orbitalSpeed: 0.005, axialTilt: 0.05, rotationSpeed: 0.02, originalEmissive: 0x000000, facts: "Largest planet in our solar system, a gas giant with a Great Red Spot (a persistent colossal storm larger than Earth)." },
            { name: 'Saturn', radius: 1.0, color: 0xFB923C, distance: 16, orbitalSpeed: 0.004, ring: true, axialTilt: 0.47, rotationSpeed: 0.018, originalEmissive: 0x000000, facts: "Famous for its magnificent system of icy rings composed of billions of small particles. A true jewel of the solar system." },
            { name: 'Uranus', radius: 0.7, color: 0x0EA5E9, distance: 20, orbitalSpeed: 0.003, axialTilt: 1.7, rotationSpeed: 0.015, originalEmissive: 0x000000, facts: "An ice giant that rotates on its side (nearly 90-degree axial tilt), making it unique in the solar system." },
            { name: 'Neptune', radius: 0.68, color: 0x2563EB, distance: 24, orbitalSpeed: 0.002, axialTilt: 0.5, rotationSpeed: 0.016, originalEmissive: 0x000000, facts: "Farthest planet from the Sun (after Pluto's reclassification), an ice giant with the strongest sustained winds in the solar system." },
            { name: 'Pluto', radius: 0.05, color: 0xA3A3A3, distance: 28, orbitalSpeed: 0.001, axialTilt: 0.2, rotationSpeed: 0.003, originalEmissive: 0x000000, facts: "A dwarf planet located in the Kuiper Belt, an icy world with a complex surface, often covered in nitrogen ice." },
            { name: 'Sun', radius: 1.5, color: 0xFDB813, originalEmissive: 0x000000, facts: "The star at the center of our solar system, a massive ball of hot plasma, powering all life on Earth through nuclear fusion.", identifiable: true }
        ];

        // --- Constellation Data (Zodiac) ---
        const ZODIAC_CONSTELLATION_DATA = [
            {
                name: "Aries", color: 0xFFD700, angleOffset: 0, // 0 degrees
                stars: [[0, 0, 0], [2, 1, 0], [1, 3, 0], [3, 2, 0]],
                lines: [[0, 1], [1, 2], [2, 3]],
                folklore: "In Greek mythology, Aries represents the Golden Fleece sought by Jason and the Argonauts. This ram was sent by Nephele to carry her children, Phrixus and Helle, to safety. Phrixus sacrificed the ram to Zeus, who placed it in the stars.",
                encyclopedic: "Aries is a small to medium-sized constellation. It is one of the 12 constellations of the zodiac, meaning it lies on the ecliptic, the apparent path of the Sun across the celestial sphere. Its most prominent stars are Hamal (Alpha Arietis) and Sheratan (Beta Arietis)."
            },
            {
                name: "Taurus", color: 0xFFA07A, angleOffset: 30, // 30 degrees
                stars: [[0, 0, 0], [-2, 1, 0], [0, 3, 0], [3, 2, 0], [1, 5, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4]],
                folklore: "Taurus is most famously identified with the white bull that Zeus transformed into to abduct Europa, a Phoenician princess. Another myth associates it with Io, a lover of Zeus, transformed into a heifer by Hera.",
                encyclopedic: "Taurus is a large and prominent constellation in the Northern Hemisphere's winter sky. It contains the bright red giant star Aldebaran, the Hyades star cluster (which forms the bull's head), and the Pleiades (Seven Sisters) star cluster."
            },
            {
                name: "Gemini", color: 0x90EE90, angleOffset: 60, // 60 degrees
                stars: [[0, 0, 0], [0, 2, 0], [2, 0, 0], [2, 2, 0]],
                lines: [[0, 1], [2, 3], [0, 2]],
                folklore: "In Greek mythology, Gemini represents the twins Castor and Pollux. While Pollux was immortal (son of Zeus), Castor was mortal (son of Tyndareus). When Castor died, Pollux pleaded with Zeus to allow them to share his immortality, and they were placed together in the heavens.",
                encyclopedic: "Gemini is one of the constellations of the zodiac and is easily recognizable by its two brightest stars, Castor and Pollux, which represent the heads of the twins. It is best seen during the winter months in the Northern Hemisphere."
            },
            {
                name: "Cancer", color: 0xADD8E6, angleOffset: 90, // 90 degrees
                stars: [[0, 0, 0], [1, 1, 0], [2, 0, 0], [1, -1, 0], [-1, 0, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 0]],
                folklore: "In Greek mythology, Cancer represents the crab that attacked Heracles during his battle with the Lernaean Hydra. Hera sent the crab to distract him, but Heracles crushed it. As a reward for its service, Hera placed the crab among the stars.",
                encyclopedic: "Cancer is a relatively faint constellation and is considered one of the smallest constellations in the zodiac. It contains the Beehive Cluster (Messier 44), an open cluster of stars visible to the naked eye under dark skies."
            },
            {
                name: "Leo", color: 0xFF4500, angleOffset: 120, // 120 degrees
                stars: [[0, 0, 0], [2, 1, 0], [1, 3, 0], [4, 2, 0], [3, -1, 0], [5, -2, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [1, 4]],
                folklore: "Leo represents the Nemean Lion, a ferocious beast with impenetrable hide that was killed by Heracles as the first of his twelve labors. Zeus placed it in the sky to commemorate Heracles' triumph.",
                encyclopedic: "Leo is one of the constellations of the zodiac, positioned between Cancer to the west and Virgo to the east. It is easily recognized by the 'Sickle' asterism, which resembles a backwards question mark and forms the lion's head. Its brightest star is Regulus."
            },
            {
                name: "Virgo", color: 0xDA70D6, angleOffset: 150, // 150 degrees
                stars: [[0, 0, 0], [2, 2, 0], [4, 0, 0], [3, -2, 0], [1, -1, 0], [-1, 1, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 0]],
                folklore: "Virgo is often associated with Dike, the Greek goddess of justice, or Persephone, the goddess of innocence and spring, who spent part of the year in the underworld. Her appearance in the sky marks the time of harvest.",
                encyclopedic: "Virgo is the second largest constellation in the sky and the largest of the zodiac constellations. It contains the bright blue-white star Spica and is home to the Virgo Cluster, a large galaxy cluster."
            },
            {
                name: "Libra", color: 0x87CEEB, angleOffset: 180, // 180 degrees
                stars: [[0, 0, 0], [2, 0, 0], [1, 2, 0], [-1, 2, 0], [0, -2, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 0], [0, 4]],
                folklore: "Libra is the only zodiac constellation representing an inanimate object – the Scales. It is often associated with the scales of justice held by the goddess Themis or Astraea (Virgo), symbolizing balance and fairness, especially during the autumnal equinox when day and night are equal.",
                encyclopedic: "Libra is a constellation in the Southern Hemisphere, located between Virgo to the west and Scorpius to the east. Its two brightest stars are Zubenelgenubi (Alpha Librae) and Zubeneschamali (Beta Librae)."
            },
            {
                name: "Scorpius", color: 0xFF6347, angleOffset: 210, // 210 degrees
                stars: [[0, 0, 0], [-2, 1, 0], [0, 3, 0], [2, 2, 0], [3, 0, 0], [1, -2, 0], [0, -4, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 6]],
                folklore: "In Greek mythology, Scorpius is the scorpion that stung and killed Orion the hunter. As a result, the two constellations are placed on opposite sides of the sky so that they can never meet.",
                encyclopedic: "Scorpius is a large constellation located in the Southern Hemisphere near the center of the Milky Way. Its brightest star is Antares, a red supergiant and one of the brightest stars in the night sky. It has a distinctive J-shape or S-shape."
            },
            {
                name: "Ophiuchus", color: 0xCD853F, angleOffset: 240, // 240 degrees (The 13th zodiac sign)
                stars: [[0,0,0], [1,2,0], [3,1,0], [2,-1,0], [-1,-2,0], [-2,0,0]],
                lines: [[0,1], [1,2], [2,3], [3,4], [4,5], [5,0]],
                folklore: "Ophiuchus, the Serpent-Bearer, is often identified with the god Asclepius, the son of Apollo, who was a legendary healer. Zeus placed him in the heavens after killing him with a thunderbolt for bringing a mortal back from the dead, fearing he would make all humans immortal.",
                encyclopedic: "Ophiuchus is a large constellation located around the celestial equator. Astronomically, the Sun passes through Ophiuchus for about 18 days each year, making it the '13th zodiac sign' in addition to the traditional twelve. It is often depicted as a man grasping a serpent (Serpens constellation)."
            },
            {
                name: "Sagittarius", color: 0x8A2BE2, angleOffset: 270, // 270 degrees
                stars: [[0, 0, 0], [2, 1, 0], [1, -2, 0], [4, 0, 0], [3, -3, 0], [5, -1, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5]],
                folklore: "Sagittarius is typically depicted as a centaur (half-human, half-horse) archer, aiming his bow and arrow towards Scorpius. He is sometimes identified as Chiron, the wise centaur tutor of many Greek heroes.",
                encyclopedic: "Sagittarius is a prominent constellation in the Southern Hemisphere, known for containing the center of the Milky Way Galaxy. It is often recognized by the 'Teapot' asterism, a smaller pattern within the constellation."
            },
            {
                name: "Capricornus", color: 0x4682B4, angleOffset: 300, // 300 degrees
                stars: [[0, 0, 0], [-1, 2, 0], [1, 3, 0], [3, 1, 0], [2, -1, 0], [0, -3, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 0]],
                folklore: "Capricornus is often depicted as a mythical sea-goat, a creature that is half goat and half fish. In Babylonian mythology, it was associated with the god Ea or Enki, who represented water, wisdom, and creation.",
                encyclopedic: "Capricornus is a constellation in the Southern Hemisphere, part of the zodiac. It is one of the fainter zodiac constellations but can be found by looking for its distinctive triangle or V-shape. Its brightest star is Deneb Algedi."
            },
            {
                name: "Aquarius", color: 0x00BFFF, angleOffset: 330, // 330 degrees
                stars: [[0, 0, 0], [2, 1, 0], [0, 3, 0], [-2, 1, 0], [-1, -1, 0], [1, -3, 0]],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5]],
                folklore: "Aquarius, the Water-Bearer, is an ancient constellation with roots in Babylonian astronomy, where it was associated with flooding and rain. In Greek mythology, it is sometimes identified with Ganymede, the cup-bearer of the gods.",
                encyclopedic: "Aquarius is a large constellation in the Southern Hemisphere, one of the oldest recognized constellations. It is often depicted as a figure pouring water from an urn. It is best seen in the autumn evening sky."
            },
            {
                name: "Pisces", color: 0x00CED1, angleOffset: 360, // 360 degrees (overlaps 0 degrees / Aries)
                stars: [[0, 0, 0], [1, 2, 0], [-1, 3, 0], [2, -1, 0], [4, 1, 0], [3, 3, 0]],
                lines: [[0, 1], [1, 2], [0, 3], [3, 4], [4, 5]],
                folklore: "Pisces, the Fish, is associated with the myth of Aphrodite and Eros (Venus and Cupid in Roman mythology) who transformed into fish and jumped into the Euphrates River to escape the monster Typhon. They were tied together with a cord to avoid being separated.",
                encyclopedic: "Pisces is a large constellation of the zodiac. It is depicted as two fish tied together by their tails, swimming in opposite directions. It contains the star Alrescha, which marks the knot holding the two fish together."
            },
            // Added More Constellations (non-zodiac, placed randomly for demonstration)
            {
                name: "Ursa Major", color: 0xFFD700, angleOffset: 10, // A bit off the ecliptic for visual distinction
                stars: [
                    [-25, 30, -10], [-20, 25, -12], [-15, 20, -15], [-10, 15, -18],
                    [5, 10, -20], [10, 15, -22], [15, 20, -25]
                ],
                lines: [
                    [0, 1], [1, 2], [2, 3], // Dipper handle
                    [3, 4], [4, 5], [5, 6], [6, 3] // Dipper bowl
                ],
                folklore: "Known as the Great Bear, or the Big Dipper in North America, this constellation has many myths. In one Greek myth, it represents Callisto, a nymph turned into a bear by Zeus to protect her from Hera's wrath.",
                encyclopedic: "Ursa Major is a large constellation and asterism visible primarily in the Northern Hemisphere. It is widely recognized for its 'Big Dipper' shape. Its stars are significant for celestial navigation, as the two pointer stars in the Dipper's bowl point to Polaris, the North Star."
            },
            {
                name: "Orion", color: 0x00FFFF, angleOffset: 300, // Near Sagittarius/Capricornus, but off-ecliptic
                stars: [
                    [-15, 5, 20], [-10, 10, 18], [-5, -5, 22], [0, 0, 25],
                    [5, -5, 23], [10, 10, 19], [15, 5, 21],
                    [-2, 2, 24], [2, -2, 26] // Orion's Belt
                ],
                lines: [
                    [0, 1], [1, 3], [6, 3],
                    [3, 2], [2, 4], [4, 5],
                    [7, 3], [3, 8] // Connecting lines for Orion's Belt
                ],
                folklore: "In Greek mythology, Orion was a giant hunter whom Zeus placed among the stars as the constellation Orion. He is often depicted pursuing the Pleiades sisters or fighting Taurus the Bull.",
                encyclopedic: "Orion is one of the most prominent and recognizable constellations in the night sky, visible throughout the world. Its brightest stars are Rigel (a blue supergiant) and Betelgeuse (a red supergiant). It contains the famous Orion Nebula, a stellar nursery."
            },
            {
                name: "Cassiopeia", color: 0xFF69B4, angleOffset: 60, // Near Gemini/Cancer, but off-ecliptic
                stars: [
                    [30, 10, 5], [35, 15, 8], [40, 10, 5], [45, 15, 8], [50, 10, 5]
                ],
                lines: [
                    [0, 1], [1, 2], [2, 3], [3, 4] // W shape
                ],
                folklore: "In Greek mythology, Cassiopeia was the vain queen of Aethiopia, who boasted that she was more beautiful than the Nereids (sea nymphs). This angered Poseidon, who sent the sea monster Cetus to ravage her kingdom as punishment.",
                encyclopedic: "Cassiopeia is a constellation in the northern sky, easily recognizable by its distinct 'W' or 'M' shape, depending on the season and time of night. It is circumpolar for much of the Northern Hemisphere, meaning it never sets below the horizon."
            },
            {
                name: "Canis Major", color: 0x87CEFA, angleOffset: 200, // Near Scorpius
                stars: [
                    [0, 0, 0], [2, -1, 0], [4, 0, 0], [3, -2, 0], [1, -3, 0]
                ],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 0]],
                folklore: "Canis Major, the 'Greater Dog,' is often depicted as Orion's hunting dog. It is home to Sirius, the brightest star in the night sky, sometimes called the 'Dog Star.'",
                encyclopedic: "Canis Major is a constellation in the southern celestial hemisphere. Its most prominent feature is the star Sirius (Alpha Canis Majoris), which is not only the brightest star in the constellation but also the brightest star visible from Earth."
            },
            {
                name: "Cygnus", color: 0xFFFFFF, angleOffset: 250, // Near Ophiuchus/Sagittarius
                stars: [
                    [0, 0, 0], [1, 2, 0], [3, 1, 0], [2, -1, 0], [4, -2, 0], [0, -3, 0]
                ],
                lines: [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 0], [1, 3]], // Cross shape
                folklore: "Cygnus represents the swan in Greek mythology, often associated with Zeus disguising himself as a swan to seduce Leda, or with Orpheus's transformation into a swan after his death to be reunited with his lyre in the sky.",
                encyclopedic: "Cygnus, the Swan, is a prominent constellation in the Northern Hemisphere's summer sky. It is easily recognizable by its bright star Deneb and the asterism known as the Northern Cross. It lies on the Milky Way and contains many notable deep-sky objects, including the Cygnus X-1 black hole."
            }
        ];


        // --- Quiz Variables ---
        let quizData = {
            easy: [
                {
                    question: "Which planet is known as the 'Red Planet'?",
                    options: ["Earth", "Mars", "Jupiter", "Venus"],
                    answer: "Mars"
                },
                {
                    question: "What is the largest planet in our solar system?",
                    options: ["Mars", "Earth", "Saturn", "Jupiter"],
                    answer: "Jupiter"
                },
                {
                    question: "Which celestial body causes tides on Earth?",
                    options: ["The Sun", "Mars", "The Moon", "Venus"],
                    answer: "The Moon"
                },
                {
                    question: "What is a group of stars forming a recognizable pattern called?",
                    options: ["Galaxy", "Nebula", "Constellation", "Asteroid"],
                    answer: "Constellation"
                },
                {
                    question: "What is the common name for a 'shooting star'?",
                    options: ["Comet", "Meteor", "Asteroid", "Satellite"],
                    answer: "Meteor"
                }
            ],
            medium: [
                {
                    question: "Which galaxy is our solar system a part of?",
                    options: ["Andromeda", "Triangulum", "Pinwheel", "Milky Way"],
                    answer: "Milky Way"
                },
                {
                    question: "What force keeps planets in orbit around the Sun?",
                    options: ["Magnetism", "Air Pressure", "Gravity", "Friction"],
                    answer: "Gravity"
                },
                {
                    question: "What is the name of the nearest star to Earth?",
                    options: ["Sirius", "Alpha Centauri", "Proxima Centauri", "Vega"],
                    answer: "Proxima Centauri"
                },
                {
                    question: "Which planet has a prominent system of rings?",
                    options: ["Jupiter", "Uranus", "Neptune", "Saturn"],
                    answer: "Saturn"
                },
                {
                    question: "What is the term for a star that has collapsed into a very dense object, from which nothing, not even light, can escape?",
                    options: ["Neutron Star", "Red Giant", "White Dwarf", "Black Hole"],
                    answer: "Black Hole"
                }
            ],
            hard: [
                {
                    question: "What is the approximate age of the Universe?",
                    options: ["4.5 billion years", "13.8 billion years", "7.2 billion years", "20 billion years"],
                    answer: "13.8 billion years"
                },
                {
                    question: "Which space telescope was launched in 1990 and revolutionized our understanding of the universe?",
                    options: ["James Webb", "Kepler", "Hubble", "Chandra"],
                    answer: "Hubble"
                },
                {
                    question: "What is the coldest known temperature in the universe?",
                    options: ["Absolute Zero", "Cosmic Microwave Background (CMB)", "Boiling point of liquid nitrogen", "Surface of Pluto"],
                    answer: "Absolute Zero"
                },
                {
                    question: "The hypothetical boundary around a black hole beyond which no events can affect an outside observer is called the:",
                    options: ["Singularity", "Accretion Disk", "Event Horizon", "Schwarzschild Radius"],
                    answer: "Event Horizon"
                },
                {
                    question: "What is the phenomenon where light from distant galaxies is stretched to longer, redder wavelengths as the universe expands?",
                    options: ["Blue Shift", "Gravitational Lensing", "Red Shift", "Cosmic Radiation"],
                    answer: "Red Shift"
                }
            ]
        };

        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedQuizLevel = '';

        // --- DOM Elements for Quiz ---
        const quizLevelSelection = document.getElementById('quiz-level-selection');
        const quizContainer = document.getElementById('quiz-container');
        const quizScoreDisplay = document.getElementById('quiz-score');
        const quizQuestionDisplay = document.getElementById('quiz-question');
        const quizOptionsContainer = document.getElementById('quiz-options');
        const quizFeedbackDisplay = document.getElementById('quiz-feedback');
        const quizNextButton = document.getElementById('quiz-next-btn');
        const quizResetButton = document.getElementById('quiz-reset-btn');


        // --- Space Calendar Variables ---
        let currentCalendarDate = new Date(); // Current date displayed in calendar
        // Sample Space Events data (Expanded to include more historical events)
        const SPACE_EVENTS = [
            { date: "2025-07-20", title: "Apollo 11 Anniversary", description: "56 years since humans first walked on the Moon.", category: "Anniversary" },
            { date: "2025-07-28", title: "Perseid Meteor Shower Peak", description: "One of the brightest meteor showers of the year, visible after midnight.", category: "Meteor Shower" },
            { date: "2025-08-01", title: "Mars Sample Return Launch Window Opens", description: "Start of the launch window for the next Mars mission.", category: "Launch" },
            { date: "2025-08-15", title: "Jupiter Opposition", description: "Jupiter will be directly opposite the Sun, appearing brightest in the night sky.", category: "Alignment" },
            { date: "2025-09-05", title: "Voyager 1 Anniversary", description: "48 years since Voyager 1 launched, carrying humanity's message to the stars.", category: "Anniversary" },
            { date: "2025-09-22", title: "Autumnal Equinox", description: "Astronomical start of Autumn in the Northern Hemisphere.", category: "Astronomical" },
            { date: "2025-10-10", title: "Draconid Meteor Shower", description: "Minor meteor shower, best viewed in the early evening.", category: "Meteor Shower" },
            { date: "2025-11-17", title: "Leonid Meteor Shower Peak", description: "Another active meteor shower, known for potential meteor storms every 33 years.", category: "Meteor Shower" },
            { date: "2025-12-21", title: "Winter Solstice", description: "Astronomical start of Winter in the Northern Hemisphere.", category: "Astronomical" },
            { date: "2026-01-03", title: "Quadrantid Meteor Shower", description: "One of the most active but short-lived meteor showers of the year.", category: "Meteor Shower" },
            { date: "2026-02-18", title: "Perseverance Rover Anniversary on Mars", description: "4 years since the rover landed on Mars.", category: "Anniversary" },
            // Additional historical events for diverse dates
            { date: "1969-07-20", title: "Apollo 11 Moon Landing", description: "First humans land on the Moon (Neil Armstrong, Buzz Aldrin).", category: "Historic Mission" },
            { date: "1976-07-20", title: "Viking 1 Lands on Mars", description: "First successful landing of a U.S. spacecraft on Mars.", category: "Historic Mission" },
            { date: "1962-02-20", title: "John Glenn Orbits Earth", description: "First American to orbit Earth aboard Friendship 7.", category: "Historic Flight" },
            { date: "1990-04-24", title: "Hubble Space Telescope Launched", description: "Deployment of the iconic space telescope.", category: "Launch" },
            { date: "1971-05-30", title: "Mariner 9 Launched", description: "First spacecraft to orbit another planet (Mars).", category: "Launch" },
            { date: "1977-09-05", title: "Voyager 1 Launched", description: "Longest-operating and most distant spacecraft.", category: "Launch" },
            { date: "2006-01-19", title: "New Horizons Launched", description: "Mission to Pluto and the Kuiper Belt.", category: "Launch" },
            { date: "1957-10-04", title: "Sputnik 1 Launched", description: "First artificial Earth satellite.", category: "Historic Launch" },
            { date: "1961-04-12", title: "Yuri Gagarin First Man in Space", description: "First human spaceflight, Vostok 1.", category: "Historic Flight" },
            { date: "2000-11-02", title: "ISS Expedition 1 Arrives", description: "First resident crew arrives at the International Space Station.", category: "Space Station" },
            { date: "1965-03-18", title: "Alexei Leonov First Spacewalk", description: "First person to perform a spacewalk.", category: "Historic Spacewalk" },
            { date: "2012-08-06", title: "Curiosity Rover Lands on Mars", description: "NASA's large rover lands in Gale Crater on Mars.", category: "Historic Mission" },
            { date: "1966-02-03", title: "Luna 9 First Soft Moon Landing", description: "Soviet probe achieves first soft landing on the Moon.", category: "Historic Mission" },
            { date: "1986-01-28", title: "Challenger Disaster", description: "Space Shuttle Challenger breaks apart 73 seconds after launch.", category: "Tragedy" },
            { date: "2003-02-01", title: "Columbia Disaster", description: "Space Shuttle Columbia disintegrates upon re-entry.", category: "Tragedy" },
            { date: "1970-04-17", title: "Apollo 13 Returns to Earth", description: "Crew safely returns after a critical in-flight anomaly.", category: "Historic Return" },
            { date: "1998-11-20", title: "Zarya Module Launched (ISS)", description: "First module of the International Space Station launched.", category: "Launch" },
            { date: "2004-01-04", title: "Spirit Rover Lands on Mars", description: "NASA's Mars Exploration Rover begins its mission.", category: "Historic Mission" },
            { date: "2004-01-25", title: "Opportunity Rover Lands on Mars", description: "Spirit's twin rover lands, exceeding expectations.", category: "Historic Mission" },
            { date: "1965-11-26", title: "Astro-X (French Satellite) Launched", description: "First French satellite launched, making France the third space power.", category: "Historic Launch" },
            { date: "1972-12-07", title: "Apollo 17 Launched", description: "Last Apollo mission to the Moon.", category: "Historic Mission" },
            { date: "1996-12-04", title: "Mars Pathfinder Launched", description: "First spacecraft to land a rover on Mars.", category: "Launch" },
            { date: "2014-11-12", title: "Philae Lander on Comet", description: "Philae lander touches down on Comet 67P.", category: "Historic Landing" },
            { date: "2005-01-14", title: "Huygens Probe Lands on Titan", description: "Huygens probe successfully lands on Saturn's moon Titan.", category: "Historic Landing" },
            { date: "1981-04-12", title: "First Space Shuttle Flight (Columbia)", description: "STS-1, the inaugural flight of the Space Shuttle program.", category: "Historic Flight" },
            { date: "1963-06-16", title: "Valentina Tereshkova First Woman in Space", description: "Vostok 6 mission, first woman in space.", category: "Historic Flight" }
        ];

        // --- DOM Elements for Calendar ---
        const currentMonthYearDisplay = document.getElementById('currentMonthYear');
        const calendarDaysContainer = document.getElementById('calendarDays');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');

        // --- DOM Elements for Modal ---
        const eventModal = document.getElementById('eventModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalEventTitle = document.getElementById('modalEventTitle');
        const modalEventDate = document.getElementById('modalEventDate');
        const modalEventDescription = document.getElementById('modalEventDescription');
        const modalMoonPhase = document.getElementById('modalMoonPhase'); // New element for moon phase in modal
        const llmStoryLoading = document.getElementById('llmStoryLoading');


        // --- Multi-Page Navigation Logic ---
        const mainContentContainer = document.getElementById('main-content-container');
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.content-section');

        function showSection(targetId) {
            sections.forEach(section => {
                if (section.id === targetId) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
            // Update URL hash
            window.location.hash = targetId;

            // Manage Three.js scenes based on active section
            if (targetId === 'solar-system-section') {
                if (!solarSystemInitialized) {
                    solarSystemLoadingOverlay = document.getElementById('solarSystemLoadingOverlay');
                    solarSystemLoadingOverlay.style.display = 'flex';
                    setTimeout(() => {
                        initSolarSystem();
                        animateSolarSystem(); // Start animation loop
                        solarSystemInitialized = true;
                    }, 100);
                } else {
                    // Ensure the correct canvas is visible and handling events
                    document.getElementById('solarSystemCanvas').style.display = 'block';
                    onWindowResize(); // Adjust size if window changed
                }
                // Hide constellation canvas if it was active
                if (constellationsInitialized) {
                     document.getElementById('constellationsCanvas').style.display = 'none';
                     // Also clear constellation highlight and popup if active
                     if (previouslyClickedConstellationStar) {
                        const previousConstellationName = previouslyClickedConstellationStar.userData.name;
                        constellationsGroup.children.forEach(group => {
                            if (group instanceof THREE.Group) {
                                group.children.forEach(child => {
                                    if (child.isMesh && child.geometry.type === 'SphereGeometry' && child.userData.name === previousConstellationName) {
                                        if (child.material && child.material.emissive) {
                                            child.material.emissive.setHex(child.userData.originalEmissive);
                                        }
                                    }
                                });
                            }
                        });
                        previouslyClickedConstellationStar = null;
                     }
                     if (constellationInfoPopup) {
                        constellationInfoPopup.classList.remove('show');
                        constellationInfoPopup.classList.add('hidden');
                     }
                }
            } else if (targetId === 'constellations-section') {
                if (!constellationsInitialized) {
                    constellationsLoadingOverlay = document.getElementById('constellationsLoadingOverlay');
                    constellationsLoadingOverlay.style.display = 'flex';
                    setTimeout(() => {
                        initConstellations();
                        animateConstellations(); // Start animation loop
                        constellationsInitialized = true;
                    }, 100);
                } else {
                    // Ensure the correct canvas is visible and handling events
                    document.getElementById('constellationsCanvas').style.display = 'block';
                    onWindowResize(); // Adjust size if window changed
                }
                // Hide solar system canvas if it was active
                if (solarSystemInitialized) {
                    document.getElementById('solarSystemCanvas').style.display = 'none';
                    // Also clear any previous highlight and popup when switching away
                    if (solarSystemPreviouslyClickedObject) {
                        solarSystemPreviouslyClickedObject.material.emissive.setHex(solarSystemPreviouslyClickedObject.userData.originalEmissive);
                        solarSystemPreviouslyClickedObject = null;
                    }
                    if (planetInfoPopup) {
                        planetInfoPopup.classList.remove('show');
                        planetInfoPopup.classList.add('hidden');
                    }
                }
            } else {
                // For other sections, ensure both canvases are hidden
                if (solarSystemInitialized) {
                    document.getElementById('solarSystemCanvas').style.display = 'none';
                    // Clear highlight and popup
                    if (solarSystemPreviouslyClickedObject) {
                        solarSystemPreviouslyClickedObject.material.emissive.setHex(solarSystemPreviouslyClickedObject.userData.originalEmissive);
                        solarSystemPreviouslyClickedObject = null;
                    }
                    if (planetInfoPopup) {
                        planetInfoPopup.classList.remove('show');
                        planetInfoPopup.classList.add('hidden');
                    }
                }
                if (constellationsInitialized) {
                    document.getElementById('constellationsCanvas').style.display = 'none';
                     // Also clear constellation highlight and popup if active
                     if (previouslyClickedConstellationStar) {
                        const previousConstellationName = previouslyClickedConstellationStar.userData.name;
                        constellationsGroup.children.forEach(group => {
                            if (group instanceof THREE.Group) {
                                group.children.forEach(child => {
                                    if (child.isMesh && child.geometry.type === 'SphereGeometry' && child.userData.name === previousConstellationName) {
                                        if (child.material && child.material.emissive) {
                                            child.material.emissive.setHex(child.userData.originalEmissive);
                                        }
                                    }
                                });
                            }
                        });
                        previouslyClickedConstellationStar = null;
                     }
                     if (constellationInfoPopup) {
                        constellationInfoPopup.classList.remove('show');
                        constellationInfoPopup.classList.add('hidden');
                     }
                }
            }
        }

        // Event listeners for navigation links
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent default anchor link behavior
                const targetId = e.target.dataset.target;
                if (targetId) {
                    showSection(targetId);
                }
            });
        });

        // Handle initial load and hash changes
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.substring(1); // Remove the '#'
            if (hash) {
                showSection(hash);
            } else {
                showSection('intro-section'); // Default to intro if no hash
            }
        });

        // --- Three.js Initialization Function (Solar System) ---
        function initSolarSystem() {
            // Get canvas and container
            const canvas = document.getElementById('solarSystemCanvas');
            const container = document.getElementById('solarSystemCanvas-container');
            solarSystemLoadingOverlay = document.getElementById('solarSystemLoadingOverlay');
            const zoomSensitivitySlider = document.getElementById('zoomSensitivity');

            // Initialize DOM elements for planet info pop-up
            planetInfoPopup = document.getElementById('planetInfoPopup');
            popupPlanetName = document.getElementById('popupPlanetName');
            popupPlanetFacts = document.getElementById('popupPlanetFacts');

            // Hide loading overlay once initialization begins
            solarSystemLoadingOverlay.style.display = 'none';

            // Scene setup
            solarSystemScene = new THREE.Scene();
            solarSystemScene.background = new THREE.Color(0x000000); // Pure black space background

            // Add starfield background
            const starGeometry = new THREE.BufferGeometry();
            const starCount = 20000; // Increased star count for denser background
            const positions = new Float32Array(starCount * 3);
            for (let i = 0; i < starCount * 3; i++) {
                positions[i] = (Math.random() - 0.5) * 4000; // Stars spread out in a larger cube
            }
            starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 1, sizeAttenuation: true }); // White stars, slightly larger
            solarSystemStarsBackground = new THREE.Points(starGeometry, starMaterial);
            solarSystemScene.add(solarSystemStarsBackground);


            // Camera setup
            solarSystemCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            solarSystemCamera.position.set(0, 10, 25); // Initial camera position
            solarSystemCamera.lookAt(0, 0, 0); // Look at the origin (where the sun will be)

            // Renderer setup
            solarSystemRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            solarSystemRenderer.setSize(container.clientWidth, 600); // Set initial size
            solarSystemRenderer.setPixelRatio(window.devicePixelRatio); // Optimize for high-DPI screens

            // Sun (now part of PLANET_DATA for consistency in pop-up logic)
            const sunData = PLANET_DATA.find(p => p.name === 'Sun');
            // Store original emissive color from PLANET_DATA for the Sun
            const sunMaterial = new THREE.MeshBasicMaterial({ color: sunData.color, emissive: sunData.originalEmissive });
            sun = new THREE.Mesh(new THREE.SphereGeometry(sunData.radius, 32, 32), sunMaterial);
            sun.name = "Sun"; // Assign a name for raycasting
            sun.userData = { facts: sunData.facts, originalEmissive: sunData.originalEmissive }; // Store facts and original emissive
            solarSystemScene.add(sun);

            // Light source (from the sun) - adjusted intensity
            const pointLight = new THREE.PointLight(0xffffff, 3, 1000); // White light, increased intensity
            sun.add(pointLight); // Attach light to the sun so it moves with it (though sun is static here)

            // Ambient light to ensure planets are visible
            const ambientLight = new THREE.AmbientLight(0x404040); // Soft white light
            solarSystemScene.add(ambientLight);

            // Planets and their orbits
            PLANET_DATA.forEach(data => {
                if (data.name === 'Sun') return; // Sun is handled separately

                const planetGroup = new THREE.Group(); // Group for planet + label + potential rings
                solarSystemScene.add(planetGroup);

                // Store original emissive color from PLANET_DATA for each planet
                const planetMaterial = new THREE.MeshPhongMaterial({ color: data.color, emissive: data.originalEmissive, emissiveIntensity: 0.8 }); // Added emissive to default
                const planet = new THREE.Mesh(new THREE.SphereGeometry(data.radius, 32, 32), planetMaterial);
                planet.name = data.name; // Assign name for raycasting
                planet.userData = { facts: data.facts, originalEmissive: data.originalEmissive }; // Store additional data and original emissive
                // Set axial tilt
                planet.rotation.z = data.axialTilt || 0; // Apply axial tilt

                planetGroup.add(planet); // Add planet mesh to its group
                planets.push({ mesh: planet, data: data, angle: 0, group: planetGroup }); // Store mesh, data, angle, and group

                // Create orbital path
                const orbitGeometry = new THREE.RingGeometry(data.distance - 0.02, data.distance + 0.02, 64);
                const orbitMaterial = new THREE.MeshBasicMaterial({ color: 0x333333, side: THREE.DoubleSide });
                const orbit = new THREE.Mesh(orbitGeometry, orbitMaterial);
                orbit.rotation.x = Math.PI / 2; // Rotate to lie flat on XZ plane
                solarSystemScene.add(orbit);
                orbitLines.push(orbit); // Store orbit line for toggling

                // Add planet name label
                const textCanvas = document.createElement('canvas');
                const context = textCanvas.getContext('2d');
                const fontSize = 48; // Adjust font size
                context.font = `Bold ${fontSize}px Arial`;
                context.fillStyle = `white`;
                const textWidth = context.measureText(data.name).width;
                textCanvas.width = textWidth + 20;
                textCanvas.height = fontSize + 20;
                context.font = `Bold ${fontSize}px Arial`;
                context.fillStyle = `white`;
                context.fillText(data.name, 10, fontSize + 5);

                const texture = new THREE.CanvasTexture(textCanvas);
                const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
                const sprite = new THREE.Sprite(spriteMaterial);
                sprite.scale.set(textCanvas.width * 0.02, textCanvas.height * 0.02, 1);
                sprite.position.set(0, data.radius + 0.3, 0); // Position label above the planet relative to its local origin
                planet.add(sprite); // Attach label to planet so it rotates with it

                // Add Saturn's rings
                if (data.name === 'Saturn') {
                    const ringGeometry = new THREE.RingGeometry(data.radius * 1.2, data.radius * 2.0, 64);
                    const ringMaterial = new THREE.MeshBasicMaterial({ color: 0x969696, side: THREE.DoubleSide });
                    const rings = new THREE.Mesh(ringGeometry, ringMaterial);
                    rings.rotation.x = Math.PI / 2; // Keep rings flat relative to planet's axis
                    rings.rotation.y = Math.PI / 4; // Tilt rings for visual effect
                    planet.add(rings); // Add rings to the planet group
                }
            });

            // Meteors (simple random spheres)
            const numMeteors = 100;
            const meteorGeometry = new THREE.SphereGeometry(0.05, 8, 8);
            // Enhanced meteor material: brighter color and emissive property for glow
            const meteorMaterial = new THREE.MeshBasicMaterial({ color: 0xFFFFFF, emissive: 0xFFFFFF, emissiveIntensity: 0.5 }); // Bright white with glow
            for (let i = 0; i < numMeteors; i++) {
                const meteor = new THREE.Mesh(meteorGeometry, meteorMaterial);
                // Random position within a certain range
                meteor.position.set(
                    (Math.random() - 0.5) * 50,
                    (Math.random() - 0.5) * 50,
                    (Math.random() - 0.5) * 50
                );
                // Store initial velocity for movement
                meteor.velocity = new THREE.Vector3(
                    (Math.random() - 0.5) * 0.02,
                    (Math.random() - 0.5) * 0.02,
                    (Math.random() - 0.5) * 0.02
                );
                solarSystemScene.add(meteor);
                meteors.push(meteor);
            }

            // Event Listeners for Camera Control
            let rotateSpeed = 0.005;

            canvas.addEventListener('mousedown', (e) => {
                solarSystemIsDragging = true;
                solarSystemPreviousMouseX = e.clientX;
                solarSystemPreviousMouseY = e.clientY;
            });

            canvas.addEventListener('mouseup', () => {
                solarSystemIsDragging = false;
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!solarSystemIsDragging) return;

                const deltaX = e.clientX - solarSystemPreviousMouseX;
                const deltaY = e.clientY - solarSystemPreviousY;

                // Rotate camera around the origin
                const spherical = new THREE.Spherical().setFromVector3(solarSystemCamera.position);
                spherical.theta -= deltaX * rotateSpeed;
                spherical.phi -= deltaY * rotateSpeed;

                // Restrict vertical rotation to prevent flipping
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));

                solarSystemCamera.position.setFromSpherical(spherical);
                solarSystemCamera.lookAt(0, 0, 0); // Always look at the center of the solar system

                solarSystemPreviousX = e.clientX;
                solarSystemPreviousY = e.clientY;
            });

            canvas.addEventListener('wheel', (e) => {
                e.preventDefault(); // Prevent page scrolling

                const zoomFactor = solarSystemZoomSensitivity * 0.005; // Base sensitivity
                const zoomAmount = e.deltaY * solarSystemCamera.position.length() * zoomFactor; 
                let newDistance = solarSystemCamera.position.length() + zoomAmount;

                const minDistance = 2; // Closer minimum distance
                const maxDistance = 200; // Further maximum distance

                newDistance = Math.max(minDistance, Math.min(maxDistance, newDistance));

                solarSystemCamera.position.setLength(newDistance);
                solarSystemCamera.lookAt(0, 0, 0);
            });

            // Event Listener for object interaction (click)
            canvas.addEventListener('click', onSolarSystemCanvasClick);

            // Handle window resizing
            window.addEventListener('resize', onWindowResize);
            // onWindowResize(); // Called by showSection now

            // Zoom Sensitivity Slider Listener
            zoomSensitivitySlider.addEventListener('input', (event) => {
                solarSystemZoomSensitivity = parseFloat(event.target.value);
            });

            solarSystemLoadingOverlay.style.display = 'none'; // Hide overlay once everything is rendered
        }

        // Raycasting for planet info pop-up and highlighting
        function onSolarSystemCanvasClick(event) {
            event.preventDefault();

            // Calculate mouse position in normalized device coordinates (-1 to +1)
            const canvas = document.getElementById('solarSystemCanvas');
            const rect = canvas.getBoundingClientRect();
            solarSystemMouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            solarSystemMouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            // Update the raycaster with the camera and mouse position
            solarSystemRaycaster.setFromCamera(solarSystemMouse, solarSystemCamera);

            // Collect all identifiable meshes (planets + sun) for raycasting
            const interactableObjects = [sun];
            planets.forEach(p => interactableObjects.push(p.mesh));

            // Calculate objects intersecting the ray
            const intersects = solarSystemRaycaster.intersectObjects(interactableObjects);

            let clickedCelestialBody = null;
            if (intersects.length > 0) {
                // The first intersected object is the closest one
                clickedCelestialBody = intersects[0].object;
            }

            // --- Highlighting Logic ---
            if (solarSystemPreviouslyClickedObject) {
                // Revert previously clicked object's emissive color to its original state
                const originalColor = solarSystemPreviouslyClickedObject.userData.originalEmissive;
                if (solarSystemPreviouslyClickedObject.material.emissive) {
                    solarSystemPreviouslyClickedObject.material.emissive.setHex(originalColor);
                }
            }

            if (clickedCelestialBody) {
                // Highlight the newly clicked object
                if (clickedCelestialBody.material.emissive) {
                    clickedCelestialBody.material.emissive.setHex(HIGHLIGHT_COLOR);
                }
                solarSystemPreviouslyClickedObject = clickedCelestialBody; // Store for next click

                // Display planet info popup
                const bodyData = PLANET_DATA.find(p => p.name === clickedCelestialBody.name);
                if (bodyData) {
                    popupPlanetName.textContent = bodyData.name;
                    popupPlanetFacts.textContent = bodyData.facts;
                    
                    // Position the popup near the clicked object
                    const vector = new THREE.Vector3();
                    clickedCelestialBody.getWorldPosition(vector);
                    vector.project(solarSystemCamera);

                    const x = (vector.x * .5 + .5) * canvas.offsetWidth;
                    const y = (-vector.y * .5 + .5) * canvas.offsetHeight;

                    planetInfoPopup.style.left = `${x}px`;
                    planetInfoPopup.style.top = `${y}px`;
                    planetInfoPopup.classList.add('show');
                    planetInfoPopup.classList.remove('hidden'); // Ensure it's not display: none
                }
            } else {
                // No object clicked, hide popup and clear highlight
                planetInfoPopup.classList.remove('show');
                planetInfoPopup.classList.add('hidden');
                solarSystemPreviouslyClickedObject = null; // Clear previously clicked object
            }
        }

        function animateSolarSystem() {
            requestAnimationFrame(animateSolarSystem);

            // Animate planets (orbital and axial rotation)
            planets.forEach(p => {
                // Orbital rotation
                p.angle += p.data.orbitalSpeed;
                p.group.position.x = p.data.distance * Math.cos(p.angle);
                p.group.position.z = p.data.distance * Math.sin(p.angle);

                // Axial rotation (rotate the planet mesh itself within its group)
                p.mesh.rotation.y += p.data.rotationSpeed;
            });

            // Animate meteors
            meteors.forEach(meteor => {
                meteor.position.add(meteor.velocity);

                // Simple boundary check for meteors to keep them within a reasonable area
                if (meteor.position.length() > 30) {
                    // Reset meteor position if it goes too far
                    meteor.position.set(
                        (Math.random() - 0.5) * 50,
                        (Math.random() - 0.5) * 50,
                        (Math.random() - 0.5) * 50
                    );
                }
            });

            solarSystemRenderer.render(solarSystemScene, solarSystemCamera);
        }

        // --- Three.js Initialization Function (Constellations) ---
        function initConstellations() {
            const canvas = document.getElementById('constellationsCanvas');
            const container = document.getElementById('constellationsCanvas-container');
            constellationsLoadingOverlay = document.getElementById('constellationsLoadingOverlay');

            // Initialize DOM elements for constellation info pop-up
            constellationInfoPopup = document.getElementById('constellationInfoPopup');
            constellationPopupName = document.getElementById('constellationPopupName');
            constellationPopupFolklore = document.getElementById('constellationPopupFolklore');
            constellationPopupEncyclopedic = document.getElementById('constellationPopupEncyclopedic');


            constellationsLoadingOverlay.style.display = 'none';

            constellationsScene = new THREE.Scene();
            constellationsScene.background = new THREE.Color(0x000000);

            constellationsCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            constellationsCamera.position.set(0, 20, 50); // Initial camera position for constellations
            constellationsCamera.lookAt(0, 0, 0);

            constellationsRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            constellationsRenderer.setSize(container.clientWidth, 600);
            constellationsRenderer.setPixelRatio(window.devicePixelRatio);

            // Add a dedicated starfield background for constellations
            const starGeometry = new THREE.BufferGeometry();
            const starCount = 30000; // Even more stars for the background
            const positions = new Float32Array(starCount * 3);
            for (let i = 0; i < starCount * 3; i++) {
                positions[i] = (Math.random() - 0.5) * 4000; // Larger spread
            }
            starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.8, sizeAttenuation: true });
            constellationsStarsBackground = new THREE.Points(starGeometry, starMaterial);
            constellationsScene.add(constellationsStarsBackground);

            // Add Sun at the center for constellations view
            const constellationsSunMaterial = new THREE.MeshBasicMaterial({ color: 0xFDB813, emissive: 0xFDB813, emissiveIntensity: 0.8 });
            constellationsSun = new THREE.Mesh(new THREE.SphereGeometry(3, 32, 32), constellationsSunMaterial); // Larger sun for visual emphasis
            constellationsScene.add(constellationsSun);

            // Add Earth orbiting the Sun in the constellation view
            const constellationsEarthMaterial = new THREE.MeshPhongMaterial({ color: 0x10B981 });
            constellationsEarth = new THREE.Mesh(new THREE.SphereGeometry(0.8, 32, 32), constellationsEarthMaterial); // Earth size relative to sun
            constellationsEarth.position.set(10, 0, 0); // Initial position for Earth
            constellationsScene.add(constellationsEarth);
            constellationsEarth.userData.orbitalAngle = 0; // Custom property to track orbital angle
            constellationsEarth.userData.orbitalRadius = 10; // Radius of Earth's orbit
            constellationsEarth.userData.orbitalSpeed = 0.005; // Speed of Earth's orbit

            // Add light to the constellation scene (from the sun)
            const constellationsPointLight = new THREE.PointLight(0xffffff, 2, 200);
            constellationsSun.add(constellationsPointLight); // Attach light to the sun
            const constellationsAmbientLight = new THREE.AmbientLight(0x404040);
            constellationsScene.add(constellationsAmbientLight);


            // Group for all constellations
            constellationsGroup = new THREE.Group();
            constellationsScene.add(constellationsGroup);

            // Parameters for circular arrangement
            const zodiacOrbitRadius = 40; // How far constellations are from the center
            const constellationScale = 0.8; // Scale down individual constellation shapes

            ZODIAC_CONSTELLATION_DATA.forEach(constellation => {
                const starMeshes = []; // Store star meshes for adding to scene and connecting

                // Calculate position for the constellation group itself
                const angleRad = (constellation.angleOffset * Math.PI) / 180;
                // Add some vertical offset (Y-axis) to avoid all constellations being on the exact same plane if desired, and to better represent the image
                const groupY = (Math.random() - 0.5) * 10; // Random vertical offset
                const groupX = zodiacOrbitRadius * Math.cos(angleRad);
                const groupZ = zodiacOrbitRadius * Math.sin(angleRad);

                const constellationIndividualGroup = new THREE.Group();
                constellationIndividualGroup.position.set(groupX, groupY, groupZ);
                constellationIndividualGroup.rotation.y = -angleRad + Math.PI / 2; // Orient constellation towards center (approx)
                constellationsGroup.add(constellationIndividualGroup);


                constellation.stars.forEach(sPos => {
                    const starGeometry = new THREE.SphereGeometry(0.5, 16, 16); // Larger stars for visibility
                    const starMaterial = new THREE.MeshBasicMaterial({ color: constellation.color, emissive: constellation.color, emissiveIntensity: 0.2 }); // Reduced emissiveIntensity for default
                    const star = new THREE.Mesh(starGeometry, starMaterial);
                    
                    // Position relative to the constellation's group origin, scaled
                    star.position.set(sPos[0] * constellationScale, sPos[1] * constellationScale, sPos[2] * constellationScale);
                    star.name = constellation.name; // Assign constellation name to star for identification
                    star.userData = { // Store full constellation data for pop-up
                        name: constellation.name,
                        folklore: constellation.folklore,
                        encyclopedic: constellation.encyclopedic,
                        originalEmissive: constellation.color // Store the original hex value directly
                    };
                    constellationIndividualGroup.add(star); // Add star to its individual constellation group
                    starMeshes.push(star);
                });

                // Draw lines connecting stars using indices (relative to constellation group)
                const linePoints = [];
                constellation.lines.forEach(lineIndices => {
                    const startStar = starMeshes[lineIndices[0]];
                    const endStar = starMeshes[lineIndices[1]];
                    if (startStar && endStar) {
                        linePoints.push(startStar.position, endStar.position);
                    }
                });

                if (linePoints.length > 0) {
                    const lineGeometry = new THREE.BufferGeometry().setFromPoints(linePoints);
                    const lineMaterial = new THREE.LineBasicMaterial({ color: constellation.color, linewidth: 3 }); // Thicker lines
                    const constellationLine = new THREE.LineSegments(lineGeometry, lineMaterial); // Use LineSegments for disconnected lines
                    constellationIndividualGroup.add(constellationLine); // Add lines to its individual constellation group
                }
            });

            // Camera controls for constellations
            const canvasConstellations = document.getElementById('constellationsCanvas');
            let rotateSpeedConstellations = 0.005;
            let zoomSpeedConstellations = 0.5;

            canvasConstellations.addEventListener('mousedown', (e) => {
                constellationsIsDragging = true;
                constellationsPreviousX = e.clientX;
                constellationsPreviousY = e.clientY;
            });

            canvasConstellations.addEventListener('mouseup', () => {
                constellationsIsDragging = false;
            });

            canvasConstellations.addEventListener('mousemove', (e) => {
                if (!constellationsIsDragging) return;

                const deltaX = e.clientX - constellationsPreviousX;
                const deltaY = e.clientY - constellationsPreviousY;

                const spherical = new THREE.Spherical().setFromVector3(constellationsCamera.position);
                spherical.theta -= deltaX * rotateSpeedConstellations;
                spherical.phi -= deltaY * rotateSpeedConstellations;
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));

                constellationsCamera.position.setFromSpherical(spherical);
                constellationsCamera.lookAt(0, 0, 0);

                constellationsPreviousX = e.clientX;
                constellationsPreviousY = e.clientY;
            });

            canvasConstellations.addEventListener('wheel', (e) => {
                e.preventDefault();

                const zoomFactor = zoomSpeedConstellations * 0.01;
                let newDistance = constellationsCamera.position.length() + e.deltaY * zoomFactor * constellationsCamera.position.length();

                const minDistance = 10;
                const maxDistance = 100;
                newDistance = Math.max(minDistance, Math.min(maxDistance, newDistance));

                constellationsCamera.position.setLength(newDistance);
                constellationsCamera.lookAt(0, 0, 0);
            });

            // Event Listener for object interaction (click) for constellations
            canvasConstellations.addEventListener('click', onConstellationCanvasClick);
        }

        // Raycasting for constellation info pop-up and highlighting
        function onConstellationCanvasClick(event) {
            event.preventDefault();

            const canvas = document.getElementById('constellationsCanvas');
            const rect = canvas.getBoundingClientRect();
            constellationsMouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            constellationsMouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            constellationsRaycaster.setFromCamera(constellationsMouse, constellationsCamera);

            // We need to check all stars within the constellationsGroup
            // Find all stars to make them clickable (they are nested within individual constellation groups)
            const clickableStars = [];
            constellationsGroup.children.forEach(constellationIndividualGroup => {
                if (constellationIndividualGroup instanceof THREE.Group) { // Ensure it's a group
                    constellationIndividualGroup.children.forEach(child => {
                        if (child.isMesh && child.geometry.type === 'SphereGeometry') { // Ensure it's a star mesh
                            clickableStars.push(child);
                        }
                    });
                }
            });


            const intersects = constellationsRaycaster.intersectObjects(clickableStars);

            let clickedConstellationStar = null;
            if (intersects.length > 0) {
                // Get the closest intersected star
                clickedConstellationStar = intersects[0].object;
            }

            // --- Highlighting Logic ---
            // First, reset any previously highlighted constellation
            if (previouslyClickedConstellationStar) {
                // Find all stars belonging to the previously clicked constellation
                const previousConstellationName = previouslyClickedConstellationStar.userData.name;
                constellationsGroup.children.forEach(group => {
                    if (group instanceof THREE.Group) {
                        group.children.forEach(child => {
                            if (child.isMesh && child.geometry.type === 'SphereGeometry' && child.userData.name === previousConstellationName) {
                                // Defensive check added here
                                if (child.material && child.material.emissive) {
                                    child.material.emissive.setHex(child.userData.originalEmissive);
                                }
                            }
                        });
                    }
                });
            }


            if (clickedConstellationStar) {
                // Highlight all stars belonging to the newly clicked constellation
                const currentConstellationName = clickedConstellationStar.userData.name;
                constellationsGroup.children.forEach(group => {
                    if (group instanceof THREE.Group) {
                        group.children.forEach(child => {
                            if (child.isMesh && child.geometry.type === 'SphereGeometry' && child.userData.name === currentConstellationName) {
                                // Defensive check added here
                                if (child.material && child.material.emissive) {
                                    child.material.emissive.setHex(HIGHLIGHT_COLOR);
                                }
                            }
                        });
                    }
                });

                previouslyClickedConstellationStar = clickedConstellationStar; // Store one of the stars from the current constellation

                // Display constellation info popup
                constellationPopupName.textContent = clickedConstellationStar.userData.name;
                constellationPopupFolklore.textContent = clickedConstellationStar.userData.folklore;
                constellationPopupEncyclopedic.textContent = clickedConstellationStar.userData.encyclopedic;
                
                // Position the popup near the clicked star
                const vector = new THREE.Vector3();
                clickedConstellationStar.getWorldPosition(vector);
                vector.project(constellationsCamera);

                const x = (vector.x * .5 + .5) * canvas.offsetWidth;
                const y = (-vector.y * .5 + .5) * canvas.offsetHeight;

                constellationInfoPopup.style.left = `${x}px`;
                constellationInfoPopup.style.top = `${y}px`;
                constellationInfoPopup.classList.add('show');
                constellationInfoPopup.classList.remove('hidden'); // Ensure it's not display: none
            } else {
                // No object clicked, hide popup and clear highlight
                constellationInfoPopup.classList.remove('show');
                constellationInfoPopup.classList.add('hidden');
                previouslyClickedConstellationStar = null; // Clear previously clicked object
            }
        }

        function animateConstellations() {
            requestAnimationFrame(animateConstellations);

            // Animate Earth's orbit around the constellations Sun
            if (constellationsEarth) {
                constellationsEarth.userData.orbitalAngle += constellationsEarth.userData.orbitalSpeed;
                constellationsEarth.position.x = constellationsEarth.userData.orbitalRadius * Math.cos(constellationsEarth.userData.orbitalAngle);
                constellationsEarth.position.z = constellationsEarth.userData.orbitalRadius * Math.sin(constellationsEarth.userData.orbitalAngle);
            }

            // Optional: Rotate the entire zodiac ring slowly
            if (constellationsGroup) {
                constellationsGroup.rotation.y += 0.0002;
            }
            
            constellationsRenderer.render(constellationsScene, constellationsCamera);
        }

        // --- Shared Window Resize ---
        function onWindowResize() {
            // Solar System Canvas Resize
            const solarSystemCanvas = document.getElementById('solarSystemCanvas');
            const solarSystemContainer = document.getElementById('solarSystemCanvas-container');
            if (solarSystemInitialized && solarSystemCanvas.style.display !== 'none') { // Only resize if initialized and visible
                const newWidth = solarSystemContainer.clientWidth;
                const newHeight = 600;
                solarSystemCamera.aspect = newWidth / newHeight;
                solarSystemCamera.updateProjectionMatrix();
                solarSystemRenderer.setSize(newWidth, newHeight);
            }

            // Constellations Canvas Resize
            const constellationsCanvas = document.getElementById('constellationsCanvas');
            const constellationsContainer = document.getElementById('constellationsCanvas-container');
            if (constellationsInitialized && constellationsCanvas.style.display !== 'none') { // Only resize if initialized and visible
                const newWidth = constellationsContainer.clientWidth;
                const newHeight = 600;
                constellationsCamera.aspect = newWidth / newHeight;
                constellationsCamera.updateProjectionMatrix();
                constellationsRenderer.setSize(newWidth, newHeight);
            }
        }


        // --- Quiz Functions ---

        // Function to start the quiz with a selected level
        function startQuiz(level) {
            selectedQuizLevel = level;
            currentQuizQuestions = [...quizData[level]]; // Copy to allow shuffling/mutation
            shuffleArray(currentQuizQuestions); // Shuffle questions for variety
            currentQuestionIndex = 0;
            score = 0;

            quizLevelSelection.classList.add('hidden'); // Hide level selection
            quizContainer.classList.remove('hidden'); // Show quiz container
            quizNextButton.classList.remove('hidden'); // Show next button
            quizResetButton.classList.add('hidden'); // Hide reset button initially
            
            displayQuestion();
        }

        // Function to display the current question
        function displayQuestion() {
            quizOptionsContainer.innerHTML = ''; // Clear previous options
            quizFeedbackDisplay.textContent = ''; // Clear feedback
            quizNextButton.classList.add('hidden'); // Hide next button until answer is chosen

            if (currentQuestionIndex < currentQuizQuestions.length) {
                const question = currentQuizQuestions[currentQuestionIndex];
                quizQuestionDisplay.textContent = question.question;
                quizScoreDisplay.textContent = `Score: ${score}`;

                question.options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = 'quiz-option-btn bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-300';
                    button.onclick = () => checkAnswer(option, question.answer);
                    quizOptionsContainer.appendChild(button);
                });
            } else {
                // Quiz finished
                quizQuestionDisplay.textContent = `Quiz Finished! Your final score is: ${score} out of ${currentQuizQuestions.length}`;
                quizOptionsContainer.innerHTML = '';
                quizNextButton.classList.add('hidden'); // Hide next button
                quizResetButton.classList.remove('hidden'); // Show reset button
            }
        }

        // Function to check the selected answer
        function checkAnswer(selectedOption, correctAnswer) {
            // Disable all option buttons after selection
            Array.from(quizOptionsContainer.children).forEach(button => {
                button.disabled = true;
                if (button.textContent === correctAnswer) {
                    button.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                    button.classList.add('bg-green-600'); // Highlight correct answer
                } else if (button.textContent === selectedOption) {
                    button.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                    button.classList.add('bg-red-600'); // Highlight incorrect chosen answer
                }
            });

            if (selectedOption === correctAnswer) {
                score++;
                quizFeedbackDisplay.textContent = "Correct!";
                quizFeedbackDisplay.classList.remove('text-red-400');
                quizFeedbackDisplay.classList.add('text-green-400');
            } else {
                quizFeedbackDisplay.textContent = `Incorrect. The correct answer was: ${correctAnswer}`;
                quizFeedbackDisplay.classList.remove('text-green-400');
                quizFeedbackDisplay.classList.add('text-red-400');
            }
            quizScoreDisplay.textContent = `Score: ${score}`;
            quizNextButton.classList.remove('hidden'); // Show next button to proceed
        }

        // Function to advance to the next question
        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        // Function to reset the quiz
        function resetQuiz() {
            quizContainer.classList.add('hidden'); // Hide quiz container
            quizLevelSelection.classList.remove('hidden'); // Show level selection again
            quizFeedbackDisplay.textContent = ''; // Clear feedback
            quizScoreDisplay.textContent = 'Score: 0';
        }

        // Utility function to shuffle an array (Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- Calendar Functions ---

        /**
         * Calculates the moon phase icon for a given date.
         * A simplified algorithm based on the moon's age in the lunar cycle.
         * @param {number} year - The year.
         * @param {number} month - The month (0-11).
         * @param {number} day - The day of the month.
         * @returns {string} An emoji representing the moon phase.
         */
        function getMoonPhaseIcon(year, month, day) {
            // Calculate Julian date for the given date
            const date = new Date(year, month, day);
            const JD = date.getTime() / 86400000 + 2440587.5; // milliseconds to days + Julian date of Jan 1, 1970

            // Approximate new moon date (Jan 6, 2000, 18:14 UTC in JD)
            const newMoonJD = 2451550.09765;

            const daysSinceNewMoon = JD - newMoonJD;
            const lunarCycleLength = 29.53058867; // Synodic month
            let moonAge = daysSinceNewMoon % lunarCycleLength;
            if (moonAge < 0) moonAge += lunarCycleLength; // Ensure positive

            // Map moon age to phase icon
            if (moonAge < 1.84566) return '🌑 New Moon';
            if (moonAge < 5.53699) return '🌒 Waxing Crescent';
            if (moonAge < 9.22831) return '🌓 First Quarter';
            if (moonAge < 12.91963) return '🌔 Waxing Gibbous';
            if (moonAge < 16.61096) return '🌕 Full Moon';
            if (moonAge < 20.30228) return '🌖 Waning Gibbous';
            if (moonAge < 23.99361) return '🌗 Last Quarter';
            if (moonAge < 27.68493) return '🌘 Waning Crescent';
            return '🌑 New Moon';
        }


        function renderCalendar() {
            calendarDaysContainer.innerHTML = ''; // Clear previous days
            currentMonthYearDisplay.textContent = currentCalendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDayOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const numDaysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday, etc.

            // Add leading empty days for the start of the week
            for (let i = 0; i < firstDayOfWeek; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day', 'other-month');
                calendarDaysContainer.appendChild(dayDiv);
            }

            // Add days of the current month
            for (let day = 1; day <= numDaysInMonth; day++) {
                const dayDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), day);
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day', 'current-month');
                dayDiv.innerHTML = `<div class="calendar-day-number">${day}</div>`;
                dayDiv.dataset.date = dayDate.toISOString().split('T')[0];
                
                // Get moon phase for the current day
                const moonPhase = getMoonPhaseIcon(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate());

                const moonPhaseEl = document.createElement('span');
                moonPhaseEl.classList.add('moon-phase-icon');
                // Extract just the emoji part for display in the calendar cell
                moonPhaseEl.textContent = moonPhase.split(' ')[0]; // Take only the emoji part
                dayDiv.appendChild(moonPhaseEl);


                // Filter events based on month and day (ignoring year)
                const eventsOnThisDay = SPACE_EVENTS.filter(event => {
                    const eventDate = new Date(event.date);
                    return eventDate.getMonth() === currentCalendarDate.getMonth() && // Month is 0-indexed
                           eventDate.getDate() === day;
                });

                if (eventsOnThisDay.length > 0) {
                    dayDiv.classList.add('has-event');
                    // Display the first event title as a preview
                    const eventTitleEl = document.createElement('div');
                    eventTitleEl.classList.add('calendar-event-title');
                    // Show title and historical year in preview
                    eventTitleEl.textContent = `${eventsOnThisDay[0].title} (${new Date(eventsOnThisDay[0].date).getFullYear()})`;
                    dayDiv.appendChild(eventTitleEl);

                    // Attach click listener to show modal for the first event, passing moon phase
                    dayDiv.addEventListener('click', () => showEventPopup(eventsOnThisDay[0], moonPhase));
                } else {
                    // Make non-event days also clickable for consistency (optional)
                    dayDiv.addEventListener('click', () => {
                        // For days without events, still show the modal with just the moon phase
                        const clickedDate = new Date(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate());
                        showEventPopup({
                            title: `No major events`,
                            date: clickedDate.toISOString().split('T')[0], // Format toYYYY-MM-DD
                            description: "No significant astronomical events are recorded for this date in history (or future plans)."
                        }, moonPhase);
                    });
                }

                calendarDaysContainer.appendChild(dayDiv);
            }
        }

        async function showEventPopup(event, moonPhase) {
            modalEventTitle.textContent = event.title;
            modalEventDate.textContent = new Date(event.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            modalMoonPhase.textContent = `Moon Phase: ${moonPhase}`;

            // Show loading indicator and clear previous description
            modalEventDescription.textContent = '';
            llmStoryLoading.classList.remove('hidden');

            eventModal.classList.add('show');

            try {
                const prompt = `Write a short, engaging story about the following astronomical event: ${event.title} on ${event.date}. Original description: ${event.description}. Make it captivating for a general audience interested in space. Keep it concise, around 100-150 words.`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyAI2QHPwvtSWbJtvbsCe06PFUzMEP4qPX0"
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    modalEventDescription.textContent = text;
                } else {
                    modalEventDescription.textContent = event.description; // Fallback to original
                }
            } catch (error) {
                console.error("Error fetching LLM story:", error);
                modalEventDescription.textContent = `Failed to load cosmic tale. Original event details: ${event.description}`; // Fallback with error
            } finally {
                llmStoryLoading.classList.add('hidden'); // Hide loading indicator
            }
        }

        function closeEventPopup() {
            eventModal.classList.remove('show');
        }

        // --- Event Listeners for Quiz ---
        document.querySelectorAll('.quiz-level-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                startQuiz(e.target.dataset.level);
            });
        });

        quizNextButton.addEventListener('click', nextQuestion);
        quizResetButton.addEventListener('click', resetQuiz);

        // --- Event Listeners for Calendar ---
        prevMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        });

        closeModalBtn.addEventListener('click', closeEventPopup);
        eventModal.addEventListener('click', (e) => {
            // Close modal if clicked on the overlay, not the content itself
            if (e.target === eventModal) {
                closeEventPopup();
            }
        });

        // --- Event Listeners for Solar System Controls ---
        const toggleOrbitsCheckbox = document.getElementById('toggleOrbits');
        const toggleMeteorsCheckbox = document.getElementById('toggleMeteors');
        const zoomSensitivitySlider = document.getElementById('zoomSensitivity');


        // Event listeners are added inside window.onload to ensure elements exist
        window.onload = function () {
            // Initial call to show the correct section based on URL hash or default
            const initialHash = window.location.hash.substring(1);
            if (initialHash) {
                showSection(initialHash);
            } else {
                showSection('intro-section'); // Default to 'intro-section'
            }

            // Initialize the calendar (it should render regardless of which section is visible)
            renderCalendar();

            // Add event listeners for solar system controls after elements are available
            if (toggleOrbitsCheckbox) {
                toggleOrbitsCheckbox.addEventListener('change', (event) => {
                    orbitLines.forEach(orbit => {
                        orbit.visible = event.target.checked;
                    });
                });
            }
            if (toggleMeteorsCheckbox) {
                toggleMeteorsCheckbox.addEventListener('change', (event) => {
                    meteors.forEach(meteor => {
                        meteor.visible = event.target.checked;
                    });
                });
            }
            if (zoomSensitivitySlider) {
                zoomSensitivitySlider.addEventListener('input', (event) => {
                    solarSystemZoomSensitivity = parseFloat(event.target.value);
                });
            }
        };
    </script>
</body>
</html>
